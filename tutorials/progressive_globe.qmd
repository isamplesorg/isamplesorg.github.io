---
title: "Progressive Globe: Instant H3 → Detail on Demand"
categories: [parquet, spatial, h3, performance, isamples]
---

Explore **6.7 million material samples** from iSamples — the globe loads instantly with H3 hexagonal aggregates, then refines as you zoom.

::: {.callout-note collapse="true"}
## How It Works

1. **Instant** (<1s): Pre-aggregated H3 res4 summary (580 KB) → 38K colored circles
2. **Zoom in**: Automatically switches to res6 (112K) then res8 (176K) clusters
3. **Click**: Shows cluster info and queries nearby samples from the full dataset

Circle size = log(sample count). Color = dominant data source.
:::

<script src="https://cesium.com/downloads/cesiumjs/releases/1.127/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.127/Build/Cesium/Widgets/widgets.css" rel="stylesheet"></link>
<style>
    div.cesium-topleft {
        display: block;
        position: absolute;
        background: #00000099;
        color: white;
        height: auto;
        z-index: 999;
    }
    .globe-layout {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 12px;
        margin-bottom: 16px;
    }
    @media (max-width: 900px) {
        .globe-layout { grid-template-columns: 1fr; }
    }
    #cesiumContainer {
        width: 100%;
        min-height: 500px;
        aspect-ratio: 4/3;
    }
    .side-panel {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 700px;
        overflow-y: auto;
    }
    .panel-section {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 12px;
        font-size: 13px;
    }
    .panel-section h4 { margin: 0 0 8px 0; font-size: 14px; }
    .stats-compact {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
    }
    .stat-box {
        background: #1a1a2e;
        color: white;
        padding: 8px 10px;
        border-radius: 4px;
        text-align: center;
    }
    .stat-box .val { font-weight: bold; font-size: 16px; font-family: monospace; display: block; }
    .stat-box .lbl { color: #aaa; font-size: 11px; }
    .legend { display: flex; gap: 10px; flex-wrap: wrap; font-size: 12px; }
    .legend-item { display: flex; align-items: center; gap: 3px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .source-badge { color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; white-space: nowrap; }
    .cluster-card { border-left: 4px solid #ccc; padding: 10px 12px; background: white; border-radius: 0 6px 6px 0; }
    .sample-row { padding: 6px 0; border-bottom: 1px solid #eee; line-height: 1.4; }
    .sample-row:last-child { border-bottom: none; }
    .sample-label { font-weight: 600; font-size: 13px; }
    .sample-desc { font-size: 12px; color: #555; margin-top: 2px; }
    .phase-msg { padding: 6px 10px; border-radius: 4px; font-size: 12px; transition: all 0.3s ease; }
    #clusterSection .empty-state { color: #999; text-align: center; padding: 20px; }
</style>

<!-- Static layout: globe + side panel. Updated via DOM, not OJS reactivity. -->
<div class="globe-layout">
<div id="cesiumContainer"></div>
<div class="side-panel">
<div class="panel-section">
<div class="stats-compact">
<div class="stat-box"><span id="sPhase" class="val">Loading...</span><span class="lbl">Resolution</span></div>
<div class="stat-box"><span id="sPoints" class="val">0</span><span class="lbl">Clusters</span></div>
<div class="stat-box"><span id="sSamples" class="val">0</span><span class="lbl">Samples</span></div>
<div class="stat-box"><span id="sTime" class="val">-</span><span class="lbl">Load Time</span></div>
</div>
<div style="margin-top: 8px;">
<div class="legend">
<span class="legend-item"><span class="legend-dot" style="background:#3366CC"></span> SESAR</span>
<span class="legend-item"><span class="legend-dot" style="background:#DC3912"></span> OpenContext</span>
<span class="legend-item"><span class="legend-dot" style="background:#109618"></span> GEOME</span>
<span class="legend-item"><span class="legend-dot" style="background:#FF9900"></span> Smithsonian</span>
</div>
</div>
<div id="phaseMsg" class="phase-msg" style="margin-top: 8px; background: #e3f2fd; color: #1565c0;">
Loading H3 global overview...
</div>
</div>
<div id="clusterSection" class="panel-section">
<div class="empty-state">Click a cluster on the globe</div>
</div>
<div id="samplesSection" class="panel-section" style="flex: 1; overflow-y: auto;"></div>
</div>
</div>

```{ojs}
//| output: false
Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwNzk3NjkyMy1iNGI1LTRkN2UtODRiMy04OTYwYWE0N2M3ZTkiLCJpZCI6Njk1MTcsImlhdCI6MTYzMzU0MTQ3N30.e70dpNzOCDRLDGxRguQCC-tRzGzA-23Xgno5lNgCeB4';
```

```{ojs}
//| echo: false
//| output: false

// === Constants ===
R2_BASE = "https://pub-a18234d962364c22a50c787b7ca09fa5.r2.dev"
h3_res4_url = `${R2_BASE}/isamples_202601_h3_summary_res4.parquet`
h3_res6_url = `${R2_BASE}/isamples_202601_h3_summary_res6.parquet`
h3_res8_url = `${R2_BASE}/isamples_202601_h3_summary_res8.parquet`
wide_url = `${R2_BASE}/isamples_202601_wide.parquet`

SOURCE_COLORS = ({
    SESAR: '#3366CC', OPENCONTEXT: '#DC3912',
    GEOME: '#109618', SMITHSONIAN: '#FF9900'
})
SOURCE_NAMES = ({
    SESAR: 'SESAR', OPENCONTEXT: 'OpenContext',
    GEOME: 'GEOME', SMITHSONIAN: 'Smithsonian'
})

// === Helper: update stats via DOM (no reactivity) ===
function updateStats(phase, points, samples, time) {
    const s = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
    s('sPhase', phase);
    s('sPoints', points.toLocaleString());
    s('sSamples', samples.toLocaleString());
    s('sTime', time);
}

function updatePhaseMsg(text, type) {
    const m = document.getElementById('phaseMsg');
    if (!m) return;
    m.textContent = text;
    if (type === 'loading') { m.style.background = '#e3f2fd'; m.style.color = '#1565c0'; }
    else { m.style.background = '#e8f5e9'; m.style.color = '#2e7d32'; }
}

function updateClusterCard(info) {
    const el = document.getElementById('clusterSection');
    if (!el) return;
    if (!info) {
        el.innerHTML = '<div class="empty-state">Click a cluster on the globe</div>';
        return;
    }
    const color = SOURCE_COLORS[info.source] || '#666';
    const name = SOURCE_NAMES[info.source] || info.source;
    el.innerHTML = `<h4>Selected Cluster</h4>
        <div class="cluster-card" style="border-left-color: ${color}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                <span class="source-badge" style="background: ${color}">${name}</span>
                <span style="font-size: 11px; color: #999;">H3 res${info.resolution}</span>
            </div>
            <div style="font-size: 22px; font-weight: bold; margin-bottom: 4px;">
                ${info.count.toLocaleString()} <span style="font-size: 13px; font-weight: normal; color: #666;">samples</span>
            </div>
            <div style="font-size: 12px; color: #666;">
                ${info.lat.toFixed(4)}, ${info.lng.toFixed(4)}
            </div>
        </div>`;
}

function updateSamples(samples) {
    const el = document.getElementById('samplesSection');
    if (!el) return;
    if (!samples || samples.length === 0) {
        el.innerHTML = '';
        return;
    }
    let h = `<h4>Nearby Samples (${samples.length})</h4>`;
    for (const s of samples) {
        const color = SOURCE_COLORS[s.source] || '#666';
        const name = SOURCE_NAMES[s.source] || s.source;
        const desc = s.description
            ? (s.description.length > 100 ? s.description.slice(0, 100) + '...' : s.description)
            : '';
        h += `<div class="sample-row">
            <div style="display: flex; align-items: center; gap: 6px;">
                <span class="sample-label">${s.label || s.pid}</span>
                <span class="source-badge" style="background: ${color}; font-size: 10px;">${name}</span>
            </div>
            ${desc ? `<div class="sample-desc">${desc}</div>` : ''}
        </div>`;
    }
    el.innerHTML = h;
}
```

```{ojs}
//| echo: false
//| output: false

// === DuckDB ===
db = {
    const instance = await DuckDBClient.of();
    return instance;
}
```

```{ojs}
//| echo: false
//| output: false

// === Cesium Viewer (created once, never re-created) ===
viewer = {
    const v = new Cesium.Viewer("cesiumContainer", {
        timeline: false,
        animation: false,
        baseLayerPicker: false,
        fullscreenElement: "cesiumContainer",
        terrain: Cesium.Terrain.fromWorldTerrain()
    });

    const globalRect = Cesium.Rectangle.fromDegrees(-180, -60, 180, 80);
    Cesium.Camera.DEFAULT_VIEW_RECTANGLE = globalRect;
    Cesium.Camera.DEFAULT_VIEW_FACTOR = 0.5;
    const once = () => {
        v.camera.setView({ destination: globalRect });
        v.scene.postRender.removeEventListener(once);
    };
    v.scene.postRender.addEventListener(once);

    v.h3Points = new Cesium.PointPrimitiveCollection();
    v.scene.primitives.add(v.h3Points);

    // Hover tooltip
    v.pointLabel = v.entities.add({
        label: {
            show: false, showBackground: true, font: "13px monospace",
            horizontalOrigin: Cesium.HorizontalOrigin.LEFT,
            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
            pixelOffset: new Cesium.Cartesian2(15, 0),
            disableDepthTestDistance: Number.POSITIVE_INFINITY, text: "",
        }
    });

    new Cesium.ScreenSpaceEventHandler(v.scene.canvas).setInputAction((movement) => {
        const picked = v.scene.pick(movement.endPosition);
        if (Cesium.defined(picked) && picked.primitive && picked.id) {
            v.pointLabel.position = picked.primitive.position;
            v.pointLabel.label.show = true;
            const meta = picked.id;
            v.pointLabel.label.text = (typeof meta === 'object' && meta.count)
                ? `${meta.source}: ${meta.count.toLocaleString()} samples`
                : String(meta);
        } else {
            v.pointLabel.label.show = false;
        }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

    // Click: update side panel via DOM (no OJS mutable → no reactivity cascade)
    new Cesium.ScreenSpaceEventHandler(v.scene.canvas).setInputAction(async (e) => {
        const picked = v.scene.pick(e.position);
        if (Cesium.defined(picked) && picked.primitive && picked.id) {
            const meta = picked.id;
            if (typeof meta === 'object' && meta.count) {
                // Update cluster card immediately
                updateClusterCard(meta);

                // Show loading state for samples
                const sampEl = document.getElementById('samplesSection');
                if (sampEl) sampEl.innerHTML = '<div style="text-align: center; color: #999; padding: 12px;">Loading nearby samples...</div>';

                // Query nearby samples from full dataset
                const delta = meta.resolution === 4 ? 2.0 : meta.resolution === 6 ? 0.5 : 0.1;
                try {
                    const samples = await db.query(`
                        SELECT pid, label, n as source, latitude, longitude, description
                        FROM read_parquet('${wide_url}')
                        WHERE otype = 'MaterialSampleRecord'
                          AND latitude BETWEEN ${meta.lat - delta} AND ${meta.lat + delta}
                          AND longitude BETWEEN ${meta.lng - delta} AND ${meta.lng + delta}
                        LIMIT 30
                    `);
                    updateSamples(samples);
                } catch(err) {
                    console.error("Sample query failed:", err);
                    if (sampEl) sampEl.innerHTML = '<div style="color: #c62828; padding: 12px;">Query failed — try again.</div>';
                }
            }
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    return v;
}
```

```{ojs}
//| echo: false
//| output: false

// === PHASE 1: Load H3 res4 globally (instant) ===
phase1 = {
    performance.mark('p1-start');

    const data = await db.query(`
        SELECT h3_cell, sample_count, center_lat, center_lng,
               dominant_source, source_count
        FROM read_parquet('${h3_res4_url}')
        ORDER BY sample_count DESC
    `);

    const scalar = new Cesium.NearFarScalar(1.5e2, 1.5, 8.0e6, 0.5);
    let totalSamples = 0;

    for (const row of data) {
        const count = row.sample_count;
        totalSamples += count;
        const size = Math.min(3 + Math.log10(count) * 4, 20);
        viewer.h3Points.add({
            id: { count, source: row.dominant_source, lat: row.center_lat, lng: row.center_lng, resolution: 4 },
            position: Cesium.Cartesian3.fromDegrees(row.center_lng, row.center_lat, 0),
            pixelSize: size,
            color: Cesium.Color.fromCssColorString(SOURCE_COLORS[row.dominant_source] || '#666').withAlpha(0.8),
            scaleByDistance: scalar,
        });
    }

    performance.mark('p1-end');
    performance.measure('p1', 'p1-start', 'p1-end');
    const elapsed = performance.getEntriesByName('p1')[0].duration;

    updateStats('H3 Res4', data.length, totalSamples, `${(elapsed/1000).toFixed(1)}s`);
    updatePhaseMsg(`${data.length.toLocaleString()} clusters, ${totalSamples.toLocaleString()} samples. Zoom in for finer detail.`, 'done');
    console.log(`Phase 1: ${data.length} clusters in ${elapsed.toFixed(0)}ms`);

    return { count: data.length, samples: totalSamples };
}
```

```{ojs}
//| echo: false
//| output: false

// === Zoom watcher: switch H3 resolution globally ===
zoomWatcher = {
    if (!phase1) return;

    let currentRes = 4;
    let loading = false;

    const loadRes = async (res, url) => {
        if (loading) return;
        loading = true;
        updatePhaseMsg(`Loading H3 res${res}...`, 'loading');

        performance.mark(`r${res}-s`);
        const data = await db.query(`
            SELECT h3_cell, sample_count, center_lat, center_lng,
                   dominant_source, source_count
            FROM read_parquet('${url}')
            ORDER BY sample_count DESC
        `);

        viewer.h3Points.removeAll();
        const scalar = new Cesium.NearFarScalar(1.5e2, 1.5, 8.0e6, 0.3);
        let total = 0;

        for (const row of data) {
            total += row.sample_count;
            const size = Math.min(3 + Math.log10(row.sample_count) * 3.5, 18);
            viewer.h3Points.add({
                id: { count: row.sample_count, source: row.dominant_source, lat: row.center_lat, lng: row.center_lng, resolution: res },
                position: Cesium.Cartesian3.fromDegrees(row.center_lng, row.center_lat, 0),
                pixelSize: size,
                color: Cesium.Color.fromCssColorString(SOURCE_COLORS[row.dominant_source] || '#666').withAlpha(0.85),
                scaleByDistance: scalar,
            });
        }

        performance.mark(`r${res}-e`);
        performance.measure(`r${res}`, `r${res}-s`, `r${res}-e`);
        const elapsed = performance.getEntriesByName(`r${res}`)[0].duration;

        updateStats(`H3 Res${res}`, data.length, total, `${(elapsed/1000).toFixed(1)}s`);
        updatePhaseMsg(`${data.length.toLocaleString()} clusters, ${total.toLocaleString()} samples. ${res < 8 ? 'Zoom in for finer detail.' : 'Maximum detail.'}`, 'done');

        currentRes = res;
        loading = false;
        console.log(`Res${res}: ${data.length} clusters in ${elapsed.toFixed(0)}ms`);
    };

    let timer = null;
    viewer.camera.changed.addEventListener(() => {
        if (timer) clearTimeout(timer);
        timer = setTimeout(async () => {
            const h = viewer.camera.positionCartographic.height;
            const target = h > 3000000 ? 4 : h > 300000 ? 6 : 8;
            if (target !== currentRes) {
                await loadRes(target, { 4: h3_res4_url, 6: h3_res6_url, 8: h3_res8_url }[target]);
            }
        }, 800);
    });
    viewer.camera.percentageChanged = 0.1;

    return "active";
}
```

## How This Demo Works

Pre-aggregated H3 hexagonal indices achieve near-instant globe rendering:

| Phase | Data | Size | Points |
|-------|------|------|--------|
| **Instant** | H3 res4 | 580 KB | 38K clusters (continental) |
| **Zoom in** | H3 res6 | 1.6 MB | 112K clusters (city) |
| **Zoom more** | H3 res8 | 2.5 MB | 176K clusters (neighborhood) |
| **Click** | Full dataset | ~280 MB (range req.) | Individual samples |

**vs. original**: Loading 6.7M coordinates from 280 MB takes 5-10s. This shows data in <1s.

## See Also

- [Cesium Globe (All Points)](/tutorials/parquet_cesium_isamples_wide.html) — Full point-level rendering
- [Interactive Explorer](/tutorials/isamples_explorer.html) — Search and filter with facets
- [Deep-Dive Analysis](/tutorials/zenodo_isamples_analysis.html) — DuckDB-WASM SQL tutorial
