<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="iSamples Team">
<meta name="dcterms.date" content="2025-09-05">

<title>Efficient Analysis of Large iSamples Dataset from Zenodo ‚Äì iSamples</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/isamplesfavicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-a7526be2a1d88bf1207dbb3f5eb48fc5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="module" src="../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../tutorials/index.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../tutorials/zenodo_isamples_analysis.html">Deep-Dive Analysis</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../assets/isampleslogopetal.png" alt="" class="sidebar-logo light-content py-0 d-lg-inline d-none">
      <img src="../assets/isampleslogopetal.png" alt="" class="sidebar-logo dark-content py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/isamplesorg" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://isamples.slack.com/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-slack"></i></a>
    <a href="https://twitter.com/isamplesorg" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Goals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../people.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">People</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Information Architecture</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../design/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../design/requirements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Requirements</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://isamplesorg.github.io/metadata/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metadata Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">iSamples Vocabularies</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Outputs</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://youtu.be/eRUw5NMksFo?t=105" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2020 SPNHC conference talk (video)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../assets/2022-11_iSamplesMetadata.pdf" class="sidebar-item-text sidebar-link">
 <span class="menu-text">iSamples metadata model talk (slides, PDF)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../pubs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Publications</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://zenodo.org/communities/isamples" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Zenodo community</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://github.com/isamplesorg/" class="sidebar-item-text sidebar-link"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text">Github repositories</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/isamples_explorer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interactive Explorer</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/zenodo_isamples_analysis.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Deep-Dive Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/parquet_cesium_isamples_wide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3D Globe Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/progressive_globe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Progressive Globe (H3 + Samples)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/narrow_vs_wide_performance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Technical: Narrow vs Wide</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#key-technologies" id="toc-key-technologies" class="nav-link" data-scroll-target="#key-technologies"><span class="header-section-number">1.1</span> Key Technologies</a></li>
  <li><a href="#dataset-information" id="toc-dataset-information" class="nav-link" data-scroll-target="#dataset-information"><span class="header-section-number">1.2</span> Dataset Information</a></li>
  </ul></li>
  <li><a href="#setup-and-database-connection" id="toc-setup-and-database-connection" class="nav-link" data-scroll-target="#setup-and-database-connection"><span class="header-section-number">2</span> Setup and Database Connection</a></li>
  <li><a href="#basic-data-exploration" id="toc-basic-data-exploration" class="nav-link" data-scroll-target="#basic-data-exploration"><span class="header-section-number">3</span> Basic Data Exploration</a></li>
  <li><a href="#source-collection-analysis" id="toc-source-collection-analysis" class="nav-link" data-scroll-target="#source-collection-analysis"><span class="header-section-number">4</span> Source Collection Analysis</a></li>
  <li><a href="#geographic-distribution-analysis" id="toc-geographic-distribution-analysis" class="nav-link" data-scroll-target="#geographic-distribution-analysis"><span class="header-section-number">5</span> Geographic Distribution Analysis</a></li>
  <li><a href="#interactive-regional-explorer" id="toc-interactive-regional-explorer" class="nav-link" data-scroll-target="#interactive-regional-explorer"><span class="header-section-number">6</span> Interactive Regional Explorer</a></li>
  <li><a href="#efficient-sampling-for-visualization" id="toc-efficient-sampling-for-visualization" class="nav-link" data-scroll-target="#efficient-sampling-for-visualization"><span class="header-section-number">7</span> Efficient Sampling for Visualization</a></li>
  <li><a href="#interactive-world-map" id="toc-interactive-world-map" class="nav-link" data-scroll-target="#interactive-world-map"><span class="header-section-number">8</span> Interactive World Map</a></li>
  <li><a href="#material-category-analysis" id="toc-material-category-analysis" class="nav-link" data-scroll-target="#material-category-analysis"><span class="header-section-number">9</span> Material Category Analysis</a></li>
  <li><a href="#performance-summary" id="toc-performance-summary" class="nav-link" data-scroll-target="#performance-summary"><span class="header-section-number">10</span> Performance Summary</a></li>
  <li><a href="#additional-resources" id="toc-additional-resources" class="nav-link" data-scroll-target="#additional-resources"><span class="header-section-number">11</span> Additional Resources</a></li>
  <li><a href="#viewport-map-with-graceful-degradation-deck.gl-duckdb-wasm" id="toc-viewport-map-with-graceful-degradation-deck.gl-duckdb-wasm" class="nav-link" data-scroll-target="#viewport-map-with-graceful-degradation-deck.gl-duckdb-wasm"><span class="header-section-number">12</span> üîç Viewport Map with Graceful Degradation (deck.gl ‚ÜîÔ∏é DuckDB-WASM)</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/isamplesorg/isamplesorg.github.io/edit/main/tutorials/zenodo_isamples_analysis.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/isamplesorg/isamplesorg.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../tutorials/index.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../tutorials/zenodo_isamples_analysis.html">Deep-Dive Analysis</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Efficient Analysis of Large iSamples Dataset from Zenodo</h1>
<p class="subtitle lead">Using DuckDB-WASM and Observable JS for Browser-Based Data Analysis</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>iSamples Team </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 5, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This tutorial demonstrates how to efficiently analyze large geospatial datasets directly in your browser without downloading entire files. We‚Äôll use DuckDB-WASM and Observable JS to perform fast, memory-efficient analysis and create interactive visualizations.</p>
<p><strong>Note</strong>: This tutorial attempts to connect to the live iSamples dataset (~300MB, 6+ million records). If CORS restrictions prevent access to the remote file, it automatically falls back to a representative demo dataset that demonstrates the same analytical techniques.</p>
<section id="key-technologies" class="level2" data-number="1.1">
<h2 data-number="1.1" data-anchor-id="key-technologies"><span class="header-section-number">1.1</span> Key Technologies</h2>
<ul>
<li><strong>DuckDB-WASM</strong>: In-browser analytical database with HTTP range request support</li>
<li><strong>Observable Plot</strong>: Grammar of graphics for interactive visualizations</li>
<li><strong>Observable Inputs</strong>: Interactive controls for data exploration</li>
<li><strong>CORS Handling</strong>: Automatic fallback for cross-origin restrictions</li>
</ul>
</section>
<section id="dataset-information" class="level2" data-number="1.2">
<h2 data-number="1.2" data-anchor-id="dataset-information"><span class="header-section-number">1.2</span> Dataset Information</h2>
<p><strong>Primary dataset</strong> (Jan 2026, H3-indexed): - <strong>URL</strong>: <code>https://pub-a18234d962364c22a50c787b7ca09fa5.r2.dev/isamples_202601_wide_h3.parquet</code> - <strong>Size</strong>: ~292 MB wide format with H3 indices, 6.7M MaterialSampleRecords (20M total rows) - <strong>H3 columns</strong>: Pre-computed <code>h3_res4</code>, <code>h3_res6</code>, <code>h3_res8</code> (BIGINT) for spatial grouping - <strong>Sources</strong>: SESAR (4.6M), OpenContext (1M), GEOME (605K), Smithsonian (322K) - <strong>Hosting</strong>: Cloudflare R2 with HTTP range request support</p>
<p><strong>Facet summaries</strong> (2KB, instant): - <strong>URL</strong>: <code>https://pub-a18234d962364c22a50c787b7ca09fa5.r2.dev/isamples_202601_facet_summaries.parquet</code> - <strong>Schema</strong>: <code>facet_type</code>, <code>facet_value</code>, <code>scheme</code>, <code>count</code></p>
<p><strong>Note</strong>: <em>Data was originally archived on Zenodo and is now served from Cloudflare R2 for better performance and reliability.</em></p>
<p><strong>Fallback dataset</strong> (if remote data fails): - <strong>Type</strong>: Generated demo data with realistic structure - <strong>Size</strong>: 10K records with same schema and representative geographic distribution - <strong>Purpose</strong>: Demonstrates all analytical techniques with faster loading</p>
</section>
</section>
<section id="setup-and-database-connection" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Setup and Database Connection</h1>
<div id="test-reactivity" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" data-startfrom="54" data-source-offset="-47"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 53;"><span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>viewof test_input <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span> {</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">"Test Input:"</span><span class="op">,</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="dt">step</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="dv">42</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co">// In Observable, the input itself IS the value when referenced reactively</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>test_value <span class="op">=</span> test_input</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>test_output <span class="op">=</span> test_value <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="fu">md</span><span class="vs">`</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="vs">## üß™ Reactivity Test</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="vs">**Raw input object**: </span><span class="sc">${</span><span class="kw">typeof</span> test_input<span class="sc">}</span><span class="vs"> (Constructor: </span><span class="sc">${</span>test_input<span class="op">?.</span><span class="at">constructor</span><span class="op">?.</span><span class="at">name</span><span class="sc">}</span><span class="vs">)  </span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="vs">**Extracted value**: </span><span class="sc">${</span>test_value<span class="sc">}</span><span class="vs">  </span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="vs">**Output (2x input)**: </span><span class="sc">${</span>test_output<span class="sc">}</span><span class="vs">  </span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="vs">**Value type**: </span><span class="sc">${</span><span class="kw">typeof</span> test_value<span class="sc">}</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="vs">This should update in real-time as you move the slider.</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="test-reactivity-1">
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="test-reactivity-2">
<div id="ojs-cell-1-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="test-reactivity-3">
<div id="ojs-cell-1-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="test-reactivity-4">
<div id="ojs-cell-1-4" data-nodetype="expression">

</div>
</div>
</div>
</div>
<div id="setup" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" data-startfrom="82" data-source-offset="-50"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 81;"><span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>duckdb <span class="op">=</span> <span class="im">import</span>(<span class="st">"https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm"</span>)</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>Plot <span class="op">=</span> <span class="im">import</span>(<span class="st">"https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm"</span>)</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>Inputs <span class="op">=</span> <span class="im">import</span>(<span class="st">"https://cdn.jsdelivr.net/npm/@observablehq/inputs@0.10/+esm"</span>)</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@7"</span>)</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>topojson <span class="op">=</span> <span class="pp">require</span>(<span class="st">"topojson-client@3"</span>)</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a><span class="co">// Dataset URLs - try multiple options for CORS compatibility</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a><span class="co">// Primary: Cloudflare R2 (Jan 2026 wide format with H3 indices)</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>parquet_urls <span class="op">=</span> [</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://pub-a18234d962364c22a50c787b7ca09fa5.r2.dev/isamples_202601_wide_h3.parquet'</span><span class="op">,</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fallback: original wide format without H3</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://pub-a18234d962364c22a50c787b7ca09fa5.r2.dev/isamples_202601_wide.parquet'</span><span class="op">,</span></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fallback: older versions</span></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://labs.dataunbound.com/docs/2025/07/isamples_export_2025_04_21_16_23_46_geo.parquet'</span><span class="op">,</span></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://zenodo.org/api/records/15278211/files/isamples_export_2025_04_21_16_23_46_geo.parquet/content'</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a><span class="co">// Pre-computed facet summaries (2KB - loads instantly)</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>facet_summaries_url <span class="op">=</span> <span class="st">'https://pub-a18234d962364c22a50c787b7ca09fa5.r2.dev/isamples_202601_facet_summaries.parquet'</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a><span class="co">// Test CORS and find working URL - with rate limiting protection</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>working_parquet_url <span class="op">=</span> {</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if we've recently failed (to avoid repeated rate limiting)</span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> lastFailTime <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">'zenodo_last_fail'</span>)<span class="op">;</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> now <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lastFailTime <span class="op">&amp;&amp;</span> (now <span class="op">-</span> <span class="pp">parseInt</span>(lastFailTime)) <span class="op">&lt;</span> <span class="dv">300000</span>) { <span class="co">// 5 minutes</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'‚è≥ Recently hit rate limit, using demo data'</span>)<span class="op">;</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> url <span class="kw">of</span> parquet_urls) {</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Testing URL: </span><span class="sc">${</span>url<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Test with a small HEAD request first</span></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(url<span class="op">,</span> { </span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">'HEAD'</span><span class="op">,</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>        <span class="dt">mode</span><span class="op">:</span> <span class="st">'cors'</span></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`‚úÖ Working URL found: </span><span class="sc">${</span>url<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clear any previous failure time</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>        localStorage<span class="op">.</span><span class="fu">removeItem</span>(<span class="st">'zenodo_last_fail'</span>)<span class="op">;</span></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> url<span class="op">;</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (response<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">429</span>) {</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`‚ö†Ô∏è Rate limited: </span><span class="sc">${</span>url<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>        localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">'zenodo_last_fail'</span><span class="op">,</span> now<span class="op">.</span><span class="fu">toString</span>())<span class="op">;</span></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`‚ùå Failed URL: </span><span class="sc">${</span>url<span class="sc">}</span><span class="vs">, Error: </span><span class="sc">${</span>error<span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (error<span class="op">.</span><span class="at">message</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">'429'</span>) <span class="op">||</span> error<span class="op">.</span><span class="at">message</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">'TOO MANY REQUESTS'</span>)) {</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>        localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">'zenodo_last_fail'</span><span class="op">,</span> now<span class="op">.</span><span class="fu">toString</span>())<span class="op">;</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>      <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If no URL works, we'll use a fallback approach</span></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"‚ö†Ô∏è No direct URL worked, will use demo data"</span>)<span class="op">;</span></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a><span class="co">// Create DuckDB instance and connect to remote parquet</span></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> {</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use DuckDB ES modules from jsdelivr</span></span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> JSDELIVR_BUNDLES <span class="op">=</span> duckdb<span class="op">.</span><span class="fu">getJsDelivrBundles</span>()<span class="op">;</span></span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Select bundle for the platform</span></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> bundle <span class="op">=</span> <span class="cf">await</span> duckdb<span class="op">.</span><span class="fu">selectBundle</span>(JSDELIVR_BUNDLES)<span class="op">;</span></span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create worker</span></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> worker_url <span class="op">=</span> URL<span class="op">.</span><span class="fu">createObjectURL</span>(</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Blob</span>([<span class="vs">`importScripts("</span><span class="sc">${</span>bundle<span class="op">.</span><span class="at">mainWorker</span><span class="sc">}</span><span class="vs">");`</span>]<span class="op">,</span> {<span class="dt">type</span><span class="op">:</span> <span class="st">'text/javascript'</span>})</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> worker <span class="op">=</span> <span class="kw">new</span> <span class="bu">Worker</span>(worker_url)<span class="op">;</span></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> logger <span class="op">=</span> <span class="kw">new</span> duckdb<span class="op">.</span><span class="fu">ConsoleLogger</span>(duckdb<span class="op">.</span><span class="at">LogLevel</span><span class="op">.</span><span class="at">WARNING</span>)<span class="op">;</span></span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> db_instance <span class="op">=</span> <span class="kw">new</span> duckdb<span class="op">.</span><span class="fu">AsyncDuckDB</span>(logger<span class="op">,</span> worker)<span class="op">;</span></span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize the database</span></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> db_instance<span class="op">.</span><span class="fu">instantiate</span>(bundle<span class="op">.</span><span class="at">mainModule</span><span class="op">,</span> bundle<span class="op">.</span><span class="at">pthreadWorker</span>)<span class="op">;</span></span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Connect to database</span></span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> conn <span class="op">=</span> <span class="cf">await</span> db_instance<span class="op">.</span><span class="fu">connect</span>()<span class="op">;</span></span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (working_parquet_url) {</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Try to create view of the remote parquet file</span></span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> conn<span class="op">.</span><span class="fu">query</span>(<span class="vs">`CREATE VIEW isamples_data AS SELECT * FROM read_parquet('</span><span class="sc">${</span>working_parquet_url<span class="sc">}</span><span class="vs">')`</span>)<span class="op">;</span></span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Test the connection with a simple query to catch rate limiting</span></span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> conn<span class="op">.</span><span class="fu">query</span>(<span class="vs">`SELECT count(*) FROM isamples_data LIMIT 1`</span>)<span class="op">;</span></span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"‚úÖ Successfully connected to remote Parquet file"</span>)<span class="op">;</span></span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"‚ùå Failed to read remote Parquet:"</span><span class="op">,</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Check if it's a rate limiting error</span></span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (error<span class="op">.</span><span class="at">message</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">'429'</span>) <span class="op">||</span> error<span class="op">.</span><span class="at">message</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">'TOO MANY REQUESTS'</span>)) {</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"‚è≥ Rate limited - storing failure time"</span>)<span class="op">;</span></span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>        localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">'zenodo_last_fail'</span><span class="op">,</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">.</span><span class="fu">toString</span>())<span class="op">;</span></span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Create demo data as fallback</span></span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="fu">createDemoData</span>(conn)<span class="op">;</span></span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create demo data as fallback</span></span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">createDemoData</span>(conn)<span class="op">;</span></span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> conn<span class="op">;</span></span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to create demo data when remote file is not accessible</span></span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>createDemoData <span class="op">=</span> <span class="kw">async</span> (conn) <span class="kw">=&gt;</span> {</span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"Creating demo dataset..."</span>)<span class="op">;</span></span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create a demo table with similar structure and realistic data</span></span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> conn<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a><span class="vs">    CREATE TABLE isamples_data AS </span></span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a><span class="vs">    SELECT </span></span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a><span class="vs">      'DEMO_' || i as sample_identifier,</span></span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a><span class="vs">      CASE </span></span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 4 = 0 THEN 'SESAR'</span></span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 4 = 1 THEN 'OPENCONTEXT' </span></span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 4 = 2 THEN 'GEOME'</span></span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a><span class="vs">        ELSE 'SMITHSONIAN'</span></span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a><span class="vs">      END as source_collection,</span></span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span></span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a><span class="vs">      -- Generate realistic coordinates</span></span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a><span class="vs">      CASE </span></span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 5 = 0 THEN -120 + (random() * 50)  -- North America</span></span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 5 = 1 THEN -10 + (random() * 40)   -- Europe  </span></span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 5 = 2 THEN 100 + (random() * 40)   -- Asia</span></span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 5 = 3 THEN 115 + (random() * 30)   -- Australia</span></span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a><span class="vs">        ELSE -180 + (random() * 360)  -- Other</span></span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a><span class="vs">      END as sample_location_longitude,</span></span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span></span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a><span class="vs">      CASE </span></span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 5 = 0 THEN 25 + (random() * 25)    -- North America</span></span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 5 = 1 THEN 35 + (random() * 35)    -- Europe</span></span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 5 = 2 THEN 20 + (random() * 30)    -- Asia  </span></span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 5 = 3 THEN -40 + (random() * 30)   -- Australia</span></span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a><span class="vs">        ELSE -90 + (random() * 180)   -- Other</span></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a><span class="vs">      END as sample_location_latitude,</span></span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span></span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a><span class="vs">      CASE </span></span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 8 = 0 THEN 'rock'</span></span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 8 = 1 THEN 'mineral'</span></span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 8 = 2 THEN 'sediment' </span></span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 8 = 3 THEN 'soil'</span></span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 8 = 4 THEN 'fossil'</span></span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 8 = 5 THEN 'meteorite'</span></span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a><span class="vs">        WHEN i % 8 = 6 THEN 'organic'</span></span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a><span class="vs">        ELSE 'other'</span></span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a><span class="vs">      END as has_material_category,</span></span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span></span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a><span class="vs">      'Demo sample ' || i as label</span></span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span></span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a><span class="vs">    FROM generate_series(1, 10000) t(i) -- Generate 10,000 demo records</span></span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span>)<span class="op">;</span></span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"‚úÖ Demo dataset created with 10,000 sample records"</span>)<span class="op">;</span></span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="setup-1">
<div id="ojs-cell-2-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="setup-2">
<div id="ojs-cell-2-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="setup-3">
<div id="ojs-cell-2-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="setup-4">
<div id="ojs-cell-2-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="setup-5">
<div id="ojs-cell-2-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="setup-6">
<div id="ojs-cell-2-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="setup-7">
<div id="ojs-cell-2-7" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="setup-8">
<div id="ojs-cell-2-8" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="setup-9">
<div id="ojs-cell-2-9" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="setup-10">
<div id="ojs-cell-2-10" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" data-startfrom="251" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 250;"><span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a><span class="fu">md</span><span class="vs">`</span></span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a><span class="vs">## Connection Status</span></span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a><span class="sc">${</span>working_parquet_url <span class="op">?</span></span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`‚úÖ **Connected to live data**: Using </span><span class="sc">${</span>working_parquet_url<span class="op">.</span><span class="fu">includes</span>(<span class="st">'r2.dev'</span>) <span class="op">?</span> <span class="st">'Cloudflare R2'</span> <span class="op">:</span> working_parquet_url<span class="op">.</span><span class="fu">includes</span>(<span class="st">'zenodo.org'</span>) <span class="op">?</span> <span class="st">'Zenodo'</span> <span class="op">:</span> <span class="st">'fallback'</span><span class="sc">}</span><span class="vs"> hosting</span></span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a><span class="vs">üìä **Dataset**: 6.7M MaterialSampleRecords from iSamples</span></span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a><span class="vs">üåê **Data source**: </span><span class="sc">${</span>working_parquet_url<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a>  <span class="op">:</span></span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a>  <span class="vs">`‚ö†Ô∏è **Using demo data**: Remote file not accessible due to CORS restrictions</span></span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a><span class="vs">üìä **Dataset**: 10K synthetic records with realistic structure</span></span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a><span class="vs">üí° **Note**: This demonstrates the same analysis patterns with representative data`</span></span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a><span class="sc">}</span></span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="connection-status" class="cell-output cell-output-display">
<div id="ojs-cell-3" data-nodetype="expression">

</div>
</div>
</div>
</section>
<section id="basic-data-exploration" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Basic Data Exploration</h1>
<p>Let‚Äôs start with fundamental queries to understand the dataset structure and size.</p>
<div id="basic-stats" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" data-startfrom="276" data-source-offset="-55"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 275;"><span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>total_count <span class="op">=</span> {</span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`SELECT count(*) as total FROM isamples_data`</span>)<span class="op">;</span></span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> rows <span class="op">=</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">;</span></span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Number</span>(rows[<span class="dv">0</span>]<span class="op">.</span><span class="at">total</span>)<span class="op">;</span> <span class="co">// Convert BigInt to Number</span></span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a><span class="co">// Count records with geographic coordinates</span></span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a>geo_count <span class="op">=</span> {</span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a><span class="vs">    SELECT count(*) as geo_total </span></span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a><span class="vs">    FROM isamples_data </span></span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a><span class="vs">    WHERE sample_location_latitude IS NOT NULL </span></span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a><span class="vs">    AND sample_location_longitude IS NOT NULL</span></span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span>)<span class="op">;</span></span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> rows <span class="op">=</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">;</span></span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Number</span>(rows[<span class="dv">0</span>]<span class="op">.</span><span class="at">geo_total</span>)<span class="op">;</span> <span class="co">// Convert BigInt to Number</span></span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate percentage with coordinates</span></span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a>geo_percentage <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>((geo_count <span class="op">/</span> total_count) <span class="op">*</span> <span class="dv">100</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="basic-stats-1">
<div id="ojs-cell-4-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="basic-stats-2">
<div id="ojs-cell-4-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="basic-stats-3">
<div id="ojs-cell-4-3" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" data-startfrom="299" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 298;"><span id="cb5-299"><a href="#cb5-299" aria-hidden="true" tabindex="-1"></a><span class="fu">md</span><span class="vs">`</span></span>
<span id="cb5-300"><a href="#cb5-300" aria-hidden="true" tabindex="-1"></a><span class="vs">## Dataset Overview</span></span>
<span id="cb5-301"><a href="#cb5-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-302"><a href="#cb5-302" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Total records**: </span><span class="sc">${</span>total_count<span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span></span>
<span id="cb5-303"><a href="#cb5-303" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Records with coordinates**: </span><span class="sc">${</span>geo_count<span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>geo_percentage<span class="sc">}</span><span class="vs">%)</span></span>
<span id="cb5-304"><a href="#cb5-304" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Data source**: </span><span class="sc">${</span>working_parquet_url <span class="op">?</span> <span class="st">'Remote Parquet file (~300 MB)'</span> <span class="op">:</span> <span class="st">'Demo dataset (synthetic)'</span><span class="sc">}</span></span>
<span id="cb5-305"><a href="#cb5-305" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Data transferred for these stats**: &lt; 1 KB (metadata only!)</span></span>
<span id="cb5-306"><a href="#cb5-306" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="display-basic-stats" class="cell-output cell-output-display">
<div id="ojs-cell-5" data-nodetype="expression">

</div>
</div>
</div>
</section>
<section id="source-collection-analysis" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Source Collection Analysis</h1>
<p>Analyze the distribution of samples across different source collections.</p>
<div id="source-analysis" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" data-startfrom="319" data-source-offset="-33"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 318;"><span id="cb6-319"><a href="#cb6-319" aria-hidden="true" tabindex="-1"></a>source_data <span class="op">=</span> {</span>
<span id="cb6-320"><a href="#cb6-320" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb6-321"><a href="#cb6-321" aria-hidden="true" tabindex="-1"></a><span class="vs">    SELECT </span></span>
<span id="cb6-322"><a href="#cb6-322" aria-hidden="true" tabindex="-1"></a><span class="vs">      source_collection, </span></span>
<span id="cb6-323"><a href="#cb6-323" aria-hidden="true" tabindex="-1"></a><span class="vs">      count(*) as sample_count,</span></span>
<span id="cb6-324"><a href="#cb6-324" aria-hidden="true" tabindex="-1"></a><span class="vs">      count(CASE WHEN sample_location_latitude IS NOT NULL </span></span>
<span id="cb6-325"><a href="#cb6-325" aria-hidden="true" tabindex="-1"></a><span class="vs">                  AND sample_location_longitude IS NOT NULL </span></span>
<span id="cb6-326"><a href="#cb6-326" aria-hidden="true" tabindex="-1"></a><span class="vs">                  THEN 1 END) as geo_count</span></span>
<span id="cb6-327"><a href="#cb6-327" aria-hidden="true" tabindex="-1"></a><span class="vs">    FROM isamples_data </span></span>
<span id="cb6-328"><a href="#cb6-328" aria-hidden="true" tabindex="-1"></a><span class="vs">    GROUP BY source_collection </span></span>
<span id="cb6-329"><a href="#cb6-329" aria-hidden="true" tabindex="-1"></a><span class="vs">    ORDER BY sample_count DESC</span></span>
<span id="cb6-330"><a href="#cb6-330" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span>)<span class="op">;</span></span>
<span id="cb6-331"><a href="#cb6-331" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Convert BigInt values to Numbers</span></span>
<span id="cb6-332"><a href="#cb6-332" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> processedData <span class="op">=</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> ({</span>
<span id="cb6-333"><a href="#cb6-333" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span>row<span class="op">,</span></span>
<span id="cb6-334"><a href="#cb6-334" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sample_count</span><span class="op">:</span> <span class="bu">Number</span>(row<span class="op">.</span><span class="at">sample_count</span>)<span class="op">,</span></span>
<span id="cb6-335"><a href="#cb6-335" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geo_count</span><span class="op">:</span> <span class="bu">Number</span>(row<span class="op">.</span><span class="at">geo_count</span>)</span>
<span id="cb6-336"><a href="#cb6-336" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb6-337"><a href="#cb6-337" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-338"><a href="#cb6-338" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> processedData<span class="op">;</span></span>
<span id="cb6-339"><a href="#cb6-339" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-340"><a href="#cb6-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-341"><a href="#cb6-341" aria-hidden="true" tabindex="-1"></a><span class="co">// Create interactive table showing source distribution</span></span>
<span id="cb6-342"><a href="#cb6-342" aria-hidden="true" tabindex="-1"></a>viewof source_table <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">table</span>(source_data<span class="op">,</span> {</span>
<span id="cb6-343"><a href="#cb6-343" aria-hidden="true" tabindex="-1"></a>  <span class="dt">columns</span><span class="op">:</span> [</span>
<span id="cb6-344"><a href="#cb6-344" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source_collection"</span><span class="op">,</span></span>
<span id="cb6-345"><a href="#cb6-345" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sample_count"</span><span class="op">,</span> </span>
<span id="cb6-346"><a href="#cb6-346" aria-hidden="true" tabindex="-1"></a>    <span class="st">"geo_count"</span></span>
<span id="cb6-347"><a href="#cb6-347" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb6-348"><a href="#cb6-348" aria-hidden="true" tabindex="-1"></a>  <span class="dt">header</span><span class="op">:</span> {</span>
<span id="cb6-349"><a href="#cb6-349" aria-hidden="true" tabindex="-1"></a>    <span class="dt">source_collection</span><span class="op">:</span> <span class="st">"Source Collection"</span><span class="op">,</span></span>
<span id="cb6-350"><a href="#cb6-350" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sample_count</span><span class="op">:</span> <span class="st">"Total Samples"</span><span class="op">,</span></span>
<span id="cb6-351"><a href="#cb6-351" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geo_count</span><span class="op">:</span> <span class="st">"Samples with Coordinates"</span></span>
<span id="cb6-352"><a href="#cb6-352" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb6-353"><a href="#cb6-353" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> {</span>
<span id="cb6-354"><a href="#cb6-354" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sample_count</span><span class="op">:</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">","</span>)<span class="op">,</span></span>
<span id="cb6-355"><a href="#cb6-355" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geo_count</span><span class="op">:</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">","</span>)</span>
<span id="cb6-356"><a href="#cb6-356" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-357"><a href="#cb6-357" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="source-analysis-1">
<div id="ojs-cell-6-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="source-analysis-2">
<div id="ojs-cell-6-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" data-startfrom="361" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 360;"><span id="cb7-361"><a href="#cb7-361" aria-hidden="true" tabindex="-1"></a><span class="co">// Create bar chart of source collections</span></span>
<span id="cb7-362"><a href="#cb7-362" aria-hidden="true" tabindex="-1"></a>source_chart <span class="op">=</span> {</span>
<span id="cb7-363"><a href="#cb7-363" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Validate that source_data is an array</span></span>
<span id="cb7-364"><a href="#cb7-364" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(source_data)) {</span>
<span id="cb7-365"><a href="#cb7-365" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Error: Source data is not available&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb7-366"><a href="#cb7-366" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-367"><a href="#cb7-367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-368"><a href="#cb7-368" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb7-369"><a href="#cb7-369" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">"Sample Distribution by Source Collection"</span><span class="op">,</span></span>
<span id="cb7-370"><a href="#cb7-370" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb7-371"><a href="#cb7-371" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Number of samples"</span><span class="op">,</span></span>
<span id="cb7-372"><a href="#cb7-372" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tickFormat</span><span class="op">:</span> <span class="st">"~s"</span></span>
<span id="cb7-373"><a href="#cb7-373" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb7-374"><a href="#cb7-374" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb7-375"><a href="#cb7-375" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Source Collection"</span><span class="op">,</span></span>
<span id="cb7-376"><a href="#cb7-376" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> source_data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">source_collection</span>)</span>
<span id="cb7-377"><a href="#cb7-377" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb7-378"><a href="#cb7-378" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb7-379"><a href="#cb7-379" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">barX</span>(source_data<span class="op">,</span> {</span>
<span id="cb7-380"><a href="#cb7-380" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"sample_count"</span><span class="op">,</span></span>
<span id="cb7-381"><a href="#cb7-381" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"source_collection"</span><span class="op">,</span></span>
<span id="cb7-382"><a href="#cb7-382" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"steelblue"</span><span class="op">,</span></span>
<span id="cb7-383"><a href="#cb7-383" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sort</span><span class="op">:</span> {<span class="dt">y</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">reverse</span><span class="op">:</span> <span class="kw">true</span>}</span>
<span id="cb7-384"><a href="#cb7-384" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb7-385"><a href="#cb7-385" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>(source_data<span class="op">,</span> {</span>
<span id="cb7-386"><a href="#cb7-386" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"sample_count"</span><span class="op">,</span></span>
<span id="cb7-387"><a href="#cb7-387" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"source_collection"</span><span class="op">,</span></span>
<span id="cb7-388"><a href="#cb7-388" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> d <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">"~s"</span>)(d<span class="op">.</span><span class="at">sample_count</span>)<span class="op">,</span></span>
<span id="cb7-389"><a href="#cb7-389" aria-hidden="true" tabindex="-1"></a>        <span class="dt">dx</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb7-390"><a href="#cb7-390" aria-hidden="true" tabindex="-1"></a>        <span class="dt">textAnchor</span><span class="op">:</span> <span class="st">"start"</span></span>
<span id="cb7-391"><a href="#cb7-391" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb7-392"><a href="#cb7-392" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb7-393"><a href="#cb7-393" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">120</span><span class="op">,</span></span>
<span id="cb7-394"><a href="#cb7-394" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb7-395"><a href="#cb7-395" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">600</span></span>
<span id="cb7-396"><a href="#cb7-396" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb7-397"><a href="#cb7-397" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="source-chart" class="cell-output cell-output-display">
<div id="ojs-cell-7" data-nodetype="declaration">

</div>
</div>
</div>
</section>
<section id="geographic-distribution-analysis" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Geographic Distribution Analysis</h1>
<p>Examine the geographic spread of samples and identify regional patterns.</p>
<div id="geographic-stats" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" data-startfrom="410" data-source-offset="-30"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 409;"><span id="cb8-410"><a href="#cb8-410" aria-hidden="true" tabindex="-1"></a>geo_stats <span class="op">=</span> {</span>
<span id="cb8-411"><a href="#cb8-411" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb8-412"><a href="#cb8-412" aria-hidden="true" tabindex="-1"></a><span class="vs">    SELECT </span></span>
<span id="cb8-413"><a href="#cb8-413" aria-hidden="true" tabindex="-1"></a><span class="vs">      count(*) as total_with_coords,</span></span>
<span id="cb8-414"><a href="#cb8-414" aria-hidden="true" tabindex="-1"></a><span class="vs">      min(sample_location_latitude) as min_lat,</span></span>
<span id="cb8-415"><a href="#cb8-415" aria-hidden="true" tabindex="-1"></a><span class="vs">      max(sample_location_latitude) as max_lat,</span></span>
<span id="cb8-416"><a href="#cb8-416" aria-hidden="true" tabindex="-1"></a><span class="vs">      avg(sample_location_latitude) as avg_lat,</span></span>
<span id="cb8-417"><a href="#cb8-417" aria-hidden="true" tabindex="-1"></a><span class="vs">      min(sample_location_longitude) as min_lon,</span></span>
<span id="cb8-418"><a href="#cb8-418" aria-hidden="true" tabindex="-1"></a><span class="vs">      max(sample_location_longitude) as max_lon,</span></span>
<span id="cb8-419"><a href="#cb8-419" aria-hidden="true" tabindex="-1"></a><span class="vs">      avg(sample_location_longitude) as avg_lon</span></span>
<span id="cb8-420"><a href="#cb8-420" aria-hidden="true" tabindex="-1"></a><span class="vs">    FROM isamples_data </span></span>
<span id="cb8-421"><a href="#cb8-421" aria-hidden="true" tabindex="-1"></a><span class="vs">    WHERE sample_location_latitude IS NOT NULL </span></span>
<span id="cb8-422"><a href="#cb8-422" aria-hidden="true" tabindex="-1"></a><span class="vs">    AND sample_location_longitude IS NOT NULL</span></span>
<span id="cb8-423"><a href="#cb8-423" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span>)<span class="op">;</span></span>
<span id="cb8-424"><a href="#cb8-424" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> rows <span class="op">=</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">;</span></span>
<span id="cb8-425"><a href="#cb8-425" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> row <span class="op">=</span> rows[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb8-426"><a href="#cb8-426" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Convert BigInt values to Numbers where needed</span></span>
<span id="cb8-427"><a href="#cb8-427" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb8-428"><a href="#cb8-428" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span>row<span class="op">,</span></span>
<span id="cb8-429"><a href="#cb8-429" aria-hidden="true" tabindex="-1"></a>    <span class="dt">total_with_coords</span><span class="op">:</span> <span class="bu">Number</span>(row<span class="op">.</span><span class="at">total_with_coords</span>)</span>
<span id="cb8-430"><a href="#cb8-430" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb8-431"><a href="#cb8-431" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-432"><a href="#cb8-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-433"><a href="#cb8-433" aria-hidden="true" tabindex="-1"></a><span class="co">// Data-driven regional analysis using H3 res4 cell grouping</span></span>
<span id="cb8-434"><a href="#cb8-434" aria-hidden="true" tabindex="-1"></a><span class="co">// Replaces hardcoded CASE WHEN bounding boxes with dynamic discovery</span></span>
<span id="cb8-435"><a href="#cb8-435" aria-hidden="true" tabindex="-1"></a>regional_data <span class="op">=</span> {</span>
<span id="cb8-436"><a href="#cb8-436" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if h3_res4 column exists (H3-indexed file)</span></span>
<span id="cb8-437"><a href="#cb8-437" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> hasH3 <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb8-438"><a href="#cb8-438" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb8-439"><a href="#cb8-439" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> colCheck <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`SELECT h3_res4 FROM isamples_data LIMIT 1`</span>)<span class="op">;</span></span>
<span id="cb8-440"><a href="#cb8-440" aria-hidden="true" tabindex="-1"></a>    hasH3 <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb8-441"><a href="#cb8-441" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (e) {</span>
<span id="cb8-442"><a href="#cb8-442" aria-hidden="true" tabindex="-1"></a>    hasH3 <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb8-443"><a href="#cb8-443" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-444"><a href="#cb8-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-445"><a href="#cb8-445" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (hasH3) {</span>
<span id="cb8-446"><a href="#cb8-446" aria-hidden="true" tabindex="-1"></a>    <span class="co">// H3-based regional grouping: discover dense clusters dynamically</span></span>
<span id="cb8-447"><a href="#cb8-447" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb8-448"><a href="#cb8-448" aria-hidden="true" tabindex="-1"></a><span class="vs">      SELECT</span></span>
<span id="cb8-449"><a href="#cb8-449" aria-hidden="true" tabindex="-1"></a><span class="vs">        h3_res4,</span></span>
<span id="cb8-450"><a href="#cb8-450" aria-hidden="true" tabindex="-1"></a><span class="vs">        COUNT(*) as sample_count,</span></span>
<span id="cb8-451"><a href="#cb8-451" aria-hidden="true" tabindex="-1"></a><span class="vs">        AVG(sample_location_latitude) as avg_lat,</span></span>
<span id="cb8-452"><a href="#cb8-452" aria-hidden="true" tabindex="-1"></a><span class="vs">        AVG(sample_location_longitude) as avg_lon,</span></span>
<span id="cb8-453"><a href="#cb8-453" aria-hidden="true" tabindex="-1"></a><span class="vs">        COUNT(DISTINCT source_collection) as source_count,</span></span>
<span id="cb8-454"><a href="#cb8-454" aria-hidden="true" tabindex="-1"></a><span class="vs">        MODE(source_collection) as dominant_source</span></span>
<span id="cb8-455"><a href="#cb8-455" aria-hidden="true" tabindex="-1"></a><span class="vs">      FROM isamples_data</span></span>
<span id="cb8-456"><a href="#cb8-456" aria-hidden="true" tabindex="-1"></a><span class="vs">      WHERE sample_location_latitude IS NOT NULL</span></span>
<span id="cb8-457"><a href="#cb8-457" aria-hidden="true" tabindex="-1"></a><span class="vs">        AND sample_location_longitude IS NOT NULL</span></span>
<span id="cb8-458"><a href="#cb8-458" aria-hidden="true" tabindex="-1"></a><span class="vs">        AND h3_res4 IS NOT NULL</span></span>
<span id="cb8-459"><a href="#cb8-459" aria-hidden="true" tabindex="-1"></a><span class="vs">      GROUP BY h3_res4</span></span>
<span id="cb8-460"><a href="#cb8-460" aria-hidden="true" tabindex="-1"></a><span class="vs">      HAVING COUNT(*) &gt; 100</span></span>
<span id="cb8-461"><a href="#cb8-461" aria-hidden="true" tabindex="-1"></a><span class="vs">      ORDER BY sample_count DESC</span></span>
<span id="cb8-462"><a href="#cb8-462" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb8-463"><a href="#cb8-463" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Assign region labels based on centroid location</span></span>
<span id="cb8-464"><a href="#cb8-464" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> {</span>
<span id="cb8-465"><a href="#cb8-465" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> lat <span class="op">=</span> row<span class="op">.</span><span class="at">avg_lat</span><span class="op">;</span></span>
<span id="cb8-466"><a href="#cb8-466" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> lon <span class="op">=</span> row<span class="op">.</span><span class="at">avg_lon</span><span class="op">;</span></span>
<span id="cb8-467"><a href="#cb8-467" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> region<span class="op">;</span></span>
<span id="cb8-468"><a href="#cb8-468" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (lon <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">130</span> <span class="op">&amp;&amp;</span> lon <span class="op">&lt;=</span> <span class="op">-</span><span class="dv">60</span> <span class="op">&amp;&amp;</span> lat <span class="op">&gt;=</span> <span class="dv">20</span> <span class="op">&amp;&amp;</span> lat <span class="op">&lt;=</span> <span class="dv">55</span>) region <span class="op">=</span> <span class="st">'North America'</span><span class="op">;</span></span>
<span id="cb8-469"><a href="#cb8-469" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (lon <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">15</span> <span class="op">&amp;&amp;</span> lon <span class="op">&lt;=</span> <span class="dv">45</span> <span class="op">&amp;&amp;</span> lat <span class="op">&gt;=</span> <span class="dv">30</span> <span class="op">&amp;&amp;</span> lat <span class="op">&lt;=</span> <span class="dv">75</span>) region <span class="op">=</span> <span class="st">'Europe'</span><span class="op">;</span></span>
<span id="cb8-470"><a href="#cb8-470" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (lon <span class="op">&gt;=</span> <span class="dv">90</span> <span class="op">&amp;&amp;</span> lon <span class="op">&lt;=</span> <span class="dv">150</span> <span class="op">&amp;&amp;</span> lat <span class="op">&gt;=</span> <span class="dv">15</span> <span class="op">&amp;&amp;</span> lat <span class="op">&lt;=</span> <span class="dv">55</span>) region <span class="op">=</span> <span class="st">'East Asia'</span><span class="op">;</span></span>
<span id="cb8-471"><a href="#cb8-471" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (lon <span class="op">&gt;=</span> <span class="dv">110</span> <span class="op">&amp;&amp;</span> lon <span class="op">&lt;=</span> <span class="dv">160</span> <span class="op">&amp;&amp;</span> lat <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">50</span> <span class="op">&amp;&amp;</span> lat <span class="op">&lt;=</span> <span class="op">-</span><span class="dv">5</span>) region <span class="op">=</span> <span class="st">'Australia'</span><span class="op">;</span></span>
<span id="cb8-472"><a href="#cb8-472" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (lon <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">90</span> <span class="op">&amp;&amp;</span> lon <span class="op">&lt;=</span> <span class="op">-</span><span class="dv">30</span> <span class="op">&amp;&amp;</span> lat <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">60</span> <span class="op">&amp;&amp;</span> lat <span class="op">&lt;=</span> <span class="dv">15</span>) region <span class="op">=</span> <span class="st">'South America'</span><span class="op">;</span></span>
<span id="cb8-473"><a href="#cb8-473" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (lon <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">20</span> <span class="op">&amp;&amp;</span> lon <span class="op">&lt;=</span> <span class="dv">55</span> <span class="op">&amp;&amp;</span> lat <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">40</span> <span class="op">&amp;&amp;</span> lat <span class="op">&lt;=</span> <span class="dv">30</span>) region <span class="op">=</span> <span class="st">'Africa'</span><span class="op">;</span></span>
<span id="cb8-474"><a href="#cb8-474" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> region <span class="op">=</span> <span class="st">'Other'</span><span class="op">;</span></span>
<span id="cb8-475"><a href="#cb8-475" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb8-476"><a href="#cb8-476" aria-hidden="true" tabindex="-1"></a>        region<span class="op">,</span></span>
<span id="cb8-477"><a href="#cb8-477" aria-hidden="true" tabindex="-1"></a>        <span class="dt">source_collection</span><span class="op">:</span> row<span class="op">.</span><span class="at">dominant_source</span><span class="op">,</span></span>
<span id="cb8-478"><a href="#cb8-478" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sample_count</span><span class="op">:</span> <span class="bu">Number</span>(row<span class="op">.</span><span class="at">sample_count</span>)<span class="op">,</span></span>
<span id="cb8-479"><a href="#cb8-479" aria-hidden="true" tabindex="-1"></a>        <span class="dt">avg_lat</span><span class="op">:</span> row<span class="op">.</span><span class="at">avg_lat</span><span class="op">,</span></span>
<span id="cb8-480"><a href="#cb8-480" aria-hidden="true" tabindex="-1"></a>        <span class="dt">avg_lon</span><span class="op">:</span> row<span class="op">.</span><span class="at">avg_lon</span><span class="op">,</span></span>
<span id="cb8-481"><a href="#cb8-481" aria-hidden="true" tabindex="-1"></a>        <span class="dt">h3_cell</span><span class="op">:</span> row<span class="op">.</span><span class="at">h3_res4</span><span class="op">,</span></span>
<span id="cb8-482"><a href="#cb8-482" aria-hidden="true" tabindex="-1"></a>        <span class="dt">source_count</span><span class="op">:</span> <span class="bu">Number</span>(row<span class="op">.</span><span class="at">source_count</span>)</span>
<span id="cb8-483"><a href="#cb8-483" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb8-484"><a href="#cb8-484" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb8-485"><a href="#cb8-485" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-486"><a href="#cb8-486" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fallback for non-H3 files: use simple lat/lon-based grouping</span></span>
<span id="cb8-487"><a href="#cb8-487" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb8-488"><a href="#cb8-488" aria-hidden="true" tabindex="-1"></a><span class="vs">      SELECT</span></span>
<span id="cb8-489"><a href="#cb8-489" aria-hidden="true" tabindex="-1"></a><span class="vs">        source_collection,</span></span>
<span id="cb8-490"><a href="#cb8-490" aria-hidden="true" tabindex="-1"></a><span class="vs">        count(*) as sample_count,</span></span>
<span id="cb8-491"><a href="#cb8-491" aria-hidden="true" tabindex="-1"></a><span class="vs">        avg(sample_location_latitude) as avg_lat,</span></span>
<span id="cb8-492"><a href="#cb8-492" aria-hidden="true" tabindex="-1"></a><span class="vs">        avg(sample_location_longitude) as avg_lon</span></span>
<span id="cb8-493"><a href="#cb8-493" aria-hidden="true" tabindex="-1"></a><span class="vs">      FROM isamples_data</span></span>
<span id="cb8-494"><a href="#cb8-494" aria-hidden="true" tabindex="-1"></a><span class="vs">      WHERE sample_location_latitude IS NOT NULL</span></span>
<span id="cb8-495"><a href="#cb8-495" aria-hidden="true" tabindex="-1"></a><span class="vs">        AND sample_location_longitude IS NOT NULL</span></span>
<span id="cb8-496"><a href="#cb8-496" aria-hidden="true" tabindex="-1"></a><span class="vs">      GROUP BY source_collection</span></span>
<span id="cb8-497"><a href="#cb8-497" aria-hidden="true" tabindex="-1"></a><span class="vs">      ORDER BY sample_count DESC</span></span>
<span id="cb8-498"><a href="#cb8-498" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb8-499"><a href="#cb8-499" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> {</span>
<span id="cb8-500"><a href="#cb8-500" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> lat <span class="op">=</span> row<span class="op">.</span><span class="at">avg_lat</span><span class="op">;</span></span>
<span id="cb8-501"><a href="#cb8-501" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> lon <span class="op">=</span> row<span class="op">.</span><span class="at">avg_lon</span><span class="op">;</span></span>
<span id="cb8-502"><a href="#cb8-502" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> region <span class="op">=</span> <span class="st">'Other'</span><span class="op">;</span></span>
<span id="cb8-503"><a href="#cb8-503" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (lon <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">130</span> <span class="op">&amp;&amp;</span> lon <span class="op">&lt;=</span> <span class="op">-</span><span class="dv">60</span> <span class="op">&amp;&amp;</span> lat <span class="op">&gt;=</span> <span class="dv">20</span> <span class="op">&amp;&amp;</span> lat <span class="op">&lt;=</span> <span class="dv">55</span>) region <span class="op">=</span> <span class="st">'North America'</span><span class="op">;</span></span>
<span id="cb8-504"><a href="#cb8-504" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (lon <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">15</span> <span class="op">&amp;&amp;</span> lon <span class="op">&lt;=</span> <span class="dv">45</span> <span class="op">&amp;&amp;</span> lat <span class="op">&gt;=</span> <span class="dv">30</span> <span class="op">&amp;&amp;</span> lat <span class="op">&lt;=</span> <span class="dv">75</span>) region <span class="op">=</span> <span class="st">'Europe'</span><span class="op">;</span></span>
<span id="cb8-505"><a href="#cb8-505" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (lon <span class="op">&gt;=</span> <span class="dv">90</span> <span class="op">&amp;&amp;</span> lon <span class="op">&lt;=</span> <span class="dv">150</span> <span class="op">&amp;&amp;</span> lat <span class="op">&gt;=</span> <span class="dv">15</span> <span class="op">&amp;&amp;</span> lat <span class="op">&lt;=</span> <span class="dv">55</span>) region <span class="op">=</span> <span class="st">'East Asia'</span><span class="op">;</span></span>
<span id="cb8-506"><a href="#cb8-506" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (lon <span class="op">&gt;=</span> <span class="dv">110</span> <span class="op">&amp;&amp;</span> lon <span class="op">&lt;=</span> <span class="dv">160</span> <span class="op">&amp;&amp;</span> lat <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">50</span> <span class="op">&amp;&amp;</span> lat <span class="op">&lt;=</span> <span class="op">-</span><span class="dv">5</span>) region <span class="op">=</span> <span class="st">'Australia'</span><span class="op">;</span></span>
<span id="cb8-507"><a href="#cb8-507" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb8-508"><a href="#cb8-508" aria-hidden="true" tabindex="-1"></a>        region<span class="op">,</span></span>
<span id="cb8-509"><a href="#cb8-509" aria-hidden="true" tabindex="-1"></a>        <span class="dt">source_collection</span><span class="op">:</span> row<span class="op">.</span><span class="at">source_collection</span><span class="op">,</span></span>
<span id="cb8-510"><a href="#cb8-510" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sample_count</span><span class="op">:</span> <span class="bu">Number</span>(row<span class="op">.</span><span class="at">sample_count</span>)<span class="op">,</span></span>
<span id="cb8-511"><a href="#cb8-511" aria-hidden="true" tabindex="-1"></a>        <span class="dt">avg_lat</span><span class="op">:</span> row<span class="op">.</span><span class="at">avg_lat</span><span class="op">,</span></span>
<span id="cb8-512"><a href="#cb8-512" aria-hidden="true" tabindex="-1"></a>        <span class="dt">avg_lon</span><span class="op">:</span> row<span class="op">.</span><span class="at">avg_lon</span></span>
<span id="cb8-513"><a href="#cb8-513" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb8-514"><a href="#cb8-514" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb8-515"><a href="#cb8-515" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-516"><a href="#cb8-516" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="geographic-stats-1">
<div id="ojs-cell-8-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="geographic-stats-2">
<div id="ojs-cell-8-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" data-startfrom="520" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 519;"><span id="cb9-520"><a href="#cb9-520" aria-hidden="true" tabindex="-1"></a><span class="fu">md</span><span class="vs">`</span></span>
<span id="cb9-521"><a href="#cb9-521" aria-hidden="true" tabindex="-1"></a><span class="vs">## Geographic Statistics</span></span>
<span id="cb9-522"><a href="#cb9-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-523"><a href="#cb9-523" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Latitude range**: </span><span class="sc">${</span>geo_stats<span class="op">.</span><span class="at">min_lat</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="vs">¬∞ to </span><span class="sc">${</span>geo_stats<span class="op">.</span><span class="at">max_lat</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="vs">¬∞</span></span>
<span id="cb9-524"><a href="#cb9-524" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Longitude range**: </span><span class="sc">${</span>geo_stats<span class="op">.</span><span class="at">min_lon</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="vs">¬∞ to </span><span class="sc">${</span>geo_stats<span class="op">.</span><span class="at">max_lon</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="vs">¬∞</span></span>
<span id="cb9-525"><a href="#cb9-525" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Average location**: </span><span class="sc">${</span>geo_stats<span class="op">.</span><span class="at">avg_lat</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="vs">¬∞, </span><span class="sc">${</span>geo_stats<span class="op">.</span><span class="at">avg_lon</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="vs">¬∞</span></span>
<span id="cb9-526"><a href="#cb9-526" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Dense H3 clusters**: </span><span class="sc">${</span>regional_data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> (cells with &gt;100 samples)</span></span>
<span id="cb9-527"><a href="#cb9-527" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Regions discovered**: </span><span class="sc">${</span>[<span class="op">...</span><span class="kw">new</span> <span class="bu">Set</span>(regional_data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">region</span>))]<span class="op">.</span><span class="fu">join</span>(<span class="st">', '</span>)<span class="sc">}</span></span>
<span id="cb9-528"><a href="#cb9-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-529"><a href="#cb9-529" aria-hidden="true" tabindex="-1"></a><span class="vs">*Regional grouping is data-driven using H3 resolution-4 hexagonal cells, replacing hardcoded bounding boxes.*</span></span>
<span id="cb9-530"><a href="#cb9-530" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="display-geo-stats" class="cell-output cell-output-display">
<div id="ojs-cell-9" data-nodetype="expression">

</div>
</div>
</div>
</section>
<section id="interactive-regional-explorer" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Interactive Regional Explorer</h1>
<p>Create an interactive visualization to explore samples by region and source.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" data-startfrom="540" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 539;"><span id="cb10-540"><a href="#cb10-540" aria-hidden="true" tabindex="-1"></a><span class="co">// Interactive region selector</span></span>
<span id="cb10-541"><a href="#cb10-541" aria-hidden="true" tabindex="-1"></a>viewof selected_region <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(</span>
<span id="cb10-542"><a href="#cb10-542" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"All"</span><span class="op">,</span> <span class="op">...</span><span class="kw">new</span> <span class="bu">Set</span>(regional_data<span class="op">?.</span><span class="at">map</span><span class="op">?.</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">region</span>) <span class="op">||</span> [])]<span class="op">,</span></span>
<span id="cb10-543"><a href="#cb10-543" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb10-544"><a href="#cb10-544" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Select Region:"</span><span class="op">,</span></span>
<span id="cb10-545"><a href="#cb10-545" aria-hidden="true" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> <span class="st">"All"</span></span>
<span id="cb10-546"><a href="#cb10-546" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-547"><a href="#cb10-547" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="regional-controls" class="cell-output cell-output-display">
<div id="ojs-cell-10" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" data-startfrom="553" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 552;"><span id="cb11-553"><a href="#cb11-553" aria-hidden="true" tabindex="-1"></a><span class="co">// Regional distribution chart (data-driven from H3 clusters)</span></span>
<span id="cb11-554"><a href="#cb11-554" aria-hidden="true" tabindex="-1"></a>regional_chart <span class="op">=</span> {</span>
<span id="cb11-555"><a href="#cb11-555" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(regional_data)) {</span>
<span id="cb11-556"><a href="#cb11-556" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Error: Regional data is not available&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb11-557"><a href="#cb11-557" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-558"><a href="#cb11-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-559"><a href="#cb11-559" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Aggregate H3 cell data by discovered region</span></span>
<span id="cb11-560"><a href="#cb11-560" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> regionTotals <span class="op">=</span> d3<span class="op">.</span><span class="fu">rollup</span>(</span>
<span id="cb11-561"><a href="#cb11-561" aria-hidden="true" tabindex="-1"></a>    regional_data<span class="op">,</span></span>
<span id="cb11-562"><a href="#cb11-562" aria-hidden="true" tabindex="-1"></a>    v <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">sum</span>(v<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">sample_count</span>)<span class="op">,</span></span>
<span id="cb11-563"><a href="#cb11-563" aria-hidden="true" tabindex="-1"></a>    d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">region</span></span>
<span id="cb11-564"><a href="#cb11-564" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb11-565"><a href="#cb11-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-566"><a href="#cb11-566" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> aggregatedData <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(regionTotals<span class="op">,</span> ([region<span class="op">,</span> total]) <span class="kw">=&gt;</span> ({</span>
<span id="cb11-567"><a href="#cb11-567" aria-hidden="true" tabindex="-1"></a>    <span class="dt">region</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb11-568"><a href="#cb11-568" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sample_count</span><span class="op">:</span> total</span>
<span id="cb11-569"><a href="#cb11-569" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> b<span class="op">.</span><span class="at">sample_count</span> <span class="op">-</span> a<span class="op">.</span><span class="at">sample_count</span>)<span class="op">;</span></span>
<span id="cb11-570"><a href="#cb11-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-571"><a href="#cb11-571" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb11-572"><a href="#cb11-572" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="vs">`Sample Distribution by Region (H3-derived, </span><span class="sc">${</span>aggregatedData<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> regions)`</span><span class="op">,</span></span>
<span id="cb11-573"><a href="#cb11-573" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">700</span><span class="op">,</span></span>
<span id="cb11-574"><a href="#cb11-574" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb11-575"><a href="#cb11-575" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">120</span><span class="op">,</span></span>
<span id="cb11-576"><a href="#cb11-576" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb11-577"><a href="#cb11-577" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Number of samples"</span><span class="op">,</span></span>
<span id="cb11-578"><a href="#cb11-578" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tickFormat</span><span class="op">:</span> <span class="st">"~s"</span></span>
<span id="cb11-579"><a href="#cb11-579" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb11-580"><a href="#cb11-580" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb11-581"><a href="#cb11-581" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Region"</span><span class="op">,</span></span>
<span id="cb11-582"><a href="#cb11-582" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> aggregatedData<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">region</span>)</span>
<span id="cb11-583"><a href="#cb11-583" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb11-584"><a href="#cb11-584" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb11-585"><a href="#cb11-585" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">barX</span>(aggregatedData<span class="op">,</span> {</span>
<span id="cb11-586"><a href="#cb11-586" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"sample_count"</span><span class="op">,</span></span>
<span id="cb11-587"><a href="#cb11-587" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"region"</span><span class="op">,</span></span>
<span id="cb11-588"><a href="#cb11-588" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"steelblue"</span><span class="op">,</span></span>
<span id="cb11-589"><a href="#cb11-589" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sort</span><span class="op">:</span> {<span class="dt">y</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">reverse</span><span class="op">:</span> <span class="kw">true</span>}</span>
<span id="cb11-590"><a href="#cb11-590" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb11-591"><a href="#cb11-591" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>(aggregatedData<span class="op">,</span> {</span>
<span id="cb11-592"><a href="#cb11-592" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"sample_count"</span><span class="op">,</span></span>
<span id="cb11-593"><a href="#cb11-593" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"region"</span><span class="op">,</span></span>
<span id="cb11-594"><a href="#cb11-594" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> d <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">"~s"</span>)(d<span class="op">.</span><span class="at">sample_count</span>)<span class="op">,</span></span>
<span id="cb11-595"><a href="#cb11-595" aria-hidden="true" tabindex="-1"></a>        <span class="dt">dx</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb11-596"><a href="#cb11-596" aria-hidden="true" tabindex="-1"></a>        <span class="dt">textAnchor</span><span class="op">:</span> <span class="st">"start"</span></span>
<span id="cb11-597"><a href="#cb11-597" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb11-598"><a href="#cb11-598" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-599"><a href="#cb11-599" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb11-600"><a href="#cb11-600" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="regional-chart" class="cell-output cell-output-display">
<div id="ojs-cell-11" data-nodetype="declaration">

</div>
</div>
</div>
</section>
<section id="efficient-sampling-for-visualization" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Efficient Sampling for Visualization</h1>
<p>Create a representative sample of the data for detailed visualization while minimizing data transfer.</p>
<div id="sampling-controls" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" data-startfrom="613" data-source-offset="-24"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 612;"><span id="cb12-613"><a href="#cb12-613" aria-hidden="true" tabindex="-1"></a>viewof sample_size <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">1000</span><span class="op">,</span> <span class="dv">50000</span>]<span class="op">,</span> {</span>
<span id="cb12-614"><a href="#cb12-614" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">"Sample Size:"</span><span class="op">,</span></span>
<span id="cb12-615"><a href="#cb12-615" aria-hidden="true" tabindex="-1"></a>  <span class="dt">step</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb12-616"><a href="#cb12-616" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="dv">10000</span></span>
<span id="cb12-617"><a href="#cb12-617" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb12-618"><a href="#cb12-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-619"><a href="#cb12-619" aria-hidden="true" tabindex="-1"></a><span class="co">// Sample per collection limit</span></span>
<span id="cb12-620"><a href="#cb12-620" aria-hidden="true" tabindex="-1"></a>viewof max_per_collection <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">500</span><span class="op">,</span> <span class="dv">5000</span>]<span class="op">,</span> {</span>
<span id="cb12-621"><a href="#cb12-621" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">"Max per Collection:"</span><span class="op">,</span></span>
<span id="cb12-622"><a href="#cb12-622" aria-hidden="true" tabindex="-1"></a>  <span class="dt">step</span><span class="op">:</span> <span class="dv">250</span><span class="op">,</span></span>
<span id="cb12-623"><a href="#cb12-623" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="dv">2500</span></span>
<span id="cb12-624"><a href="#cb12-624" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="sampling-controls-1">
<div id="ojs-cell-12-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="sampling-controls-2">
<div id="ojs-cell-12-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div id="create-sample" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" data-startfrom="631" data-source-offset="-72"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 630;"><span id="cb13-631"><a href="#cb13-631" aria-hidden="true" tabindex="-1"></a>sample_data <span class="op">=</span> {</span>
<span id="cb13-632"><a href="#cb13-632" aria-hidden="true" tabindex="-1"></a>  <span class="co">// In Observable, inputs are automatically reactive values</span></span>
<span id="cb13-633"><a href="#cb13-633" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> maxPerCollection <span class="op">=</span> max_per_collection<span class="op">;</span></span>
<span id="cb13-634"><a href="#cb13-634" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> sampleSizeValue <span class="op">=</span> sample_size<span class="op">;</span></span>
<span id="cb13-635"><a href="#cb13-635" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-636"><a href="#cb13-636" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use a fixed sampling rate to avoid NaN issues</span></span>
<span id="cb13-637"><a href="#cb13-637" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> samplingRate <span class="op">=</span> <span class="fl">0.1</span><span class="op">;</span> <span class="co">// Sample 10% of data</span></span>
<span id="cb13-638"><a href="#cb13-638" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-639"><a href="#cb13-639" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Validate that all values are proper numbers</span></span>
<span id="cb13-640"><a href="#cb13-640" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="pp">isNaN</span>(maxPerCollection) <span class="op">||</span> <span class="pp">isNaN</span>(sampleSizeValue) <span class="op">||</span> <span class="pp">isNaN</span>(samplingRate)) {</span>
<span id="cb13-641"><a href="#cb13-641" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'Invalid numeric values detected'</span><span class="op">,</span> {maxPerCollection<span class="op">,</span> sampleSizeValue<span class="op">,</span> samplingRate})<span class="op">;</span></span>
<span id="cb13-642"><a href="#cb13-642" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'Invalid sampling parameters'</span>)<span class="op">;</span></span>
<span id="cb13-643"><a href="#cb13-643" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-644"><a href="#cb13-644" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-645"><a href="#cb13-645" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb13-646"><a href="#cb13-646" aria-hidden="true" tabindex="-1"></a><span class="vs">    WITH sampled_data AS (</span></span>
<span id="cb13-647"><a href="#cb13-647" aria-hidden="true" tabindex="-1"></a><span class="vs">      SELECT </span></span>
<span id="cb13-648"><a href="#cb13-648" aria-hidden="true" tabindex="-1"></a><span class="vs">        sample_identifier,</span></span>
<span id="cb13-649"><a href="#cb13-649" aria-hidden="true" tabindex="-1"></a><span class="vs">        source_collection,</span></span>
<span id="cb13-650"><a href="#cb13-650" aria-hidden="true" tabindex="-1"></a><span class="vs">        sample_location_longitude as longitude,</span></span>
<span id="cb13-651"><a href="#cb13-651" aria-hidden="true" tabindex="-1"></a><span class="vs">        sample_location_latitude as latitude,</span></span>
<span id="cb13-652"><a href="#cb13-652" aria-hidden="true" tabindex="-1"></a><span class="vs">        has_material_category,</span></span>
<span id="cb13-653"><a href="#cb13-653" aria-hidden="true" tabindex="-1"></a><span class="vs">        label</span></span>
<span id="cb13-654"><a href="#cb13-654" aria-hidden="true" tabindex="-1"></a><span class="vs">      FROM isamples_data </span></span>
<span id="cb13-655"><a href="#cb13-655" aria-hidden="true" tabindex="-1"></a><span class="vs">      WHERE sample_location_latitude IS NOT NULL </span></span>
<span id="cb13-656"><a href="#cb13-656" aria-hidden="true" tabindex="-1"></a><span class="vs">      AND sample_location_longitude IS NOT NULL</span></span>
<span id="cb13-657"><a href="#cb13-657" aria-hidden="true" tabindex="-1"></a><span class="vs">      AND random() &lt; </span><span class="sc">${</span>samplingRate<span class="sc">}</span></span>
<span id="cb13-658"><a href="#cb13-658" aria-hidden="true" tabindex="-1"></a><span class="vs">    )</span></span>
<span id="cb13-659"><a href="#cb13-659" aria-hidden="true" tabindex="-1"></a><span class="vs">    SELECT * FROM sampled_data</span></span>
<span id="cb13-660"><a href="#cb13-660" aria-hidden="true" tabindex="-1"></a><span class="vs">    LIMIT </span><span class="sc">${</span>sampleSizeValue<span class="sc">}</span></span>
<span id="cb13-661"><a href="#cb13-661" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span>)<span class="op">;</span></span>
<span id="cb13-662"><a href="#cb13-662" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">;</span></span>
<span id="cb13-663"><a href="#cb13-663" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-664"><a href="#cb13-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-665"><a href="#cb13-665" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate sample statistics</span></span>
<span id="cb13-666"><a href="#cb13-666" aria-hidden="true" tabindex="-1"></a>sample_stats <span class="op">=</span> {</span>
<span id="cb13-667"><a href="#cb13-667" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> total <span class="op">=</span> sample_data<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb13-668"><a href="#cb13-668" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> by_source <span class="op">=</span> d3<span class="op">.</span><span class="fu">rollup</span>(sample_data<span class="op">,</span> v <span class="kw">=&gt;</span> v<span class="op">.</span><span class="at">length</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">source_collection</span>)<span class="op">;</span></span>
<span id="cb13-669"><a href="#cb13-669" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb13-670"><a href="#cb13-670" aria-hidden="true" tabindex="-1"></a>    total<span class="op">,</span></span>
<span id="cb13-671"><a href="#cb13-671" aria-hidden="true" tabindex="-1"></a>    <span class="dt">by_source</span><span class="op">:</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(by_source<span class="op">,</span> ([source<span class="op">,</span> count]) <span class="kw">=&gt;</span> ({source<span class="op">,</span> count}))</span>
<span id="cb13-672"><a href="#cb13-672" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> b<span class="op">.</span><span class="at">count</span> <span class="op">-</span> a<span class="op">.</span><span class="at">count</span>)</span>
<span id="cb13-673"><a href="#cb13-673" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb13-674"><a href="#cb13-674" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="create-sample-1">
<div id="ojs-cell-13-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="create-sample-2">
<div id="ojs-cell-13-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" data-startfrom="678" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 677;"><span id="cb14-678"><a href="#cb14-678" aria-hidden="true" tabindex="-1"></a><span class="fu">md</span><span class="vs">`</span></span>
<span id="cb14-679"><a href="#cb14-679" aria-hidden="true" tabindex="-1"></a><span class="vs">## Sample Statistics</span></span>
<span id="cb14-680"><a href="#cb14-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-681"><a href="#cb14-681" aria-hidden="true" tabindex="-1"></a><span class="vs">**Total sample size**: </span><span class="sc">${</span>sample_stats<span class="op">.</span><span class="at">total</span><span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span><span class="vs"> points  </span></span>
<span id="cb14-682"><a href="#cb14-682" aria-hidden="true" tabindex="-1"></a><span class="vs">**Data transfer**: ~</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(sample_stats<span class="op">.</span><span class="at">total</span> <span class="op">*</span> <span class="dv">6</span> <span class="op">*</span> <span class="dv">8</span> <span class="op">/</span> <span class="dv">1024</span> <span class="op">/</span> <span class="dv">1024</span>)<span class="sc">}</span><span class="vs"> MB (estimated)  </span></span>
<span id="cb14-683"><a href="#cb14-683" aria-hidden="true" tabindex="-1"></a><span class="vs">**Reduction factor**: </span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(geo_count <span class="op">/</span> sample_stats<span class="op">.</span><span class="at">total</span>)<span class="sc">}</span><span class="vs">x fewer points</span></span>
<span id="cb14-684"><a href="#cb14-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-685"><a href="#cb14-685" aria-hidden="true" tabindex="-1"></a><span class="vs">**Distribution by source**:</span></span>
<span id="cb14-686"><a href="#cb14-686" aria-hidden="true" tabindex="-1"></a><span class="sc">${</span>sample_stats<span class="op">.</span><span class="at">by_source</span><span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> <span class="vs">`- </span><span class="sc">${</span>d<span class="op">.</span><span class="at">source</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>d<span class="op">.</span><span class="at">count</span><span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span><span class="vs">`</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)<span class="sc">}</span></span>
<span id="cb14-687"><a href="#cb14-687" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="display-sample-stats" class="cell-output cell-output-display">
<div id="ojs-cell-14" data-nodetype="expression">

</div>
</div>
</div>
</section>
<section id="interactive-world-map" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Interactive World Map</h1>
<p>Create an interactive scatter plot map showing the geographic distribution of samples.</p>
<div id="map-controls" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" data-startfrom="700" data-source-offset="-28"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 699;"><span id="cb15-700"><a href="#cb15-700" aria-hidden="true" tabindex="-1"></a>viewof projection <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>([</span>
<span id="cb15-701"><a href="#cb15-701" aria-hidden="true" tabindex="-1"></a>  <span class="st">"equirectangular"</span><span class="op">,</span></span>
<span id="cb15-702"><a href="#cb15-702" aria-hidden="true" tabindex="-1"></a>  <span class="st">"orthographic"</span><span class="op">,</span></span>
<span id="cb15-703"><a href="#cb15-703" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mercator"</span></span>
<span id="cb15-704"><a href="#cb15-704" aria-hidden="true" tabindex="-1"></a>]<span class="op">,</span> {</span>
<span id="cb15-705"><a href="#cb15-705" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">"Map Projection:"</span><span class="op">,</span></span>
<span id="cb15-706"><a href="#cb15-706" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">"equirectangular"</span></span>
<span id="cb15-707"><a href="#cb15-707" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb15-708"><a href="#cb15-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-709"><a href="#cb15-709" aria-hidden="true" tabindex="-1"></a><span class="co">// Point size control</span></span>
<span id="cb15-710"><a href="#cb15-710" aria-hidden="true" tabindex="-1"></a>viewof point_size <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="fl">0.5</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">,</span> {</span>
<span id="cb15-711"><a href="#cb15-711" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">"Point Size:"</span><span class="op">,</span></span>
<span id="cb15-712"><a href="#cb15-712" aria-hidden="true" tabindex="-1"></a>  <span class="dt">step</span><span class="op">:</span> <span class="fl">0.1</span><span class="op">,</span></span>
<span id="cb15-713"><a href="#cb15-713" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="fl">1.5</span></span>
<span id="cb15-714"><a href="#cb15-714" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="map-controls-1">
<div id="ojs-cell-15-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="map-controls-2">
<div id="ojs-cell-15-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div id="world-map" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" data-startfrom="721" data-source-offset="-24"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 720;"><span id="cb16-721"><a href="#cb16-721" aria-hidden="true" tabindex="-1"></a>world <span class="op">=</span> <span class="fu">fetch</span>(<span class="st">"https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"</span>)</span>
<span id="cb16-722"><a href="#cb16-722" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(response <span class="kw">=&gt;</span> response<span class="op">.</span><span class="fu">json</span>())</span>
<span id="cb16-723"><a href="#cb16-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-724"><a href="#cb16-724" aria-hidden="true" tabindex="-1"></a><span class="co">// Create world map with sample points</span></span>
<span id="cb16-725"><a href="#cb16-725" aria-hidden="true" tabindex="-1"></a>world_map <span class="op">=</span> {</span>
<span id="cb16-726"><a href="#cb16-726" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Await the world data</span></span>
<span id="cb16-727"><a href="#cb16-727" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> worldData <span class="op">=</span> <span class="cf">await</span> world<span class="op">;</span></span>
<span id="cb16-728"><a href="#cb16-728" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> countries <span class="op">=</span> topojson<span class="op">.</span><span class="fu">feature</span>(worldData<span class="op">,</span> worldData<span class="op">.</span><span class="at">objects</span><span class="op">.</span><span class="at">countries</span>)<span class="op">;</span></span>
<span id="cb16-729"><a href="#cb16-729" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-730"><a href="#cb16-730" aria-hidden="true" tabindex="-1"></a>  <span class="co">// In Observable, inputs are automatically reactive values</span></span>
<span id="cb16-731"><a href="#cb16-731" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> pointRadius <span class="op">=</span> point_size<span class="op">;</span></span>
<span id="cb16-732"><a href="#cb16-732" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mapProjection <span class="op">=</span> projection<span class="op">;</span></span>
<span id="cb16-733"><a href="#cb16-733" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-734"><a href="#cb16-734" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Validate that pointRadius is a proper number</span></span>
<span id="cb16-735"><a href="#cb16-735" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="pp">isNaN</span>(pointRadius) <span class="op">||</span> pointRadius <span class="op">&lt;=</span> <span class="dv">0</span>) {</span>
<span id="cb16-736"><a href="#cb16-736" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'Invalid point size detected:'</span><span class="op">,</span> point_size<span class="op">,</span> <span class="st">'using fallback:'</span><span class="op">,</span> <span class="fl">1.5</span>)<span class="op">;</span></span>
<span id="cb16-737"><a href="#cb16-737" aria-hidden="true" tabindex="-1"></a>    pointRadius <span class="op">=</span> <span class="fl">1.5</span><span class="op">;</span></span>
<span id="cb16-738"><a href="#cb16-738" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-739"><a href="#cb16-739" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-740"><a href="#cb16-740" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb16-741"><a href="#cb16-741" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="vs">`Geographic Distribution of </span><span class="sc">${</span>sample_stats<span class="op">.</span><span class="at">total</span><span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span><span class="vs"> Sample Points`</span><span class="op">,</span></span>
<span id="cb16-742"><a href="#cb16-742" aria-hidden="true" tabindex="-1"></a>    <span class="dt">projection</span><span class="op">:</span> mapProjection<span class="op">,</span></span>
<span id="cb16-743"><a href="#cb16-743" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb16-744"><a href="#cb16-744" aria-hidden="true" tabindex="-1"></a>      <span class="co">// World map outline</span></span>
<span id="cb16-745"><a href="#cb16-745" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">geo</span>(countries<span class="op">,</span> {</span>
<span id="cb16-746"><a href="#cb16-746" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"#f0f0f0"</span><span class="op">,</span></span>
<span id="cb16-747"><a href="#cb16-747" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"#ccc"</span><span class="op">,</span></span>
<span id="cb16-748"><a href="#cb16-748" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb16-749"><a href="#cb16-749" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb16-750"><a href="#cb16-750" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Sample points colored by source</span></span>
<span id="cb16-751"><a href="#cb16-751" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>(sample_data<span class="op">,</span> {</span>
<span id="cb16-752"><a href="#cb16-752" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"longitude"</span><span class="op">,</span></span>
<span id="cb16-753"><a href="#cb16-753" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"latitude"</span><span class="op">,</span></span>
<span id="cb16-754"><a href="#cb16-754" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"source_collection"</span><span class="op">,</span></span>
<span id="cb16-755"><a href="#cb16-755" aria-hidden="true" tabindex="-1"></a>        <span class="dt">r</span><span class="op">:</span> pointRadius<span class="op">,</span></span>
<span id="cb16-756"><a href="#cb16-756" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fillOpacity</span><span class="op">:</span> <span class="fl">0.7</span><span class="op">,</span></span>
<span id="cb16-757"><a href="#cb16-757" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb16-758"><a href="#cb16-758" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.2</span></span>
<span id="cb16-759"><a href="#cb16-759" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb16-760"><a href="#cb16-760" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb16-761"><a href="#cb16-761" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb16-762"><a href="#cb16-762" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb16-763"><a href="#cb16-763" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="st">"SESAR"</span><span class="op">,</span> <span class="st">"OPENCONTEXT"</span><span class="op">,</span> <span class="st">"GEOME"</span><span class="op">,</span> <span class="st">"SMITHSONIAN"</span>]<span class="op">,</span></span>
<span id="cb16-764"><a href="#cb16-764" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#3366cc"</span><span class="op">,</span> <span class="st">"#dc3912"</span><span class="op">,</span> <span class="st">"#109618"</span><span class="op">,</span> <span class="st">"#ff9900"</span>]</span>
<span id="cb16-765"><a href="#cb16-765" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb16-766"><a href="#cb16-766" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">900</span><span class="op">,</span></span>
<span id="cb16-767"><a href="#cb16-767" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb16-768"><a href="#cb16-768" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb16-769"><a href="#cb16-769" aria-hidden="true" tabindex="-1"></a>      <span class="dt">background</span><span class="op">:</span> <span class="st">"#f8f9fa"</span></span>
<span id="cb16-770"><a href="#cb16-770" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-771"><a href="#cb16-771" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb16-772"><a href="#cb16-772" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="world-map-1">
<div id="ojs-cell-16-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="world-map-2">
<div id="ojs-cell-16-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
</section>
<section id="material-category-analysis" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Material Category Analysis</h1>
<p>Explore the distribution of material categories across different sources.</p>
<div id="material-analysis" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" data-startfrom="784" data-source-offset="-124"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 783;"><span id="cb17-784"><a href="#cb17-784" aria-hidden="true" tabindex="-1"></a>material_data <span class="op">=</span> {</span>
<span id="cb17-785"><a href="#cb17-785" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb17-786"><a href="#cb17-786" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try pre-computed summaries first (2KB, instant)</span></span>
<span id="cb17-787"><a href="#cb17-787" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb17-788"><a href="#cb17-788" aria-hidden="true" tabindex="-1"></a><span class="vs">      SELECT</span></span>
<span id="cb17-789"><a href="#cb17-789" aria-hidden="true" tabindex="-1"></a><span class="vs">        facet_value as has_material_category,</span></span>
<span id="cb17-790"><a href="#cb17-790" aria-hidden="true" tabindex="-1"></a><span class="vs">        'ALL' as source_collection,</span></span>
<span id="cb17-791"><a href="#cb17-791" aria-hidden="true" tabindex="-1"></a><span class="vs">        count as category_count</span></span>
<span id="cb17-792"><a href="#cb17-792" aria-hidden="true" tabindex="-1"></a><span class="vs">      FROM read_parquet('</span><span class="sc">${</span>facet_summaries_url<span class="sc">}</span><span class="vs">')</span></span>
<span id="cb17-793"><a href="#cb17-793" aria-hidden="true" tabindex="-1"></a><span class="vs">      WHERE facet_type = 'material'</span></span>
<span id="cb17-794"><a href="#cb17-794" aria-hidden="true" tabindex="-1"></a><span class="vs">      ORDER BY count DESC</span></span>
<span id="cb17-795"><a href="#cb17-795" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb17-796"><a href="#cb17-796" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> ({</span>
<span id="cb17-797"><a href="#cb17-797" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>row<span class="op">,</span></span>
<span id="cb17-798"><a href="#cb17-798" aria-hidden="true" tabindex="-1"></a>      <span class="dt">category_count</span><span class="op">:</span> <span class="bu">Number</span>(row<span class="op">.</span><span class="at">category_count</span>)</span>
<span id="cb17-799"><a href="#cb17-799" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb17-800"><a href="#cb17-800" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (e) {</span>
<span id="cb17-801"><a href="#cb17-801" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">"Facet summaries unavailable, falling back to full scan:"</span><span class="op">,</span> e<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb17-802"><a href="#cb17-802" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb17-803"><a href="#cb17-803" aria-hidden="true" tabindex="-1"></a><span class="vs">      SELECT</span></span>
<span id="cb17-804"><a href="#cb17-804" aria-hidden="true" tabindex="-1"></a><span class="vs">        source_collection,</span></span>
<span id="cb17-805"><a href="#cb17-805" aria-hidden="true" tabindex="-1"></a><span class="vs">        has_material_category,</span></span>
<span id="cb17-806"><a href="#cb17-806" aria-hidden="true" tabindex="-1"></a><span class="vs">        count(*) as category_count</span></span>
<span id="cb17-807"><a href="#cb17-807" aria-hidden="true" tabindex="-1"></a><span class="vs">      FROM isamples_data</span></span>
<span id="cb17-808"><a href="#cb17-808" aria-hidden="true" tabindex="-1"></a><span class="vs">      WHERE has_material_category IS NOT NULL</span></span>
<span id="cb17-809"><a href="#cb17-809" aria-hidden="true" tabindex="-1"></a><span class="vs">      GROUP BY source_collection, has_material_category</span></span>
<span id="cb17-810"><a href="#cb17-810" aria-hidden="true" tabindex="-1"></a><span class="vs">      ORDER BY source_collection, category_count DESC</span></span>
<span id="cb17-811"><a href="#cb17-811" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb17-812"><a href="#cb17-812" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> ({</span>
<span id="cb17-813"><a href="#cb17-813" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>row<span class="op">,</span></span>
<span id="cb17-814"><a href="#cb17-814" aria-hidden="true" tabindex="-1"></a>      <span class="dt">category_count</span><span class="op">:</span> <span class="bu">Number</span>(row<span class="op">.</span><span class="at">category_count</span>)</span>
<span id="cb17-815"><a href="#cb17-815" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb17-816"><a href="#cb17-816" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-817"><a href="#cb17-817" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-818"><a href="#cb17-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-819"><a href="#cb17-819" aria-hidden="true" tabindex="-1"></a><span class="co">// Top categories from pre-computed summaries (instant)</span></span>
<span id="cb17-820"><a href="#cb17-820" aria-hidden="true" tabindex="-1"></a>top_categories <span class="op">=</span> {</span>
<span id="cb17-821"><a href="#cb17-821" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb17-822"><a href="#cb17-822" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb17-823"><a href="#cb17-823" aria-hidden="true" tabindex="-1"></a><span class="vs">      SELECT</span></span>
<span id="cb17-824"><a href="#cb17-824" aria-hidden="true" tabindex="-1"></a><span class="vs">        facet_value as has_material_category,</span></span>
<span id="cb17-825"><a href="#cb17-825" aria-hidden="true" tabindex="-1"></a><span class="vs">        count as total_count</span></span>
<span id="cb17-826"><a href="#cb17-826" aria-hidden="true" tabindex="-1"></a><span class="vs">      FROM read_parquet('</span><span class="sc">${</span>facet_summaries_url<span class="sc">}</span><span class="vs">')</span></span>
<span id="cb17-827"><a href="#cb17-827" aria-hidden="true" tabindex="-1"></a><span class="vs">      WHERE facet_type = 'material'</span></span>
<span id="cb17-828"><a href="#cb17-828" aria-hidden="true" tabindex="-1"></a><span class="vs">      ORDER BY count DESC</span></span>
<span id="cb17-829"><a href="#cb17-829" aria-hidden="true" tabindex="-1"></a><span class="vs">      LIMIT 10</span></span>
<span id="cb17-830"><a href="#cb17-830" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb17-831"><a href="#cb17-831" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> ({</span>
<span id="cb17-832"><a href="#cb17-832" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>row<span class="op">,</span></span>
<span id="cb17-833"><a href="#cb17-833" aria-hidden="true" tabindex="-1"></a>      <span class="dt">total_count</span><span class="op">:</span> <span class="bu">Number</span>(row<span class="op">.</span><span class="at">total_count</span>)</span>
<span id="cb17-834"><a href="#cb17-834" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb17-835"><a href="#cb17-835" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (e) {</span>
<span id="cb17-836"><a href="#cb17-836" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">"Facet summaries unavailable, falling back to full scan:"</span><span class="op">,</span> e<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb17-837"><a href="#cb17-837" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(<span class="vs">`</span></span>
<span id="cb17-838"><a href="#cb17-838" aria-hidden="true" tabindex="-1"></a><span class="vs">      SELECT</span></span>
<span id="cb17-839"><a href="#cb17-839" aria-hidden="true" tabindex="-1"></a><span class="vs">        has_material_category,</span></span>
<span id="cb17-840"><a href="#cb17-840" aria-hidden="true" tabindex="-1"></a><span class="vs">        count(*) as total_count</span></span>
<span id="cb17-841"><a href="#cb17-841" aria-hidden="true" tabindex="-1"></a><span class="vs">      FROM isamples_data</span></span>
<span id="cb17-842"><a href="#cb17-842" aria-hidden="true" tabindex="-1"></a><span class="vs">      WHERE has_material_category IS NOT NULL</span></span>
<span id="cb17-843"><a href="#cb17-843" aria-hidden="true" tabindex="-1"></a><span class="vs">      GROUP BY has_material_category</span></span>
<span id="cb17-844"><a href="#cb17-844" aria-hidden="true" tabindex="-1"></a><span class="vs">      ORDER BY total_count DESC</span></span>
<span id="cb17-845"><a href="#cb17-845" aria-hidden="true" tabindex="-1"></a><span class="vs">      LIMIT 10</span></span>
<span id="cb17-846"><a href="#cb17-846" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb17-847"><a href="#cb17-847" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> ({</span>
<span id="cb17-848"><a href="#cb17-848" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>row<span class="op">,</span></span>
<span id="cb17-849"><a href="#cb17-849" aria-hidden="true" tabindex="-1"></a>      <span class="dt">total_count</span><span class="op">:</span> <span class="bu">Number</span>(row<span class="op">.</span><span class="at">total_count</span>)</span>
<span id="cb17-850"><a href="#cb17-850" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb17-851"><a href="#cb17-851" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-852"><a href="#cb17-852" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="material-analysis-1">
<div id="ojs-cell-17-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="material-analysis-2">
<div id="ojs-cell-17-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div id="material-controls" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" data-startfrom="859" data-source-offset="-40"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 858;"><span id="cb18-859"><a href="#cb18-859" aria-hidden="true" tabindex="-1"></a>viewof selected_category <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(</span>
<span id="cb18-860"><a href="#cb18-860" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"All"</span><span class="op">,</span> <span class="op">...</span>top_categories<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">has_material_category</span>)]<span class="op">,</span></span>
<span id="cb18-861"><a href="#cb18-861" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb18-862"><a href="#cb18-862" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Focus on Category:"</span><span class="op">,</span></span>
<span id="cb18-863"><a href="#cb18-863" aria-hidden="true" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> <span class="st">"All"</span></span>
<span id="cb18-864"><a href="#cb18-864" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-865"><a href="#cb18-865" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-866"><a href="#cb18-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-867"><a href="#cb18-867" aria-hidden="true" tabindex="-1"></a><span class="co">// Filter material data</span></span>
<span id="cb18-868"><a href="#cb18-868" aria-hidden="true" tabindex="-1"></a>filtered_material_data <span class="op">=</span> selected_category <span class="op">===</span> <span class="st">"All"</span></span>
<span id="cb18-869"><a href="#cb18-869" aria-hidden="true" tabindex="-1"></a>  <span class="op">?</span> material_data</span>
<span id="cb18-870"><a href="#cb18-870" aria-hidden="true" tabindex="-1"></a>  <span class="op">:</span> material_data<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">has_material_category</span> <span class="op">===</span> selected_category)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="material-controls-1">
<div id="ojs-cell-18-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="material-controls-2">
<div id="ojs-cell-18-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div id="material-charts" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" data-startfrom="877" data-source-offset="-25"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 876;"><span id="cb19-877"><a href="#cb19-877" aria-hidden="true" tabindex="-1"></a>categories_chart <span class="op">=</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb19-878"><a href="#cb19-878" aria-hidden="true" tabindex="-1"></a>  <span class="dt">title</span><span class="op">:</span> <span class="st">"Top 10 Material Categories"</span><span class="op">,</span></span>
<span id="cb19-879"><a href="#cb19-879" aria-hidden="true" tabindex="-1"></a>  <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb19-880"><a href="#cb19-880" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Number of samples"</span><span class="op">,</span></span>
<span id="cb19-881"><a href="#cb19-881" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tickFormat</span><span class="op">:</span> <span class="st">"~s"</span></span>
<span id="cb19-882"><a href="#cb19-882" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb19-883"><a href="#cb19-883" aria-hidden="true" tabindex="-1"></a>  <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb19-884"><a href="#cb19-884" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">"Material Category"</span><span class="op">,</span></span>
<span id="cb19-885"><a href="#cb19-885" aria-hidden="true" tabindex="-1"></a>    <span class="dt">domain</span><span class="op">:</span> top_categories<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">has_material_category</span>)</span>
<span id="cb19-886"><a href="#cb19-886" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb19-887"><a href="#cb19-887" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb19-888"><a href="#cb19-888" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">barX</span>(top_categories<span class="op">,</span> {</span>
<span id="cb19-889"><a href="#cb19-889" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> <span class="st">"total_count"</span><span class="op">,</span></span>
<span id="cb19-890"><a href="#cb19-890" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> <span class="st">"has_material_category"</span><span class="op">,</span></span>
<span id="cb19-891"><a href="#cb19-891" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fill</span><span class="op">:</span> <span class="st">"coral"</span><span class="op">,</span></span>
<span id="cb19-892"><a href="#cb19-892" aria-hidden="true" tabindex="-1"></a>      <span class="dt">sort</span><span class="op">:</span> {<span class="dt">y</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">reverse</span><span class="op">:</span> <span class="kw">true</span>}</span>
<span id="cb19-893"><a href="#cb19-893" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb19-894"><a href="#cb19-894" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">text</span>(top_categories<span class="op">,</span> {</span>
<span id="cb19-895"><a href="#cb19-895" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> <span class="st">"total_count"</span><span class="op">,</span></span>
<span id="cb19-896"><a href="#cb19-896" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> <span class="st">"has_material_category"</span><span class="op">,</span></span>
<span id="cb19-897"><a href="#cb19-897" aria-hidden="true" tabindex="-1"></a>      <span class="dt">text</span><span class="op">:</span> d <span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">"~s"</span>)(d<span class="op">.</span><span class="at">total_count</span>)<span class="op">,</span></span>
<span id="cb19-898"><a href="#cb19-898" aria-hidden="true" tabindex="-1"></a>      <span class="dt">dx</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb19-899"><a href="#cb19-899" aria-hidden="true" tabindex="-1"></a>      <span class="dt">textAnchor</span><span class="op">:</span> <span class="st">"start"</span></span>
<span id="cb19-900"><a href="#cb19-900" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-901"><a href="#cb19-901" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb19-902"><a href="#cb19-902" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">150</span><span class="op">,</span></span>
<span id="cb19-903"><a href="#cb19-903" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="cb19-904"><a href="#cb19-904" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">700</span></span>
<span id="cb19-905"><a href="#cb19-905" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-906"><a href="#cb19-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-907"><a href="#cb19-907" aria-hidden="true" tabindex="-1"></a><span class="co">// Material by source chart</span></span>
<span id="cb19-908"><a href="#cb19-908" aria-hidden="true" tabindex="-1"></a>material_by_source_chart <span class="op">=</span> {</span>
<span id="cb19-909"><a href="#cb19-909" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Validate that data is available</span></span>
<span id="cb19-910"><a href="#cb19-910" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(material_data) <span class="op">||</span> <span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(top_categories)) {</span>
<span id="cb19-911"><a href="#cb19-911" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Error: Material data is not available&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb19-912"><a href="#cb19-912" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-913"><a href="#cb19-913" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-914"><a href="#cb19-914" aria-hidden="true" tabindex="-1"></a>  <span class="co">// In Observable, inputs are automatically reactive values</span></span>
<span id="cb19-915"><a href="#cb19-915" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> currentCategory <span class="op">=</span> selected_category<span class="op">;</span></span>
<span id="cb19-916"><a href="#cb19-916" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-917"><a href="#cb19-917" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Filter the data based on selection</span></span>
<span id="cb19-918"><a href="#cb19-918" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> chartData<span class="op">;</span></span>
<span id="cb19-919"><a href="#cb19-919" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (currentCategory <span class="op">===</span> <span class="st">"All"</span>) {</span>
<span id="cb19-920"><a href="#cb19-920" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For "All", show top 10 categories across all sources</span></span>
<span id="cb19-921"><a href="#cb19-921" aria-hidden="true" tabindex="-1"></a>    chartData <span class="op">=</span> material_data<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> </span>
<span id="cb19-922"><a href="#cb19-922" aria-hidden="true" tabindex="-1"></a>      top_categories<span class="op">.</span><span class="fu">map</span>(c <span class="kw">=&gt;</span> c<span class="op">.</span><span class="at">has_material_category</span>)<span class="op">.</span><span class="fu">includes</span>(d<span class="op">.</span><span class="at">has_material_category</span>)</span>
<span id="cb19-923"><a href="#cb19-923" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb19-924"><a href="#cb19-924" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb19-925"><a href="#cb19-925" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For specific category, show by source collection</span></span>
<span id="cb19-926"><a href="#cb19-926" aria-hidden="true" tabindex="-1"></a>    chartData <span class="op">=</span> material_data<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">has_material_category</span> <span class="op">===</span> currentCategory)<span class="op">;</span></span>
<span id="cb19-927"><a href="#cb19-927" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-928"><a href="#cb19-928" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-929"><a href="#cb19-929" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If no data, return early with a message</span></span>
<span id="cb19-930"><a href="#cb19-930" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (chartData<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb19-931"><a href="#cb19-931" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;No data available for selected category: </span><span class="sc">${</span>currentCategory<span class="sc">}</span><span class="vs">&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb19-932"><a href="#cb19-932" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-933"><a href="#cb19-933" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-934"><a href="#cb19-934" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb19-935"><a href="#cb19-935" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> currentCategory <span class="op">===</span> <span class="st">"All"</span> </span>
<span id="cb19-936"><a href="#cb19-936" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> <span class="st">"Material Categories by Source Collection"</span> </span>
<span id="cb19-937"><a href="#cb19-937" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>currentCategory<span class="sc">}</span><span class="vs"> by Source Collection`</span><span class="op">,</span></span>
<span id="cb19-938"><a href="#cb19-938" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb19-939"><a href="#cb19-939" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Number of samples"</span><span class="op">,</span></span>
<span id="cb19-940"><a href="#cb19-940" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tickFormat</span><span class="op">:</span> <span class="st">"~s"</span></span>
<span id="cb19-941"><a href="#cb19-941" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb19-942"><a href="#cb19-942" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb19-943"><a href="#cb19-943" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> currentCategory <span class="op">===</span> <span class="st">"All"</span> <span class="op">?</span> <span class="st">"Material Category"</span> <span class="op">:</span> <span class="st">"Source Collection"</span></span>
<span id="cb19-944"><a href="#cb19-944" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb19-945"><a href="#cb19-945" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb19-946"><a href="#cb19-946" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb19-947"><a href="#cb19-947" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="st">"SESAR"</span><span class="op">,</span> <span class="st">"OPENCONTEXT"</span><span class="op">,</span> <span class="st">"GEOME"</span><span class="op">,</span> <span class="st">"SMITHSONIAN"</span>]<span class="op">,</span></span>
<span id="cb19-948"><a href="#cb19-948" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#3366cc"</span><span class="op">,</span> <span class="st">"#dc3912"</span><span class="op">,</span> <span class="st">"#109618"</span><span class="op">,</span> <span class="st">"#ff9900"</span>]</span>
<span id="cb19-949"><a href="#cb19-949" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb19-950"><a href="#cb19-950" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb19-951"><a href="#cb19-951" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">barX</span>(chartData<span class="op">,</span> {</span>
<span id="cb19-952"><a href="#cb19-952" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"category_count"</span><span class="op">,</span></span>
<span id="cb19-953"><a href="#cb19-953" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> currentCategory <span class="op">===</span> <span class="st">"All"</span> <span class="op">?</span> <span class="st">"has_material_category"</span> <span class="op">:</span> <span class="st">"source_collection"</span><span class="op">,</span></span>
<span id="cb19-954"><a href="#cb19-954" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"source_collection"</span><span class="op">,</span></span>
<span id="cb19-955"><a href="#cb19-955" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sort</span><span class="op">:</span> {<span class="dt">y</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">reverse</span><span class="op">:</span> <span class="kw">true</span>}</span>
<span id="cb19-956"><a href="#cb19-956" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb19-957"><a href="#cb19-957" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb19-958"><a href="#cb19-958" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">150</span><span class="op">,</span></span>
<span id="cb19-959"><a href="#cb19-959" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="dv">250</span><span class="op">,</span> chartData<span class="op">.</span><span class="at">length</span> <span class="op">*</span> <span class="dv">20</span>)<span class="op">,</span></span>
<span id="cb19-960"><a href="#cb19-960" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">700</span></span>
<span id="cb19-961"><a href="#cb19-961" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb19-962"><a href="#cb19-962" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="material-charts-1">
<div id="ojs-cell-19-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="material-charts-2">
<div id="ojs-cell-19-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
</section>
<section id="performance-summary" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Performance Summary</h1>
<p>This browser-based approach demonstrates remarkable efficiency compared to traditional methods.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" data-startfrom="970" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 969;"><span id="cb20-970"><a href="#cb20-970" aria-hidden="true" tabindex="-1"></a><span class="fu">md</span><span class="vs">`</span></span>
<span id="cb20-971"><a href="#cb20-971" aria-hidden="true" tabindex="-1"></a><span class="vs"># Performance Analysis</span></span>
<span id="cb20-972"><a href="#cb20-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-973"><a href="#cb20-973" aria-hidden="true" tabindex="-1"></a><span class="vs">## Browser-Based vs Traditional Approaches</span></span>
<span id="cb20-974"><a href="#cb20-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-975"><a href="#cb20-975" aria-hidden="true" tabindex="-1"></a><span class="vs">| Approach | Time | Memory | Data Transfer | Environment |</span></span>
<span id="cb20-976"><a href="#cb20-976" aria-hidden="true" tabindex="-1"></a><span class="vs">|----------|------|--------|---------------|-------------|</span></span>
<span id="cb20-977"><a href="#cb20-977" aria-hidden="true" tabindex="-1"></a><span class="vs">| **Traditional (pandas)** | 40-150s | 600-1200 MB | 300 MB | Local Python |</span></span>
<span id="cb20-978"><a href="#cb20-978" aria-hidden="true" tabindex="-1"></a><span class="vs">| **Our browser approach** | 10-30s | &lt;100 MB | &lt;5 KB + samples | Any browser |</span></span>
<span id="cb20-979"><a href="#cb20-979" aria-hidden="true" tabindex="-1"></a><span class="vs">| **Improvement** | **~5x faster** | **~10x less memory** | **~99% less transfer** | **Universal** |</span></span>
<span id="cb20-980"><a href="#cb20-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-981"><a href="#cb20-981" aria-hidden="true" tabindex="-1"></a><span class="vs">## Key Benefits</span></span>
<span id="cb20-982"><a href="#cb20-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-983"><a href="#cb20-983" aria-hidden="true" tabindex="-1"></a><span class="vs">‚úÖ **Universal Access**: Runs in any modern browser  </span></span>
<span id="cb20-984"><a href="#cb20-984" aria-hidden="true" tabindex="-1"></a><span class="vs">‚úÖ **Memory Efficient**: Analyze 300MB datasets using &lt;100MB browser memory  </span></span>
<span id="cb20-985"><a href="#cb20-985" aria-hidden="true" tabindex="-1"></a><span class="vs">‚úÖ **Fast**: Instant metadata queries, efficient sampling  </span></span>
<span id="cb20-986"><a href="#cb20-986" aria-hidden="true" tabindex="-1"></a><span class="vs">‚úÖ **Interactive**: Real-time parameter adjustment and visualization  </span></span>
<span id="cb20-987"><a href="#cb20-987" aria-hidden="true" tabindex="-1"></a><span class="vs">‚úÖ **Scalable**: Same approach works for GB or TB datasets  </span></span>
<span id="cb20-988"><a href="#cb20-988" aria-hidden="true" tabindex="-1"></a><span class="vs">‚úÖ **Reproducible**: Self-contained analysis with no local setup required</span></span>
<span id="cb20-989"><a href="#cb20-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-990"><a href="#cb20-990" aria-hidden="true" tabindex="-1"></a><span class="vs">## Technical Achievements</span></span>
<span id="cb20-991"><a href="#cb20-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-992"><a href="#cb20-992" aria-hidden="true" tabindex="-1"></a><span class="vs">- **HTTP Range Requests**: Only downloads needed data portions</span></span>
<span id="cb20-993"><a href="#cb20-993" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Columnar Processing**: Parquet format enables efficient column-wise operations  </span></span>
<span id="cb20-994"><a href="#cb20-994" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Lazy Evaluation**: Queries are optimized before execution</span></span>
<span id="cb20-995"><a href="#cb20-995" aria-hidden="true" tabindex="-1"></a><span class="vs">- **In-Browser Analytics**: Full analytical database running in JavaScript</span></span>
<span id="cb20-996"><a href="#cb20-996" aria-hidden="true" tabindex="-1"></a><span class="vs">- **Interactive Visualization**: Real-time exploration with Observable Plot</span></span>
<span id="cb20-997"><a href="#cb20-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-998"><a href="#cb20-998" aria-hidden="true" tabindex="-1"></a><span class="vs">This approach enables **big data analysis in any browser** and makes large-scale geospatial analysis universally accessible! üåç</span></span>
<span id="cb20-999"><a href="#cb20-999" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="performance-summary" class="cell-output cell-output-display">
<div id="ojs-cell-20" data-nodetype="expression">

</div>
</div>
</div>
</section>
<section id="additional-resources" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Additional Resources</h1>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" data-startfrom="1007" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1006;"><span id="cb21-1007"><a href="#cb21-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">md</span><span class="vs">`</span></span>
<span id="cb21-1008"><a href="#cb21-1008" aria-hidden="true" tabindex="-1"></a><span class="vs">## üìö Learn More</span></span>
<span id="cb21-1009"><a href="#cb21-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1010"><a href="#cb21-1010" aria-hidden="true" tabindex="-1"></a><span class="vs">- [DuckDB-WASM Documentation](https://duckdb.org/docs/api/wasm/)</span></span>
<span id="cb21-1011"><a href="#cb21-1011" aria-hidden="true" tabindex="-1"></a><span class="vs">- [Observable Plot](https://observablehq.com/plot/)</span></span>
<span id="cb21-1012"><a href="#cb21-1012" aria-hidden="true" tabindex="-1"></a><span class="vs">- [Observable Inputs](https://observablehq.com/@observablehq/inputs)</span></span>
<span id="cb21-1013"><a href="#cb21-1013" aria-hidden="true" tabindex="-1"></a><span class="vs">- [GeoParquet Specification](https://geoparquet.org/)</span></span>
<span id="cb21-1014"><a href="#cb21-1014" aria-hidden="true" tabindex="-1"></a><span class="vs">- [HTTP Range Requests](https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests)</span></span>
<span id="cb21-1015"><a href="#cb21-1015" aria-hidden="true" tabindex="-1"></a><span class="vs">- [iSamples Project](https://www.isamples.org/)</span></span>
<span id="cb21-1016"><a href="#cb21-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1017"><a href="#cb21-1017" aria-hidden="true" tabindex="-1"></a><span class="vs">## üîß Technical Implementation</span></span>
<span id="cb21-1018"><a href="#cb21-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1019"><a href="#cb21-1019" aria-hidden="true" tabindex="-1"></a><span class="vs">This notebook demonstrates how to:</span></span>
<span id="cb21-1020"><a href="#cb21-1020" aria-hidden="true" tabindex="-1"></a><span class="vs">1. Connect to remote Parquet files using DuckDB-WASM</span></span>
<span id="cb21-1021"><a href="#cb21-1021" aria-hidden="true" tabindex="-1"></a><span class="vs">2. Perform efficient metadata-only queries</span></span>
<span id="cb21-1022"><a href="#cb21-1022" aria-hidden="true" tabindex="-1"></a><span class="vs">3. Create stratified samples for visualization</span></span>
<span id="cb21-1023"><a href="#cb21-1023" aria-hidden="true" tabindex="-1"></a><span class="vs">4. Build interactive controls and visualizations</span></span>
<span id="cb21-1024"><a href="#cb21-1024" aria-hidden="true" tabindex="-1"></a><span class="vs">5. Achieve high performance with minimal data transfer</span></span>
<span id="cb21-1025"><a href="#cb21-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1026"><a href="#cb21-1026" aria-hidden="true" tabindex="-1"></a><span class="vs">The complete workflow enables sophisticated data analysis directly in the browser without any local software installation or large file downloads.</span></span>
<span id="cb21-1027"><a href="#cb21-1027" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="resources" class="cell-output cell-output-display">
<div id="ojs-cell-21" data-nodetype="expression">

</div>
</div>
</div>
</section>
<section id="viewport-map-with-graceful-degradation-deck.gl-duckdb-wasm" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> üîç Viewport Map with Graceful Degradation (deck.gl ‚ÜîÔ∏é DuckDB-WASM)</h1>
<div id="map-libs" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" data-startfrom="1037" data-source-offset="-20"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1036;"><span id="cb22-1037"><a href="#cb22-1037" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb22-1038"><a href="#cb22-1038" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> link <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"link"</span>)<span class="op">;</span></span>
<span id="cb22-1039"><a href="#cb22-1039" aria-hidden="true" tabindex="-1"></a>  link<span class="op">.</span><span class="at">rel</span> <span class="op">=</span> <span class="st">"stylesheet"</span><span class="op">;</span></span>
<span id="cb22-1040"><a href="#cb22-1040" aria-hidden="true" tabindex="-1"></a>  link<span class="op">.</span><span class="at">href</span> <span class="op">=</span> <span class="st">"https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"</span><span class="op">;</span></span>
<span id="cb22-1041"><a href="#cb22-1041" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">head</span><span class="op">.</span><span class="fu">appendChild</span>(link)<span class="op">;</span></span>
<span id="cb22-1042"><a href="#cb22-1042" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="map-libs-1">
<div id="ojs-cell-22-1" data-nodetype="expression">

</div>
</div>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" data-startfrom="1045" data-source-offset="-273"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1044;"><span id="cb23-1045"><a href="#cb23-1045" aria-hidden="true" tabindex="-1"></a>maplibregl <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(<span class="st">"https://cdn.skypack.dev/maplibre-gl@3?min"</span>)</span>
<span id="cb23-1046"><a href="#cb23-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1047"><a href="#cb23-1047" aria-hidden="true" tabindex="-1"></a><span class="co">// For now, we'll skip deck.gl due to luma.gl dependency issues</span></span>
<span id="cb23-1048"><a href="#cb23-1048" aria-hidden="true" tabindex="-1"></a><span class="co">// and just show the map without WebGL overlays</span></span>
<span id="cb23-1049"><a href="#cb23-1049" aria-hidden="true" tabindex="-1"></a>decklib <span class="op">=</span> <span class="kw">null</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="map-libs-2">
<div id="ojs-cell-22-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="map-libs-3">
<div id="ojs-cell-22-3" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" data-startfrom="1053" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1052;"><span id="cb24-1053"><a href="#cb24-1053" aria-hidden="true" tabindex="-1"></a>MAPCFG <span class="op">=</span> ({</span>
<span id="cb24-1054"><a href="#cb24-1054" aria-hidden="true" tabindex="-1"></a>  <span class="dt">center</span><span class="op">:</span> [<span class="fl">20.0</span><span class="op">,</span> <span class="fl">45.0</span>]<span class="op">,</span> <span class="co">// Centered to include Italy and Israel</span></span>
<span id="cb24-1055"><a href="#cb24-1055" aria-hidden="true" tabindex="-1"></a>  <span class="dt">zoom</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="co">// Zoomed out one level</span></span>
<span id="cb24-1056"><a href="#cb24-1056" aria-hidden="true" tabindex="-1"></a>  <span class="dt">minZoom</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb24-1057"><a href="#cb24-1057" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxZoom</span><span class="op">:</span> <span class="dv">17</span><span class="op">,</span></span>
<span id="cb24-1058"><a href="#cb24-1058" aria-hidden="true" tabindex="-1"></a>  <span class="dt">basemap</span><span class="op">:</span> <span class="st">"https://basemaps.cartocdn.com/gl/positron-gl-style/style.json"</span><span class="op">,</span></span>
<span id="cb24-1059"><a href="#cb24-1059" aria-hidden="true" tabindex="-1"></a>  <span class="dt">pointColor</span><span class="op">:</span> [<span class="dv">20</span><span class="op">,</span><span class="dv">110</span><span class="op">,</span><span class="dv">180</span><span class="op">,</span><span class="dv">200</span>]<span class="op">,</span></span>
<span id="cb24-1060"><a href="#cb24-1060" aria-hidden="true" tabindex="-1"></a>  <span class="dt">pointRadiusPx</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb24-1061"><a href="#cb24-1061" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPerTileHard</span><span class="op">:</span> sample_limit_value<span class="op">,</span> <span class="co">// Dynamic sample limit from controls</span></span>
<span id="cb24-1062"><a href="#cb24-1062" aria-hidden="true" tabindex="-1"></a>  <span class="fu">modulusByZoom</span>(z){</span>
<span id="cb24-1063"><a href="#cb24-1063" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (z <span class="op">&gt;=</span> <span class="dv">13</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb24-1064"><a href="#cb24-1064" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (z <span class="op">&gt;=</span> <span class="dv">11</span>) <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb24-1065"><a href="#cb24-1065" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (z <span class="op">&gt;=</span> <span class="dv">9</span> ) <span class="cf">return</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb24-1066"><a href="#cb24-1066" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (z <span class="op">&gt;=</span> <span class="dv">7</span> ) <span class="cf">return</span> <span class="dv">32</span><span class="op">;</span></span>
<span id="cb24-1067"><a href="#cb24-1067" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (z <span class="op">&gt;=</span> <span class="dv">5</span> ) <span class="cf">return</span> <span class="dv">128</span><span class="op">;</span></span>
<span id="cb24-1068"><a href="#cb24-1068" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">512</span><span class="op">;</span></span>
<span id="cb24-1069"><a href="#cb24-1069" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb24-1070"><a href="#cb24-1070" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aggDegByZoom</span>(z){</span>
<span id="cb24-1071"><a href="#cb24-1071" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (z <span class="op">&gt;=</span> <span class="dv">11</span>) <span class="cf">return</span> <span class="fl">0.05</span><span class="op">;</span></span>
<span id="cb24-1072"><a href="#cb24-1072" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (z <span class="op">&gt;=</span> <span class="dv">9</span> ) <span class="cf">return</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb24-1073"><a href="#cb24-1073" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (z <span class="op">&gt;=</span> <span class="dv">7</span> ) <span class="cf">return</span> <span class="fl">0.25</span><span class="op">;</span></span>
<span id="cb24-1074"><a href="#cb24-1074" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (z <span class="op">&gt;=</span> <span class="dv">5</span> ) <span class="cf">return</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb24-1075"><a href="#cb24-1075" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb24-1076"><a href="#cb24-1076" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-1077"><a href="#cb24-1077" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="map-config" class="cell-output cell-output-display">
<div id="ojs-cell-23" data-nodetype="declaration">

</div>
</div>
</div>
<div id="viewport-sampling-controls" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" data-startfrom="1085" data-source-offset="-41"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1084;"><span id="cb25-1085"><a href="#cb25-1085" aria-hidden="true" tabindex="-1"></a>viewof sample_limit <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">text</span>({</span>
<span id="cb25-1086"><a href="#cb25-1086" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">"Viewport Sample Limit:"</span><span class="op">,</span></span>
<span id="cb25-1087"><a href="#cb25-1087" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">"20000"</span><span class="op">,</span></span>
<span id="cb25-1088"><a href="#cb25-1088" aria-hidden="true" tabindex="-1"></a>  <span class="dt">placeholder</span><span class="op">:</span> <span class="st">"Enter number (works reliably up to ~1M)"</span></span>
<span id="cb25-1089"><a href="#cb25-1089" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb25-1090"><a href="#cb25-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-1091"><a href="#cb25-1091" aria-hidden="true" tabindex="-1"></a><span class="co">// Convert to number with validation</span></span>
<span id="cb25-1092"><a href="#cb25-1092" aria-hidden="true" tabindex="-1"></a>sample_limit_value <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="dv">1</span><span class="op">,</span> <span class="pp">parseInt</span>(sample_limit) <span class="op">||</span> <span class="dv">20000</span>)</span>
<span id="cb25-1093"><a href="#cb25-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-1094"><a href="#cb25-1094" aria-hidden="true" tabindex="-1"></a><span class="co">// Display current sample limit</span></span>
<span id="cb25-1095"><a href="#cb25-1095" aria-hidden="true" tabindex="-1"></a><span class="fu">md</span><span class="vs">`**Current viewport sample limit**: </span><span class="sc">${</span>sample_limit_value<span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span><span class="vs"> samples per viewport</span></span>
<span id="cb25-1096"><a href="#cb25-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-1097"><a href="#cb25-1097" aria-hidden="true" tabindex="-1"></a><span class="vs">*Note: Performance tested up to ~1M samples. For larger datasets, need more scalable approach (e.g., lonboard/deck.gl optimization)*`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="viewport-sampling-controls-1">
<div id="ojs-cell-24-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="viewport-sampling-controls-2">
<div id="ojs-cell-24-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="viewport-sampling-controls-3">
<div id="ojs-cell-24-3" data-nodetype="expression">

</div>
</div>
</div>
</div>
<div id="map-capability" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" data-startfrom="1102" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1101;"><span id="cb26-1102"><a href="#cb26-1102" aria-hidden="true" tabindex="-1"></a>pickMode <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb26-1103"><a href="#cb26-1103" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> c <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"canvas"</span>)<span class="op">;</span></span>
<span id="cb26-1104"><a href="#cb26-1104" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> gl2 <span class="op">=</span> c<span class="op">.</span><span class="fu">getContext</span>(<span class="st">"webgl2"</span><span class="op">,</span> {<span class="dt">antialias</span><span class="op">:</span><span class="kw">false</span>})<span class="op">;</span></span>
<span id="cb26-1105"><a href="#cb26-1105" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (gl2) <span class="cf">return</span> <span class="st">"full"</span><span class="op">;</span></span>
<span id="cb26-1106"><a href="#cb26-1106" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> gl <span class="op">=</span> c<span class="op">.</span><span class="fu">getContext</span>(<span class="st">"webgl"</span><span class="op">,</span> {<span class="dt">antialias</span><span class="op">:</span><span class="kw">false</span>})<span class="op">;</span></span>
<span id="cb26-1107"><a href="#cb26-1107" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>gl) <span class="cf">return</span> <span class="st">"raster"</span><span class="op">;</span></span>
<span id="cb26-1108"><a href="#cb26-1108" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ext <span class="op">=</span> gl<span class="op">.</span><span class="fu">getExtension</span>(<span class="st">"WEBGL_debug_renderer_info"</span>)<span class="op">;</span></span>
<span id="cb26-1109"><a href="#cb26-1109" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> r <span class="op">=</span> ext <span class="op">?</span> gl<span class="op">.</span><span class="fu">getParameter</span>(ext<span class="op">.</span><span class="at">UNMASKED_RENDERER_WEBGL</span>) <span class="op">:</span> <span class="st">""</span><span class="op">;</span></span>
<span id="cb26-1110"><a href="#cb26-1110" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> low <span class="op">=</span> <span class="ss">/swiftshader</span><span class="sc">|</span><span class="ss">llvmpipe</span><span class="sc">|</span><span class="ss">software/i</span><span class="op">.</span><span class="fu">test</span>(r) <span class="op">||</span> gl<span class="op">.</span><span class="fu">getParameter</span>(gl<span class="op">.</span><span class="at">MAX_TEXTURE_SIZE</span>) <span class="op">&lt;</span> <span class="dv">4096</span><span class="op">;</span></span>
<span id="cb26-1111"><a href="#cb26-1111" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> low <span class="op">?</span> <span class="st">"raster"</span> <span class="op">:</span> <span class="st">"lite"</span><span class="op">;</span></span>
<span id="cb26-1112"><a href="#cb26-1112" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-1113"><a href="#cb26-1113" aria-hidden="true" tabindex="-1"></a>MODE <span class="op">=</span> <span class="fu">pickMode</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="map-capability-1">
<div id="ojs-cell-25-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="map-capability-2">
<div id="ojs-cell-25-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" data-startfrom="1117" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1116;"><span id="cb27-1117"><a href="#cb27-1117" aria-hidden="true" tabindex="-1"></a><span class="fu">html</span><span class="vs">`</span></span>
<span id="cb27-1118"><a href="#cb27-1118" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;div style="position:relative;"&gt;</span></span>
<span id="cb27-1119"><a href="#cb27-1119" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;div id="map" style="height: 70vh; width: 100%;"&gt;&lt;/div&gt;</span></span>
<span id="cb27-1120"><a href="#cb27-1120" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;div id="mode-badge" style="position:absolute;top:8px;left:8px;background:#fff;border-radius:6px;padding:4px 8px;font:12px system-ui;"&gt;</span></span>
<span id="cb27-1121"><a href="#cb27-1121" aria-hidden="true" tabindex="-1"></a><span class="vs">    Mode: &lt;b&gt;</span><span class="sc">${</span>MODE<span class="sc">}</span><span class="vs">&lt;/b&gt; </span><span class="sc">${</span>working_parquet_url <span class="op">?</span> <span class="st">""</span> <span class="op">:</span> <span class="st">"(demo data)"</span><span class="sc">}</span></span>
<span id="cb27-1122"><a href="#cb27-1122" aria-hidden="true" tabindex="-1"></a><span class="vs">  &lt;/div&gt;</span></span>
<span id="cb27-1123"><a href="#cb27-1123" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;/div&gt;`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="map-container" class="cell-output cell-output-display">
<div id="ojs-cell-26" data-nodetype="expression">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28" data-startfrom="1128" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1127;"><span id="cb28-1128"><a href="#cb28-1128" aria-hidden="true" tabindex="-1"></a>viewport <span class="op">=</span> {</span>
<span id="cb28-1129"><a href="#cb28-1129" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> <span class="bu">Map</span> <span class="op">=</span> maplibregl<span class="op">.</span><span class="at">default</span><span class="op">?.</span><span class="at">Map</span> <span class="op">||</span> maplibregl<span class="op">.</span><span class="at">Map</span><span class="op">;</span></span>
<span id="cb28-1130"><a href="#cb28-1130" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> NavigationControl <span class="op">=</span> maplibregl<span class="op">.</span><span class="at">default</span><span class="op">?.</span><span class="at">NavigationControl</span> <span class="op">||</span> maplibregl<span class="op">.</span><span class="at">NavigationControl</span><span class="op">;</span></span>
<span id="cb28-1131"><a href="#cb28-1131" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="bu">Map</span>) {</span>
<span id="cb28-1132"><a href="#cb28-1132" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"MapLibre GL not loaded properly:"</span><span class="op">,</span> maplibregl)<span class="op">;</span></span>
<span id="cb28-1133"><a href="#cb28-1133" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Available keys:"</span><span class="op">,</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(maplibregl))<span class="op">;</span></span>
<span id="cb28-1134"><a href="#cb28-1134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">"MapLibre GL Map class failed to load"</span>)<span class="op">;</span></span>
<span id="cb28-1135"><a href="#cb28-1135" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1136"><a href="#cb28-1136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1137"><a href="#cb28-1137" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Wait for DOM container to be available</span></span>
<span id="cb28-1138"><a href="#cb28-1138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve) <span class="kw">=&gt;</span> {</span>
<span id="cb28-1139"><a href="#cb28-1139" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">waitForContainer</span>() {</span>
<span id="cb28-1140"><a href="#cb28-1140" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> container <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"map"</span>)<span class="op">;</span></span>
<span id="cb28-1141"><a href="#cb28-1141" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (container) {</span>
<span id="cb28-1142"><a href="#cb28-1142" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> map <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>({</span>
<span id="cb28-1143"><a href="#cb28-1143" aria-hidden="true" tabindex="-1"></a>          <span class="dt">container</span><span class="op">:</span> <span class="st">"map"</span><span class="op">,</span></span>
<span id="cb28-1144"><a href="#cb28-1144" aria-hidden="true" tabindex="-1"></a>          <span class="dt">style</span><span class="op">:</span> MAPCFG<span class="op">.</span><span class="at">basemap</span><span class="op">,</span></span>
<span id="cb28-1145"><a href="#cb28-1145" aria-hidden="true" tabindex="-1"></a>          <span class="dt">center</span><span class="op">:</span> MAPCFG<span class="op">.</span><span class="at">center</span><span class="op">,</span></span>
<span id="cb28-1146"><a href="#cb28-1146" aria-hidden="true" tabindex="-1"></a>          <span class="dt">zoom</span><span class="op">:</span> MAPCFG<span class="op">.</span><span class="at">zoom</span><span class="op">,</span></span>
<span id="cb28-1147"><a href="#cb28-1147" aria-hidden="true" tabindex="-1"></a>          <span class="dt">minZoom</span><span class="op">:</span> MAPCFG<span class="op">.</span><span class="at">minZoom</span><span class="op">,</span></span>
<span id="cb28-1148"><a href="#cb28-1148" aria-hidden="true" tabindex="-1"></a>          <span class="dt">maxZoom</span><span class="op">:</span> MAPCFG<span class="op">.</span><span class="at">maxZoom</span><span class="op">,</span></span>
<span id="cb28-1149"><a href="#cb28-1149" aria-hidden="true" tabindex="-1"></a>          <span class="dt">attributionControl</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb28-1150"><a href="#cb28-1150" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb28-1151"><a href="#cb28-1151" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">addControl</span>(<span class="kw">new</span> <span class="fu">NavigationControl</span>({<span class="dt">visualizePitch</span><span class="op">:</span><span class="kw">true</span>}))<span class="op">;</span></span>
<span id="cb28-1152"><a href="#cb28-1152" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1153"><a href="#cb28-1153" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store map instance globally for deck.gl access</span></span>
<span id="cb28-1154"><a href="#cb28-1154" aria-hidden="true" tabindex="-1"></a>        <span class="bu">window</span><span class="op">.</span><span class="at">_observableMap</span> <span class="op">=</span> map<span class="op">;</span></span>
<span id="cb28-1155"><a href="#cb28-1155" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1156"><a href="#cb28-1156" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> observable <span class="op">=</span> Generators<span class="op">.</span><span class="fu">observe</span>((notify) <span class="kw">=&gt;</span> {</span>
<span id="cb28-1157"><a href="#cb28-1157" aria-hidden="true" tabindex="-1"></a>          <span class="kw">function</span> <span class="fu">emit</span>() {</span>
<span id="cb28-1158"><a href="#cb28-1158" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> c <span class="op">=</span> map<span class="op">.</span><span class="fu">getCenter</span>()<span class="op">;</span></span>
<span id="cb28-1159"><a href="#cb28-1159" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> z <span class="op">=</span> map<span class="op">.</span><span class="fu">getZoom</span>()<span class="op">;</span></span>
<span id="cb28-1160"><a href="#cb28-1160" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> b <span class="op">=</span> map<span class="op">.</span><span class="fu">getBounds</span>()<span class="op">;</span></span>
<span id="cb28-1161"><a href="#cb28-1161" aria-hidden="true" tabindex="-1"></a>            <span class="fu">notify</span>({</span>
<span id="cb28-1162"><a href="#cb28-1162" aria-hidden="true" tabindex="-1"></a>              <span class="dt">center</span><span class="op">:</span> [c<span class="op">.</span><span class="at">lng</span><span class="op">,</span> c<span class="op">.</span><span class="at">lat</span>]<span class="op">,</span></span>
<span id="cb28-1163"><a href="#cb28-1163" aria-hidden="true" tabindex="-1"></a>              <span class="dt">zoom</span><span class="op">:</span> z<span class="op">,</span></span>
<span id="cb28-1164"><a href="#cb28-1164" aria-hidden="true" tabindex="-1"></a>              <span class="dt">bounds</span><span class="op">:</span> [b<span class="op">.</span><span class="fu">getWest</span>()<span class="op">,</span> b<span class="op">.</span><span class="fu">getSouth</span>()<span class="op">,</span> b<span class="op">.</span><span class="fu">getEast</span>()<span class="op">,</span> b<span class="op">.</span><span class="fu">getNorth</span>()]<span class="op">,</span></span>
<span id="cb28-1165"><a href="#cb28-1165" aria-hidden="true" tabindex="-1"></a>              <span class="dt">map</span><span class="op">:</span> map <span class="co">// Include map reference</span></span>
<span id="cb28-1166"><a href="#cb28-1166" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb28-1167"><a href="#cb28-1167" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb28-1168"><a href="#cb28-1168" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> onMove <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb28-1169"><a href="#cb28-1169" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (emit<span class="op">.</span><span class="at">_t</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb28-1170"><a href="#cb28-1170" aria-hidden="true" tabindex="-1"></a>            emit<span class="op">.</span><span class="at">_t</span> <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> { <span class="fu">emit</span>()<span class="op">;</span> emit<span class="op">.</span><span class="at">_t</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span> }<span class="op">,</span> <span class="dv">120</span>)<span class="op">;</span></span>
<span id="cb28-1171"><a href="#cb28-1171" aria-hidden="true" tabindex="-1"></a>          }<span class="op">;</span></span>
<span id="cb28-1172"><a href="#cb28-1172" aria-hidden="true" tabindex="-1"></a>          map<span class="op">.</span><span class="fu">on</span>(<span class="st">"load"</span><span class="op">,</span> emit)<span class="op">;</span></span>
<span id="cb28-1173"><a href="#cb28-1173" aria-hidden="true" tabindex="-1"></a>          map<span class="op">.</span><span class="fu">on</span>(<span class="st">"move"</span><span class="op">,</span> onMove)<span class="op">;</span></span>
<span id="cb28-1174"><a href="#cb28-1174" aria-hidden="true" tabindex="-1"></a>          map<span class="op">.</span><span class="fu">on</span>(<span class="st">"zoom"</span><span class="op">,</span> onMove)<span class="op">;</span></span>
<span id="cb28-1175"><a href="#cb28-1175" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (map<span class="op">.</span><span class="fu">loaded</span>()) <span class="fu">emit</span>()<span class="op">;</span></span>
<span id="cb28-1176"><a href="#cb28-1176" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb28-1177"><a href="#cb28-1177" aria-hidden="true" tabindex="-1"></a>            <span class="bu">window</span><span class="op">.</span><span class="at">_observableMap</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb28-1178"><a href="#cb28-1178" aria-hidden="true" tabindex="-1"></a>            map<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb28-1179"><a href="#cb28-1179" aria-hidden="true" tabindex="-1"></a>          }<span class="op">;</span></span>
<span id="cb28-1180"><a href="#cb28-1180" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb28-1181"><a href="#cb28-1181" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1182"><a href="#cb28-1182" aria-hidden="true" tabindex="-1"></a>        <span class="fu">resolve</span>(observable)<span class="op">;</span></span>
<span id="cb28-1183"><a href="#cb28-1183" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb28-1184"><a href="#cb28-1184" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Try again in a few milliseconds</span></span>
<span id="cb28-1185"><a href="#cb28-1185" aria-hidden="true" tabindex="-1"></a>        <span class="pp">setTimeout</span>(waitForContainer<span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span></span>
<span id="cb28-1186"><a href="#cb28-1186" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb28-1187"><a href="#cb28-1187" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-1188"><a href="#cb28-1188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">waitForContainer</span>()<span class="op">;</span></span>
<span id="cb28-1189"><a href="#cb28-1189" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb28-1190"><a href="#cb28-1190" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="map-init" class="cell-output cell-output-display">
<div id="ojs-cell-27" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" data-startfrom="1195" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1194;"><span id="cb29-1195"><a href="#cb29-1195" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">queryViewportSamples</span>(db<span class="op">,</span> vp<span class="op">,</span> mode) {</span>
<span id="cb29-1196"><a href="#cb29-1196" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [xmin<span class="op">,</span> ymin<span class="op">,</span> xmax<span class="op">,</span> ymax] <span class="op">=</span> vp<span class="op">.</span><span class="at">bounds</span><span class="op">;</span></span>
<span id="cb29-1197"><a href="#cb29-1197" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> z <span class="op">=</span> vp<span class="op">.</span><span class="at">zoom</span><span class="op">;</span></span>
<span id="cb29-1198"><a href="#cb29-1198" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> baseMod <span class="op">=</span> MAPCFG<span class="op">.</span><span class="fu">modulusByZoom</span>(z)<span class="op">;</span></span>
<span id="cb29-1199"><a href="#cb29-1199" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> MODULUS <span class="op">=</span> mode <span class="op">===</span> <span class="st">"lite"</span> <span class="op">?</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="dv">1</span><span class="op">,</span> baseMod <span class="op">*</span> <span class="dv">2</span>) <span class="op">:</span> baseMod<span class="op">;</span></span>
<span id="cb29-1200"><a href="#cb29-1200" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> LIMIT <span class="op">=</span> mode <span class="op">===</span> <span class="st">"lite"</span> <span class="op">?</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(MAPCFG<span class="op">.</span><span class="at">maxPerTileHard</span><span class="op">/</span><span class="dv">2</span>) <span class="op">:</span> MAPCFG<span class="op">.</span><span class="at">maxPerTileHard</span><span class="op">;</span></span>
<span id="cb29-1201"><a href="#cb29-1201" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> sql <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb29-1202"><a href="#cb29-1202" aria-hidden="true" tabindex="-1"></a><span class="vs">    SELECT </span></span>
<span id="cb29-1203"><a href="#cb29-1203" aria-hidden="true" tabindex="-1"></a><span class="vs">      sample_identifier,</span></span>
<span id="cb29-1204"><a href="#cb29-1204" aria-hidden="true" tabindex="-1"></a><span class="vs">      sample_location_longitude AS lon,</span></span>
<span id="cb29-1205"><a href="#cb29-1205" aria-hidden="true" tabindex="-1"></a><span class="vs">      sample_location_latitude  AS lat,</span></span>
<span id="cb29-1206"><a href="#cb29-1206" aria-hidden="true" tabindex="-1"></a><span class="vs">      source_collection</span></span>
<span id="cb29-1207"><a href="#cb29-1207" aria-hidden="true" tabindex="-1"></a><span class="vs">    FROM isamples_data</span></span>
<span id="cb29-1208"><a href="#cb29-1208" aria-hidden="true" tabindex="-1"></a><span class="vs">    WHERE sample_location_longitude BETWEEN </span><span class="sc">${</span>xmin<span class="sc">}</span><span class="vs"> AND </span><span class="sc">${</span>xmax<span class="sc">}</span></span>
<span id="cb29-1209"><a href="#cb29-1209" aria-hidden="true" tabindex="-1"></a><span class="vs">      AND sample_location_latitude  BETWEEN </span><span class="sc">${</span>ymin<span class="sc">}</span><span class="vs"> AND </span><span class="sc">${</span>ymax<span class="sc">}</span></span>
<span id="cb29-1210"><a href="#cb29-1210" aria-hidden="true" tabindex="-1"></a><span class="vs">      AND ABS(hash(sample_identifier)) % </span><span class="sc">${</span>MODULUS<span class="sc">}</span><span class="vs"> = 0</span></span>
<span id="cb29-1211"><a href="#cb29-1211" aria-hidden="true" tabindex="-1"></a><span class="vs">    LIMIT </span><span class="sc">${</span>LIMIT<span class="sc">}</span></span>
<span id="cb29-1212"><a href="#cb29-1212" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb29-1213"><a href="#cb29-1213" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(sql)<span class="op">;</span></span>
<span id="cb29-1214"><a href="#cb29-1214" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">.</span><span class="fu">toArray</span>()<span class="op">;</span></span>
<span id="cb29-1215"><a href="#cb29-1215" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="viewport-sample" class="cell-output cell-output-display">
<div id="ojs-cell-28" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30" data-startfrom="1220" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1219;"><span id="cb30-1220"><a href="#cb30-1220" aria-hidden="true" tabindex="-1"></a>viewport_data <span class="op">=</span> {</span>
<span id="cb30-1221"><a href="#cb30-1221" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Always load data (not just for non-raster mode since we need it for fallback plot)</span></span>
<span id="cb30-1222"><a href="#cb30-1222" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>viewport<span class="op">?.</span><span class="at">bounds</span> <span class="op">||</span> <span class="op">!</span>db) {</span>
<span id="cb30-1223"><a href="#cb30-1223" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'No viewport bounds or db available'</span>)<span class="op">;</span></span>
<span id="cb30-1224"><a href="#cb30-1224" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb30-1225"><a href="#cb30-1225" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-1226"><a href="#cb30-1226" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-1227"><a href="#cb30-1227" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb30-1228"><a href="#cb30-1228" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="fu">queryViewportSamples</span>(db<span class="op">,</span> viewport<span class="op">,</span> MODE)<span class="op">;</span></span>
<span id="cb30-1229"><a href="#cb30-1229" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Loaded </span><span class="sc">${</span>data<span class="op">?.</span><span class="at">length</span> <span class="op">||</span> <span class="dv">0</span><span class="sc">}</span><span class="vs"> viewport samples for bounds:`</span><span class="op">,</span> viewport<span class="op">.</span><span class="at">bounds</span>)<span class="op">;</span></span>
<span id="cb30-1230"><a href="#cb30-1230" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Sample data:'</span><span class="op">,</span> data<span class="op">?.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">3</span>))<span class="op">;</span> <span class="co">// Show first 3 records</span></span>
<span id="cb30-1231"><a href="#cb30-1231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb30-1232"><a href="#cb30-1232" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb30-1233"><a href="#cb30-1233" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'Error querying viewport samples:'</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb30-1234"><a href="#cb30-1234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb30-1235"><a href="#cb30-1235" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-1236"><a href="#cb30-1236" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="data-viewport" class="cell-output cell-output-display">
<div id="ojs-cell-29" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" data-startfrom="1241" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1240;"><span id="cb31-1241"><a href="#cb31-1241" aria-hidden="true" tabindex="-1"></a>map_layer_update <span class="op">=</span> {</span>
<span id="cb31-1242"><a href="#cb31-1242" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Update MapLibre map layers with viewport data</span></span>
<span id="cb31-1243"><a href="#cb31-1243" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>viewport<span class="op">?.</span><span class="at">map</span> <span class="op">||</span> <span class="op">!</span>viewport_data <span class="op">||</span> <span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(viewport_data)) {</span>
<span id="cb31-1244"><a href="#cb31-1244" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'No map or data available for layer update'</span>)<span class="op">;</span></span>
<span id="cb31-1245"><a href="#cb31-1245" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb31-1246"><a href="#cb31-1246" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-1247"><a href="#cb31-1247" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-1248"><a href="#cb31-1248" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> map <span class="op">=</span> viewport<span class="op">.</span><span class="at">map</span><span class="op">;</span></span>
<span id="cb31-1249"><a href="#cb31-1249" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-1250"><a href="#cb31-1250" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Convert viewport data to GeoJSON format for MapLibre</span></span>
<span id="cb31-1251"><a href="#cb31-1251" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> geojson <span class="op">=</span> {</span>
<span id="cb31-1252"><a href="#cb31-1252" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">"FeatureCollection"</span><span class="op">,</span></span>
<span id="cb31-1253"><a href="#cb31-1253" aria-hidden="true" tabindex="-1"></a>    <span class="dt">features</span><span class="op">:</span> viewport_data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> ({</span>
<span id="cb31-1254"><a href="#cb31-1254" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">"Feature"</span><span class="op">,</span></span>
<span id="cb31-1255"><a href="#cb31-1255" aria-hidden="true" tabindex="-1"></a>      <span class="dt">geometry</span><span class="op">:</span> {</span>
<span id="cb31-1256"><a href="#cb31-1256" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">"Point"</span><span class="op">,</span></span>
<span id="cb31-1257"><a href="#cb31-1257" aria-hidden="true" tabindex="-1"></a>        <span class="dt">coordinates</span><span class="op">:</span> [d<span class="op">.</span><span class="at">lon</span><span class="op">,</span> d<span class="op">.</span><span class="at">lat</span>]</span>
<span id="cb31-1258"><a href="#cb31-1258" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb31-1259"><a href="#cb31-1259" aria-hidden="true" tabindex="-1"></a>      <span class="dt">properties</span><span class="op">:</span> {</span>
<span id="cb31-1260"><a href="#cb31-1260" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sample_identifier</span><span class="op">:</span> d<span class="op">.</span><span class="at">sample_identifier</span><span class="op">,</span></span>
<span id="cb31-1261"><a href="#cb31-1261" aria-hidden="true" tabindex="-1"></a>        <span class="dt">source_collection</span><span class="op">:</span> d<span class="op">.</span><span class="at">source_collection</span></span>
<span id="cb31-1262"><a href="#cb31-1262" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb31-1263"><a href="#cb31-1263" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb31-1264"><a href="#cb31-1264" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb31-1265"><a href="#cb31-1265" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-1266"><a href="#cb31-1266" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Remove existing source/layer if they exist</span></span>
<span id="cb31-1267"><a href="#cb31-1267" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (map<span class="op">.</span><span class="fu">getSource</span>(<span class="st">'viewport-points'</span>)) {</span>
<span id="cb31-1268"><a href="#cb31-1268" aria-hidden="true" tabindex="-1"></a>    map<span class="op">.</span><span class="fu">removeLayer</span>(<span class="st">'viewport-points'</span>)<span class="op">;</span></span>
<span id="cb31-1269"><a href="#cb31-1269" aria-hidden="true" tabindex="-1"></a>    map<span class="op">.</span><span class="fu">removeSource</span>(<span class="st">'viewport-points'</span>)<span class="op">;</span></span>
<span id="cb31-1270"><a href="#cb31-1270" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-1271"><a href="#cb31-1271" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-1272"><a href="#cb31-1272" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add new source and layer</span></span>
<span id="cb31-1273"><a href="#cb31-1273" aria-hidden="true" tabindex="-1"></a>  map<span class="op">.</span><span class="fu">addSource</span>(<span class="st">'viewport-points'</span><span class="op">,</span> {</span>
<span id="cb31-1274"><a href="#cb31-1274" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">'geojson'</span><span class="op">,</span></span>
<span id="cb31-1275"><a href="#cb31-1275" aria-hidden="true" tabindex="-1"></a>    <span class="dt">data</span><span class="op">:</span> geojson</span>
<span id="cb31-1276"><a href="#cb31-1276" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb31-1277"><a href="#cb31-1277" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-1278"><a href="#cb31-1278" aria-hidden="true" tabindex="-1"></a>  map<span class="op">.</span><span class="fu">addLayer</span>({</span>
<span id="cb31-1279"><a href="#cb31-1279" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> <span class="st">'viewport-points'</span><span class="op">,</span></span>
<span id="cb31-1280"><a href="#cb31-1280" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">'circle'</span><span class="op">,</span></span>
<span id="cb31-1281"><a href="#cb31-1281" aria-hidden="true" tabindex="-1"></a>    <span class="dt">source</span><span class="op">:</span> <span class="st">'viewport-points'</span><span class="op">,</span></span>
<span id="cb31-1282"><a href="#cb31-1282" aria-hidden="true" tabindex="-1"></a>    <span class="dt">paint</span><span class="op">:</span> {</span>
<span id="cb31-1283"><a href="#cb31-1283" aria-hidden="true" tabindex="-1"></a>      <span class="st">'circle-radius'</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb31-1284"><a href="#cb31-1284" aria-hidden="true" tabindex="-1"></a>      <span class="st">'circle-color'</span><span class="op">:</span> [</span>
<span id="cb31-1285"><a href="#cb31-1285" aria-hidden="true" tabindex="-1"></a>        <span class="st">'match'</span><span class="op">,</span></span>
<span id="cb31-1286"><a href="#cb31-1286" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'get'</span><span class="op">,</span> <span class="st">'source_collection'</span>]<span class="op">,</span></span>
<span id="cb31-1287"><a href="#cb31-1287" aria-hidden="true" tabindex="-1"></a>        <span class="st">'SESAR'</span><span class="op">,</span> <span class="st">'#3366cc'</span><span class="op">,</span></span>
<span id="cb31-1288"><a href="#cb31-1288" aria-hidden="true" tabindex="-1"></a>        <span class="st">'OPENCONTEXT'</span><span class="op">,</span> <span class="st">'#dc3912'</span><span class="op">,</span> </span>
<span id="cb31-1289"><a href="#cb31-1289" aria-hidden="true" tabindex="-1"></a>        <span class="st">'GEOME'</span><span class="op">,</span> <span class="st">'#109618'</span><span class="op">,</span></span>
<span id="cb31-1290"><a href="#cb31-1290" aria-hidden="true" tabindex="-1"></a>        <span class="st">'SMITHSONIAN'</span><span class="op">,</span> <span class="st">'#ff9900'</span><span class="op">,</span></span>
<span id="cb31-1291"><a href="#cb31-1291" aria-hidden="true" tabindex="-1"></a>        <span class="st">'#666666'</span> <span class="co">// fallback color</span></span>
<span id="cb31-1292"><a href="#cb31-1292" aria-hidden="true" tabindex="-1"></a>      ]<span class="op">,</span></span>
<span id="cb31-1293"><a href="#cb31-1293" aria-hidden="true" tabindex="-1"></a>      <span class="st">'circle-opacity'</span><span class="op">:</span> <span class="fl">0.8</span><span class="op">,</span></span>
<span id="cb31-1294"><a href="#cb31-1294" aria-hidden="true" tabindex="-1"></a>      <span class="st">'circle-stroke-width'</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb31-1295"><a href="#cb31-1295" aria-hidden="true" tabindex="-1"></a>      <span class="st">'circle-stroke-color'</span><span class="op">:</span> <span class="st">'#ffffff'</span></span>
<span id="cb31-1296"><a href="#cb31-1296" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-1297"><a href="#cb31-1297" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb31-1298"><a href="#cb31-1298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-1299"><a href="#cb31-1299" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Updated MapLibre map with </span><span class="sc">${</span>viewport_data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> points`</span>)<span class="op">;</span></span>
<span id="cb31-1300"><a href="#cb31-1300" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="vs">`Updated with </span><span class="sc">${</span>viewport_data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> points`</span><span class="op">;</span></span>
<span id="cb31-1301"><a href="#cb31-1301" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="maplibre-layer-update" class="cell-output cell-output-display">
<div id="ojs-cell-30" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32" data-startfrom="1306" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1305;"><span id="cb32-1306"><a href="#cb32-1306" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">scatterLayer</span>(data) {</span>
<span id="cb32-1307"><a href="#cb32-1307" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ScatterplotLayer <span class="op">=</span> decklib<span class="op">.</span><span class="at">default</span><span class="op">?.</span><span class="at">ScatterplotLayer</span> <span class="op">||</span> decklib<span class="op">.</span><span class="at">ScatterplotLayer</span><span class="op">;</span></span>
<span id="cb32-1308"><a href="#cb32-1308" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">new</span> <span class="fu">ScatterplotLayer</span>({</span>
<span id="cb32-1309"><a href="#cb32-1309" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> <span class="st">"vp-points"</span><span class="op">,</span></span>
<span id="cb32-1310"><a href="#cb32-1310" aria-hidden="true" tabindex="-1"></a>    data<span class="op">,</span></span>
<span id="cb32-1311"><a href="#cb32-1311" aria-hidden="true" tabindex="-1"></a>    <span class="dt">getPosition</span><span class="op">:</span> d <span class="kw">=&gt;</span> [d<span class="op">.</span><span class="at">lon</span><span class="op">,</span> d<span class="op">.</span><span class="at">lat</span>]<span class="op">,</span></span>
<span id="cb32-1312"><a href="#cb32-1312" aria-hidden="true" tabindex="-1"></a>    <span class="dt">getFillColor</span><span class="op">:</span> MAPCFG<span class="op">.</span><span class="at">pointColor</span><span class="op">,</span></span>
<span id="cb32-1313"><a href="#cb32-1313" aria-hidden="true" tabindex="-1"></a>    <span class="dt">getRadius</span><span class="op">:</span> MAPCFG<span class="op">.</span><span class="at">pointRadiusPx</span><span class="op">,</span></span>
<span id="cb32-1314"><a href="#cb32-1314" aria-hidden="true" tabindex="-1"></a>    <span class="dt">radiusUnits</span><span class="op">:</span> <span class="st">"pixels"</span><span class="op">,</span></span>
<span id="cb32-1315"><a href="#cb32-1315" aria-hidden="true" tabindex="-1"></a>    <span class="dt">radiusMinPixels</span><span class="op">:</span> MAPCFG<span class="op">.</span><span class="at">pointRadiusPx</span><span class="op">,</span></span>
<span id="cb32-1316"><a href="#cb32-1316" aria-hidden="true" tabindex="-1"></a>    <span class="dt">radiusMaxPixels</span><span class="op">:</span> MAPCFG<span class="op">.</span><span class="at">pointRadiusPx</span> <span class="op">*</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb32-1317"><a href="#cb32-1317" aria-hidden="true" tabindex="-1"></a>    <span class="dt">pickable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb32-1318"><a href="#cb32-1318" aria-hidden="true" tabindex="-1"></a>    <span class="dt">parameters</span><span class="op">:</span> {<span class="dt">depthTest</span><span class="op">:</span> <span class="kw">false</span>}</span>
<span id="cb32-1319"><a href="#cb32-1319" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb32-1320"><a href="#cb32-1320" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="deckgl-layer" class="cell-output cell-output-display">
<div id="ojs-cell-31" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" data-startfrom="1325" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1324;"><span id="cb33-1325"><a href="#cb33-1325" aria-hidden="true" tabindex="-1"></a>deck_overlay <span class="op">=</span> {</span>
<span id="cb33-1326"><a href="#cb33-1326" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>decklib) {</span>
<span id="cb33-1327"><a href="#cb33-1327" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Deck.gl temporarily disabled due to dependency issues. Map shows without WebGL overlay.&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb33-1328"><a href="#cb33-1328" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-1329"><a href="#cb33-1329" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-1330"><a href="#cb33-1330" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (MODE <span class="op">===</span> <span class="st">"raster"</span>) <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Raster mode active&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb33-1331"><a href="#cb33-1331" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-1332"><a href="#cb33-1332" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb33-1333"><a href="#cb33-1333" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get map from viewport or global reference</span></span>
<span id="cb33-1334"><a href="#cb33-1334" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> map <span class="op">=</span> viewport<span class="op">?.</span><span class="at">map</span> <span class="op">||</span> <span class="bu">window</span><span class="op">.</span><span class="at">_observableMap</span><span class="op">;</span></span>
<span id="cb33-1335"><a href="#cb33-1335" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>map) {</span>
<span id="cb33-1336"><a href="#cb33-1336" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Waiting for map initialization...&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb33-1337"><a href="#cb33-1337" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-1338"><a href="#cb33-1338" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-1339"><a href="#cb33-1339" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use MapboxOverlay from deck.gl library</span></span>
<span id="cb33-1340"><a href="#cb33-1340" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> MapboxOverlay <span class="op">=</span> decklib<span class="op">.</span><span class="at">default</span><span class="op">?.</span><span class="at">MapboxOverlay</span> <span class="op">||</span> decklib<span class="op">.</span><span class="at">MapboxOverlay</span><span class="op">;</span></span>
<span id="cb33-1341"><a href="#cb33-1341" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>MapboxOverlay) {</span>
<span id="cb33-1342"><a href="#cb33-1342" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Available decklib properties:"</span><span class="op">,</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(decklib <span class="op">||</span> {}))<span class="op">;</span></span>
<span id="cb33-1343"><a href="#cb33-1343" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Available decklib.default properties:"</span><span class="op">,</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(decklib<span class="op">.</span><span class="at">default</span> <span class="op">||</span> {}))<span class="op">;</span></span>
<span id="cb33-1344"><a href="#cb33-1344" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">"MapboxOverlay not found in deck.gl library"</span>)<span class="op">;</span></span>
<span id="cb33-1345"><a href="#cb33-1345" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-1346"><a href="#cb33-1346" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-1347"><a href="#cb33-1347" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> overlay <span class="op">=</span> <span class="kw">new</span> <span class="fu">MapboxOverlay</span>({<span class="dt">interleaved</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">layers</span><span class="op">:</span> []})<span class="op">;</span></span>
<span id="cb33-1348"><a href="#cb33-1348" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-1349"><a href="#cb33-1349" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add overlay to map</span></span>
<span id="cb33-1350"><a href="#cb33-1350" aria-hidden="true" tabindex="-1"></a>    map<span class="op">.</span><span class="fu">addControl</span>(overlay)<span class="op">;</span></span>
<span id="cb33-1351"><a href="#cb33-1351" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-1352"><a href="#cb33-1352" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Store overlay reference for other cells</span></span>
<span id="cb33-1353"><a href="#cb33-1353" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">_deckOverlay</span> <span class="op">=</span> overlay<span class="op">;</span></span>
<span id="cb33-1354"><a href="#cb33-1354" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-1355"><a href="#cb33-1355" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">render</span>() {</span>
<span id="cb33-1356"><a href="#cb33-1356" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (MODE <span class="op">!==</span> <span class="st">"raster"</span> <span class="op">&amp;&amp;</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(viewport_data) <span class="op">&amp;&amp;</span> viewport_data<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb33-1357"><a href="#cb33-1357" aria-hidden="true" tabindex="-1"></a>        overlay<span class="op">.</span><span class="fu">setProps</span>({<span class="dt">layers</span><span class="op">:</span> [<span class="fu">scatterLayer</span>(viewport_data)]})<span class="op">;</span></span>
<span id="cb33-1358"><a href="#cb33-1358" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb33-1359"><a href="#cb33-1359" aria-hidden="true" tabindex="-1"></a>        overlay<span class="op">.</span><span class="fu">setProps</span>({<span class="dt">layers</span><span class="op">:</span> []})<span class="op">;</span></span>
<span id="cb33-1360"><a href="#cb33-1360" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb33-1361"><a href="#cb33-1361" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-1362"><a href="#cb33-1362" aria-hidden="true" tabindex="-1"></a>    <span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb33-1363"><a href="#cb33-1363" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-1364"><a href="#cb33-1364" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Deck.gl overlay initialized (</span><span class="sc">${</span>viewport_data<span class="op">?.</span><span class="at">length</span> <span class="op">||</span> <span class="dv">0</span><span class="sc">}</span><span class="vs"> points)&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb33-1365"><a href="#cb33-1365" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb33-1366"><a href="#cb33-1366" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'Deck overlay error:'</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb33-1367"><a href="#cb33-1367" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Error initializing deck.gl: </span><span class="sc">${</span>error<span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb33-1368"><a href="#cb33-1368" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-1369"><a href="#cb33-1369" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="deckgl-overlay" class="cell-output cell-output-display">
<div id="ojs-cell-32" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34" data-startfrom="1374" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1373;"><span id="cb34-1374"><a href="#cb34-1374" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb34-1375"><a href="#cb34-1375" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (MODE <span class="op">===</span> <span class="st">"raster"</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb34-1376"><a href="#cb34-1376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-1377"><a href="#cb34-1377" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> overlay <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">_deckOverlay</span><span class="op">;</span></span>
<span id="cb34-1378"><a href="#cb34-1378" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> badge <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"mode-badge"</span>)<span class="op">;</span></span>
<span id="cb34-1379"><a href="#cb34-1379" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-1380"><a href="#cb34-1380" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>overlay <span class="op">||</span> <span class="op">!</span>badge) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb34-1381"><a href="#cb34-1381" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-1382"><a href="#cb34-1382" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> samples <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> total <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> degraded <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb34-1383"><a href="#cb34-1383" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-1384"><a href="#cb34-1384" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">tick</span>(t) {</span>
<span id="cb34-1385"><a href="#cb34-1385" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (degraded <span class="op">||</span> <span class="op">!</span>overlay) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb34-1386"><a href="#cb34-1386" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-1387"><a href="#cb34-1387" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb34-1388"><a href="#cb34-1388" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> stats <span class="op">=</span> overlay<span class="op">.</span><span class="at">_deck</span><span class="op">?.</span><span class="at">stats</span><span class="op">;</span></span>
<span id="cb34-1389"><a href="#cb34-1389" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> ft <span class="op">=</span> stats <span class="op">&amp;&amp;</span> stats<span class="op">.</span><span class="at">get</span> <span class="op">&amp;&amp;</span> stats<span class="op">.</span><span class="fu">get</span>(<span class="st">"Frame Time"</span>)<span class="op">?.</span><span class="at">lastTiming</span><span class="op">;</span></span>
<span id="cb34-1390"><a href="#cb34-1390" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (ft <span class="op">&amp;&amp;</span> ft <span class="op">&gt;</span> <span class="dv">0</span>) { </span>
<span id="cb34-1391"><a href="#cb34-1391" aria-hidden="true" tabindex="-1"></a>        total <span class="op">+=</span> ft<span class="op">;</span> </span>
<span id="cb34-1392"><a href="#cb34-1392" aria-hidden="true" tabindex="-1"></a>        samples<span class="op">++;</span> </span>
<span id="cb34-1393"><a href="#cb34-1393" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb34-1394"><a href="#cb34-1394" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb34-1395"><a href="#cb34-1395" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (samples <span class="op">&lt;</span> <span class="dv">120</span>) {</span>
<span id="cb34-1396"><a href="#cb34-1396" aria-hidden="true" tabindex="-1"></a>        <span class="fu">requestAnimationFrame</span>(tick)<span class="op">;</span></span>
<span id="cb34-1397"><a href="#cb34-1397" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (samples <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb34-1398"><a href="#cb34-1398" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> avg <span class="op">=</span> total <span class="op">/</span> samples<span class="op">;</span></span>
<span id="cb34-1399"><a href="#cb34-1399" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (avg <span class="op">&gt;</span> <span class="dv">50</span>) {</span>
<span id="cb34-1400"><a href="#cb34-1400" aria-hidden="true" tabindex="-1"></a>          degraded <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb34-1401"><a href="#cb34-1401" aria-hidden="true" tabindex="-1"></a>          overlay<span class="op">.</span><span class="fu">setProps</span>({<span class="dt">layers</span><span class="op">:</span> []})<span class="op">;</span></span>
<span id="cb34-1402"><a href="#cb34-1402" aria-hidden="true" tabindex="-1"></a>          badge<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">'Mode: &lt;b&gt;raster (auto)&lt;/b&gt;'</span><span class="op">;</span></span>
<span id="cb34-1403"><a href="#cb34-1403" aria-hidden="true" tabindex="-1"></a>          mutable autodowngraded <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb34-1404"><a href="#cb34-1404" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb34-1405"><a href="#cb34-1405" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb34-1406"><a href="#cb34-1406" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb34-1407"><a href="#cb34-1407" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">'FPS monitoring error:'</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb34-1408"><a href="#cb34-1408" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-1409"><a href="#cb34-1409" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-1410"><a href="#cb34-1410" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-1411"><a href="#cb34-1411" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Wait a bit for deck to initialize</span></span>
<span id="cb34-1412"><a href="#cb34-1412" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="fu">requestAnimationFrame</span>(tick)<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb34-1413"><a href="#cb34-1413" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="fps-autodowngrade" class="cell-output cell-output-display">
<div id="ojs-cell-33" data-nodetype="expression">

</div>
</div>
</div>
<div id="plot-fallback" class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35" data-startfrom="1419" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1418;"><span id="cb35-1419"><a href="#cb35-1419" aria-hidden="true" tabindex="-1"></a>mutable autodowngraded <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb35-1420"><a href="#cb35-1420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-1421"><a href="#cb35-1421" aria-hidden="true" tabindex="-1"></a><span class="co">// Since deck.gl is disabled, always show a Plot fallback for viewport data  </span></span>
<span id="cb35-1422"><a href="#cb35-1422" aria-hidden="true" tabindex="-1"></a>plot_fallback <span class="op">=</span> {</span>
<span id="cb35-1423"><a href="#cb35-1423" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Plot fallback - decklib:'</span><span class="op">,</span> decklib)<span class="op">;</span></span>
<span id="cb35-1424"><a href="#cb35-1424" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Plot fallback - MODE:'</span><span class="op">,</span> MODE)<span class="op">;</span></span>
<span id="cb35-1425"><a href="#cb35-1425" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Plot fallback - viewport_data type:'</span><span class="op">,</span> <span class="kw">typeof</span> viewport_data)<span class="op">;</span></span>
<span id="cb35-1426"><a href="#cb35-1426" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Plot fallback - viewport_data length:'</span><span class="op">,</span> viewport_data<span class="op">?.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb35-1427"><a href="#cb35-1427" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-1428"><a href="#cb35-1428" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>decklib <span class="op">||</span> MODE <span class="op">===</span> <span class="st">"raster"</span> <span class="op">||</span> autodowngraded) {</span>
<span id="cb35-1429"><a href="#cb35-1429" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>viewport_data <span class="op">||</span> <span class="op">!</span><span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(viewport_data) <span class="op">||</span> viewport_data<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb35-1430"><a href="#cb35-1430" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div style="padding: 20px; border: 1px solid #ccc; background: #f9f9f9;"&gt;</span></span>
<span id="cb35-1431"><a href="#cb35-1431" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;strong&gt;Viewport Data Status:&lt;/strong&gt;&lt;br&gt;</span></span>
<span id="cb35-1432"><a href="#cb35-1432" aria-hidden="true" tabindex="-1"></a><span class="vs">        ‚Ä¢ deck.gl: </span><span class="sc">${</span>decklib <span class="op">?</span> <span class="st">'enabled'</span> <span class="op">:</span> <span class="st">'disabled'</span><span class="sc">}</span><span class="vs">&lt;br&gt;</span></span>
<span id="cb35-1433"><a href="#cb35-1433" aria-hidden="true" tabindex="-1"></a><span class="vs">        ‚Ä¢ Mode: </span><span class="sc">${</span>MODE<span class="sc">}</span><span class="vs">&lt;br&gt;</span></span>
<span id="cb35-1434"><a href="#cb35-1434" aria-hidden="true" tabindex="-1"></a><span class="vs">        ‚Ä¢ Data: </span><span class="sc">${</span>viewport_data <span class="op">?</span> <span class="vs">`</span><span class="sc">${</span>viewport_data<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> samples`</span> <span class="op">:</span> <span class="st">'null/undefined'</span><span class="sc">}</span><span class="vs">&lt;br&gt;</span></span>
<span id="cb35-1435"><a href="#cb35-1435" aria-hidden="true" tabindex="-1"></a><span class="vs">        ‚Ä¢ Waiting for viewport data to load...</span></span>
<span id="cb35-1436"><a href="#cb35-1436" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb35-1437"><a href="#cb35-1437" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-1438"><a href="#cb35-1438" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-1439"><a href="#cb35-1439" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use the Plot that's already imported at the top of the notebook</span></span>
<span id="cb35-1440"><a href="#cb35-1440" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Need to get the world data for the map background</span></span>
<span id="cb35-1441"><a href="#cb35-1441" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> worldData <span class="op">=</span> <span class="cf">await</span> world<span class="op">;</span></span>
<span id="cb35-1442"><a href="#cb35-1442" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> countries <span class="op">=</span> topojson<span class="op">.</span><span class="fu">feature</span>(worldData<span class="op">,</span> worldData<span class="op">.</span><span class="at">objects</span><span class="op">.</span><span class="at">countries</span>)<span class="op">;</span></span>
<span id="cb35-1443"><a href="#cb35-1443" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-1444"><a href="#cb35-1444" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb35-1445"><a href="#cb35-1445" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="vs">`Viewport Samples (</span><span class="sc">${</span>viewport_data<span class="op">.</span><span class="at">length</span><span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span><span class="vs"> points)`</span><span class="op">,</span></span>
<span id="cb35-1446"><a href="#cb35-1446" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">900</span><span class="op">,</span></span>
<span id="cb35-1447"><a href="#cb35-1447" aria-hidden="true" tabindex="-1"></a>      <span class="dt">height</span><span class="op">:</span> <span class="dv">480</span><span class="op">,</span></span>
<span id="cb35-1448"><a href="#cb35-1448" aria-hidden="true" tabindex="-1"></a>      <span class="dt">projection</span><span class="op">:</span> <span class="st">"mercator"</span><span class="op">,</span></span>
<span id="cb35-1449"><a href="#cb35-1449" aria-hidden="true" tabindex="-1"></a>      <span class="dt">inset</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span></span>
<span id="cb35-1450"><a href="#cb35-1450" aria-hidden="true" tabindex="-1"></a>      <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb35-1451"><a href="#cb35-1451" aria-hidden="true" tabindex="-1"></a>        <span class="co">// World map outline</span></span>
<span id="cb35-1452"><a href="#cb35-1452" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">geo</span>(countries<span class="op">,</span> {</span>
<span id="cb35-1453"><a href="#cb35-1453" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"#f0f0f0"</span><span class="op">,</span></span>
<span id="cb35-1454"><a href="#cb35-1454" aria-hidden="true" tabindex="-1"></a>          <span class="dt">stroke</span><span class="op">:</span> <span class="st">"#ccc"</span><span class="op">,</span></span>
<span id="cb35-1455"><a href="#cb35-1455" aria-hidden="true" tabindex="-1"></a>          <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.5</span></span>
<span id="cb35-1456"><a href="#cb35-1456" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb35-1457"><a href="#cb35-1457" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add a big red dot on London for testing</span></span>
<span id="cb35-1458"><a href="#cb35-1458" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">dot</span>([{<span class="dt">lon</span><span class="op">:</span> <span class="fl">0.1278</span><span class="op">,</span> <span class="dt">lat</span><span class="op">:</span> <span class="fl">51.5074</span>}]<span class="op">,</span> {</span>
<span id="cb35-1459"><a href="#cb35-1459" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"lon"</span><span class="op">,</span> </span>
<span id="cb35-1460"><a href="#cb35-1460" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"lat"</span><span class="op">,</span> </span>
<span id="cb35-1461"><a href="#cb35-1461" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb35-1462"><a href="#cb35-1462" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"red"</span><span class="op">,</span></span>
<span id="cb35-1463"><a href="#cb35-1463" aria-hidden="true" tabindex="-1"></a>          <span class="dt">stroke</span><span class="op">:</span> <span class="st">"darkred"</span><span class="op">,</span></span>
<span id="cb35-1464"><a href="#cb35-1464" aria-hidden="true" tabindex="-1"></a>          <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">3</span></span>
<span id="cb35-1465"><a href="#cb35-1465" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb35-1466"><a href="#cb35-1466" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add the actual data points</span></span>
<span id="cb35-1467"><a href="#cb35-1467" aria-hidden="true" tabindex="-1"></a>        Plot<span class="op">.</span><span class="fu">dot</span>(viewport_data<span class="op">,</span> {</span>
<span id="cb35-1468"><a href="#cb35-1468" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"lon"</span><span class="op">,</span> </span>
<span id="cb35-1469"><a href="#cb35-1469" aria-hidden="true" tabindex="-1"></a>          <span class="dt">y</span><span class="op">:</span> <span class="st">"lat"</span><span class="op">,</span> </span>
<span id="cb35-1470"><a href="#cb35-1470" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fill</span><span class="op">:</span> <span class="st">"source_collection"</span><span class="op">,</span></span>
<span id="cb35-1471"><a href="#cb35-1471" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb35-1472"><a href="#cb35-1472" aria-hidden="true" tabindex="-1"></a>          <span class="dt">fillOpacity</span><span class="op">:</span> <span class="fl">0.7</span><span class="op">,</span></span>
<span id="cb35-1473"><a href="#cb35-1473" aria-hidden="true" tabindex="-1"></a>          <span class="dt">stroke</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span></span>
<span id="cb35-1474"><a href="#cb35-1474" aria-hidden="true" tabindex="-1"></a>          <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">0.2</span></span>
<span id="cb35-1475"><a href="#cb35-1475" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb35-1476"><a href="#cb35-1476" aria-hidden="true" tabindex="-1"></a>      ]<span class="op">,</span></span>
<span id="cb35-1477"><a href="#cb35-1477" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> {</span>
<span id="cb35-1478"><a href="#cb35-1478" aria-hidden="true" tabindex="-1"></a>        <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb35-1479"><a href="#cb35-1479" aria-hidden="true" tabindex="-1"></a>        <span class="dt">domain</span><span class="op">:</span> [<span class="st">"SESAR"</span><span class="op">,</span> <span class="st">"OPENCONTEXT"</span><span class="op">,</span> <span class="st">"GEOME"</span><span class="op">,</span> <span class="st">"SMITHSONIAN"</span>]<span class="op">,</span></span>
<span id="cb35-1480"><a href="#cb35-1480" aria-hidden="true" tabindex="-1"></a>        <span class="dt">range</span><span class="op">:</span> [<span class="st">"#3366cc"</span><span class="op">,</span> <span class="st">"#dc3912"</span><span class="op">,</span> <span class="st">"#109618"</span><span class="op">,</span> <span class="st">"#ff9900"</span>]</span>
<span id="cb35-1481"><a href="#cb35-1481" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb35-1482"><a href="#cb35-1482" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb35-1483"><a href="#cb35-1483" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-1484"><a href="#cb35-1484" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-1485"><a href="#cb35-1485" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">html</span><span class="vs">`&lt;div&gt;Deck.gl enabled - no fallback needed&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb35-1486"><a href="#cb35-1486" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="plot-fallback-1">
<div id="ojs-cell-34-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="plot-fallback-2">
<div id="ojs-cell-34-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36" data-startfrom="1490" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1489;"><span id="cb36-1490"><a href="#cb36-1490" aria-hidden="true" tabindex="-1"></a><span class="fu">md</span><span class="vs">`</span></span>
<span id="cb36-1491"><a href="#cb36-1491" aria-hidden="true" tabindex="-1"></a><span class="vs">**Rendering mode**: </span><span class="sc">\`${</span>MODE<span class="sc">}\`</span><span class="vs">  </span></span>
<span id="cb36-1492"><a href="#cb36-1492" aria-hidden="true" tabindex="-1"></a><span class="vs">- **full / lite** ‚Üí deck.gl Scatterplot sampled from DuckDB-WASM by current viewport  </span></span>
<span id="cb36-1493"><a href="#cb36-1493" aria-hidden="true" tabindex="-1"></a><span class="vs">- **raster** (or auto) ‚Üí aggregated canvas dots (size ‚âà count per grid cell)</span></span>
<span id="cb36-1494"><a href="#cb36-1494" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="map-legend" class="cell-output cell-output-display">
<div id="ojs-cell-35" data-nodetype="expression">

</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuLy8gU2ltcGxlIHRlc3QgdG8gZGVidWcgT2JzZXJ2YWJsZSByZWFjdGl2aXR5XG52aWV3b2YgdGVzdF9pbnB1dCA9IElucHV0cy5yYW5nZShbMSwgMTAwXSwge1xuICBsYWJlbDogXCJUZXN0IElucHV0OlwiLFxuICBzdGVwOiAxLFxuICB2YWx1ZTogNDJcbn0pXG5cbi8vIEluIE9ic2VydmFibGUsIHRoZSBpbnB1dCBpdHNlbGYgSVMgdGhlIHZhbHVlIHdoZW4gcmVmZXJlbmNlZCByZWFjdGl2ZWx5XG50ZXN0X3ZhbHVlID0gdGVzdF9pbnB1dFxuXG50ZXN0X291dHB1dCA9IHRlc3RfdmFsdWUgKiAyXG5cbm1kYFxuIyMg8J+nqiBSZWFjdGl2aXR5IFRlc3RcblxuKipSYXcgaW5wdXQgb2JqZWN0Kio6ICR7dHlwZW9mIHRlc3RfaW5wdXR9IChDb25zdHJ1Y3RvcjogJHt0ZXN0X2lucHV0Py5jb25zdHJ1Y3Rvcj8ubmFtZX0pICBcbioqRXh0cmFjdGVkIHZhbHVlKio6ICR7dGVzdF92YWx1ZX0gIFxuKipPdXRwdXQgKDJ4IGlucHV0KSoqOiAke3Rlc3Rfb3V0cHV0fSAgXG4qKlZhbHVlIHR5cGUqKjogJHt0eXBlb2YgdGVzdF92YWx1ZX1cblxuVGhpcyBzaG91bGQgdXBkYXRlIGluIHJlYWwtdGltZSBhcyB5b3UgbW92ZSB0aGUgc2xpZGVyLlxuYFxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0yIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG4vLyBJbXBvcnQgcmVxdWlyZWQgbGlicmFyaWVzIHVzaW5nIHJlbGlhYmxlIENETnNcbmR1Y2tkYiA9IGltcG9ydChcImh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vQGR1Y2tkYi9kdWNrZGItd2FzbUAxLjI4LjAvK2VzbVwiKVxuUGxvdCA9IGltcG9ydChcImh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vQG9ic2VydmFibGVocS9wbG90QDAuNi8rZXNtXCIpXG5JbnB1dHMgPSBpbXBvcnQoXCJodHRwczovL2Nkbi5qc2RlbGl2ci5uZXQvbnBtL0BvYnNlcnZhYmxlaHEvaW5wdXRzQDAuMTAvK2VzbVwiKVxuZDMgPSByZXF1aXJlKFwiZDNAN1wiKVxudG9wb2pzb24gPSByZXF1aXJlKFwidG9wb2pzb24tY2xpZW50QDNcIilcblxuLy8gRGF0YXNldCBVUkxzIC0gdHJ5IG11bHRpcGxlIG9wdGlvbnMgZm9yIENPUlMgY29tcGF0aWJpbGl0eVxuLy8gUHJpbWFyeTogQ2xvdWRmbGFyZSBSMiAoSmFuIDIwMjYgd2lkZSBmb3JtYXQgd2l0aCBIMyBpbmRpY2VzKVxucGFycXVldF91cmxzID0gW1xuICAnaHR0cHM6Ly9wdWItYTE4MjM0ZDk2MjM2NGMyMmE1MGM3ODdiN2NhMDlmYTUucjIuZGV2L2lzYW1wbGVzXzIwMjYwMV93aWRlX2gzLnBhcnF1ZXQnLFxuXG4gIC8vIEZhbGxiYWNrOiBvcmlnaW5hbCB3aWRlIGZvcm1hdCB3aXRob3V0IEgzXG4gICdodHRwczovL3B1Yi1hMTgyMzRkOTYyMzY0YzIyYTUwYzc4N2I3Y2EwOWZhNS5yMi5kZXYvaXNhbXBsZXNfMjAyNjAxX3dpZGUucGFycXVldCcsXG5cbiAgLy8gRmFsbGJhY2s6IG9sZGVyIHZlcnNpb25zXG4gICdodHRwczovL2xhYnMuZGF0YXVuYm91bmQuY29tL2RvY3MvMjAyNS8wNy9pc2FtcGxlc19leHBvcnRfMjAyNV8wNF8yMV8xNl8yM180Nl9nZW8ucGFycXVldCcsXG4gICdodHRwczovL3plbm9kby5vcmcvYXBpL3JlY29yZHMvMTUyNzgyMTEvZmlsZXMvaXNhbXBsZXNfZXhwb3J0XzIwMjVfMDRfMjFfMTZfMjNfNDZfZ2VvLnBhcnF1ZXQvY29udGVudCdcbl1cblxuLy8gUHJlLWNvbXB1dGVkIGZhY2V0IHN1bW1hcmllcyAoMktCIC0gbG9hZHMgaW5zdGFudGx5KVxuZmFjZXRfc3VtbWFyaWVzX3VybCA9ICdodHRwczovL3B1Yi1hMTgyMzRkOTYyMzY0YzIyYTUwYzc4N2I3Y2EwOWZhNS5yMi5kZXYvaXNhbXBsZXNfMjAyNjAxX2ZhY2V0X3N1bW1hcmllcy5wYXJxdWV0J1xuXG4vLyBUZXN0IENPUlMgYW5kIGZpbmQgd29ya2luZyBVUkwgLSB3aXRoIHJhdGUgbGltaXRpbmcgcHJvdGVjdGlvblxud29ya2luZ19wYXJxdWV0X3VybCA9IHtcbiAgLy8gQ2hlY2sgaWYgd2UndmUgcmVjZW50bHkgZmFpbGVkICh0byBhdm9pZCByZXBlYXRlZCByYXRlIGxpbWl0aW5nKVxuICBjb25zdCBsYXN0RmFpbFRpbWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnemVub2RvX2xhc3RfZmFpbCcpO1xuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICBpZiAobGFzdEZhaWxUaW1lICYmIChub3cgLSBwYXJzZUludChsYXN0RmFpbFRpbWUpKSA8IDMwMDAwMCkgeyAvLyA1IG1pbnV0ZXNcbiAgICBjb25zb2xlLmxvZygn4o+zIFJlY2VudGx5IGhpdCByYXRlIGxpbWl0LCB1c2luZyBkZW1vIGRhdGEnKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBcbiAgZm9yIChjb25zdCB1cmwgb2YgcGFycXVldF91cmxzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKGBUZXN0aW5nIFVSTDogJHt1cmx9YCk7XG4gICAgICAvLyBUZXN0IHdpdGggYSBzbWFsbCBIRUFEIHJlcXVlc3QgZmlyc3RcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsLCB7IFxuICAgICAgICBtZXRob2Q6ICdIRUFEJyxcbiAgICAgICAgbW9kZTogJ2NvcnMnXG4gICAgICB9KTtcbiAgICAgIGlmIChyZXNwb25zZS5vaykge1xuICAgICAgICBjb25zb2xlLmxvZyhg4pyFIFdvcmtpbmcgVVJMIGZvdW5kOiAke3VybH1gKTtcbiAgICAgICAgLy8gQ2xlYXIgYW55IHByZXZpb3VzIGZhaWx1cmUgdGltZVxuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnemVub2RvX2xhc3RfZmFpbCcpO1xuICAgICAgICByZXR1cm4gdXJsO1xuICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQyOSkge1xuICAgICAgICBjb25zb2xlLmxvZyhg4pqg77iPIFJhdGUgbGltaXRlZDogJHt1cmx9YCk7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCd6ZW5vZG9fbGFzdF9mYWlsJywgbm93LnRvU3RyaW5nKCkpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5sb2coYOKdjCBGYWlsZWQgVVJMOiAke3VybH0sIEVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnNDI5JykgfHwgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnVE9PIE1BTlkgUkVRVUVTVFMnKSkge1xuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnemVub2RvX2xhc3RfZmFpbCcsIG5vdy50b1N0cmluZygpKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gIH1cbiAgXG4gIC8vIElmIG5vIFVSTCB3b3Jrcywgd2UnbGwgdXNlIGEgZmFsbGJhY2sgYXBwcm9hY2hcbiAgY29uc29sZS5sb2coXCLimqDvuI8gTm8gZGlyZWN0IFVSTCB3b3JrZWQsIHdpbGwgdXNlIGRlbW8gZGF0YVwiKTtcbiAgcmV0dXJuIG51bGw7XG59XG5cbi8vIENyZWF0ZSBEdWNrREIgaW5zdGFuY2UgYW5kIGNvbm5lY3QgdG8gcmVtb3RlIHBhcnF1ZXRcbmRiID0ge1xuICAvLyBVc2UgRHVja0RCIEVTIG1vZHVsZXMgZnJvbSBqc2RlbGl2clxuICBjb25zdCBKU0RFTElWUl9CVU5ETEVTID0gZHVja2RiLmdldEpzRGVsaXZyQnVuZGxlcygpO1xuICBcbiAgLy8gU2VsZWN0IGJ1bmRsZSBmb3IgdGhlIHBsYXRmb3JtXG4gIGNvbnN0IGJ1bmRsZSA9IGF3YWl0IGR1Y2tkYi5zZWxlY3RCdW5kbGUoSlNERUxJVlJfQlVORExFUyk7XG4gIFxuICAvLyBDcmVhdGUgd29ya2VyXG4gIGNvbnN0IHdvcmtlcl91cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKFxuICAgIG5ldyBCbG9iKFtgaW1wb3J0U2NyaXB0cyhcIiR7YnVuZGxlLm1haW5Xb3JrZXJ9XCIpO2BdLCB7dHlwZTogJ3RleHQvamF2YXNjcmlwdCd9KVxuICApO1xuICBcbiAgY29uc3Qgd29ya2VyID0gbmV3IFdvcmtlcih3b3JrZXJfdXJsKTtcbiAgY29uc3QgbG9nZ2VyID0gbmV3IGR1Y2tkYi5Db25zb2xlTG9nZ2VyKGR1Y2tkYi5Mb2dMZXZlbC5XQVJOSU5HKTtcbiAgY29uc3QgZGJfaW5zdGFuY2UgPSBuZXcgZHVja2RiLkFzeW5jRHVja0RCKGxvZ2dlciwgd29ya2VyKTtcbiAgXG4gIC8vIEluaXRpYWxpemUgdGhlIGRhdGFiYXNlXG4gIGF3YWl0IGRiX2luc3RhbmNlLmluc3RhbnRpYXRlKGJ1bmRsZS5tYWluTW9kdWxlLCBidW5kbGUucHRocmVhZFdvcmtlcik7XG4gIFxuICAvLyBDb25uZWN0IHRvIGRhdGFiYXNlXG4gIGNvbnN0IGNvbm4gPSBhd2FpdCBkYl9pbnN0YW5jZS5jb25uZWN0KCk7XG4gIFxuICBpZiAod29ya2luZ19wYXJxdWV0X3VybCkge1xuICAgIHRyeSB7XG4gICAgICAvLyBUcnkgdG8gY3JlYXRlIHZpZXcgb2YgdGhlIHJlbW90ZSBwYXJxdWV0IGZpbGVcbiAgICAgIGF3YWl0IGNvbm4ucXVlcnkoYENSRUFURSBWSUVXIGlzYW1wbGVzX2RhdGEgQVMgU0VMRUNUICogRlJPTSByZWFkX3BhcnF1ZXQoJyR7d29ya2luZ19wYXJxdWV0X3VybH0nKWApO1xuICAgICAgXG4gICAgICAvLyBUZXN0IHRoZSBjb25uZWN0aW9uIHdpdGggYSBzaW1wbGUgcXVlcnkgdG8gY2F0Y2ggcmF0ZSBsaW1pdGluZ1xuICAgICAgYXdhaXQgY29ubi5xdWVyeShgU0VMRUNUIGNvdW50KCopIEZST00gaXNhbXBsZXNfZGF0YSBMSU1JVCAxYCk7XG4gICAgICBjb25zb2xlLmxvZyhcIuKchSBTdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIHJlbW90ZSBQYXJxdWV0IGZpbGVcIik7XG4gICAgICBcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5sb2coXCLinYwgRmFpbGVkIHRvIHJlYWQgcmVtb3RlIFBhcnF1ZXQ6XCIsIGVycm9yLm1lc3NhZ2UpO1xuICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhIHJhdGUgbGltaXRpbmcgZXJyb3JcbiAgICAgIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCc0MjknKSB8fCBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdUT08gTUFOWSBSRVFVRVNUUycpKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwi4o+zIFJhdGUgbGltaXRlZCAtIHN0b3JpbmcgZmFpbHVyZSB0aW1lXCIpO1xuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnemVub2RvX2xhc3RfZmFpbCcsIERhdGUubm93KCkudG9TdHJpbmcoKSk7XG4gICAgICB9XG4gICAgICAvLyBDcmVhdGUgZGVtbyBkYXRhIGFzIGZhbGxiYWNrXG4gICAgICBhd2FpdCBjcmVhdGVEZW1vRGF0YShjb25uKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgLy8gQ3JlYXRlIGRlbW8gZGF0YSBhcyBmYWxsYmFja1xuICAgIGF3YWl0IGNyZWF0ZURlbW9EYXRhKGNvbm4pO1xuICB9XG4gIFxuICByZXR1cm4gY29ubjtcbn1cblxuLy8gRnVuY3Rpb24gdG8gY3JlYXRlIGRlbW8gZGF0YSB3aGVuIHJlbW90ZSBmaWxlIGlzIG5vdCBhY2Nlc3NpYmxlXG5jcmVhdGVEZW1vRGF0YSA9IGFzeW5jIChjb25uKSA9PiB7XG4gIGNvbnNvbGUubG9nKFwiQ3JlYXRpbmcgZGVtbyBkYXRhc2V0Li4uXCIpO1xuICBcbiAgLy8gQ3JlYXRlIGEgZGVtbyB0YWJsZSB3aXRoIHNpbWlsYXIgc3RydWN0dXJlIGFuZCByZWFsaXN0aWMgZGF0YVxuICBhd2FpdCBjb25uLnF1ZXJ5KGBcbiAgICBDUkVBVEUgVEFCTEUgaXNhbXBsZXNfZGF0YSBBUyBcbiAgICBTRUxFQ1QgXG4gICAgICAnREVNT18nIHx8IGkgYXMgc2FtcGxlX2lkZW50aWZpZXIsXG4gICAgICBDQVNFIFxuICAgICAgICBXSEVOIGkgJSA0ID0gMCBUSEVOICdTRVNBUidcbiAgICAgICAgV0hFTiBpICUgNCA9IDEgVEhFTiAnT1BFTkNPTlRFWFQnIFxuICAgICAgICBXSEVOIGkgJSA0ID0gMiBUSEVOICdHRU9NRSdcbiAgICAgICAgRUxTRSAnU01JVEhTT05JQU4nXG4gICAgICBFTkQgYXMgc291cmNlX2NvbGxlY3Rpb24sXG4gICAgICBcbiAgICAgIC0tIEdlbmVyYXRlIHJlYWxpc3RpYyBjb29yZGluYXRlc1xuICAgICAgQ0FTRSBcbiAgICAgICAgV0hFTiBpICUgNSA9IDAgVEhFTiAtMTIwICsgKHJhbmRvbSgpICogNTApICAtLSBOb3J0aCBBbWVyaWNhXG4gICAgICAgIFdIRU4gaSAlIDUgPSAxIFRIRU4gLTEwICsgKHJhbmRvbSgpICogNDApICAgLS0gRXVyb3BlICBcbiAgICAgICAgV0hFTiBpICUgNSA9IDIgVEhFTiAxMDAgKyAocmFuZG9tKCkgKiA0MCkgICAtLSBBc2lhXG4gICAgICAgIFdIRU4gaSAlIDUgPSAzIFRIRU4gMTE1ICsgKHJhbmRvbSgpICogMzApICAgLS0gQXVzdHJhbGlhXG4gICAgICAgIEVMU0UgLTE4MCArIChyYW5kb20oKSAqIDM2MCkgIC0tIE90aGVyXG4gICAgICBFTkQgYXMgc2FtcGxlX2xvY2F0aW9uX2xvbmdpdHVkZSxcbiAgICAgIFxuICAgICAgQ0FTRSBcbiAgICAgICAgV0hFTiBpICUgNSA9IDAgVEhFTiAyNSArIChyYW5kb20oKSAqIDI1KSAgICAtLSBOb3J0aCBBbWVyaWNhXG4gICAgICAgIFdIRU4gaSAlIDUgPSAxIFRIRU4gMzUgKyAocmFuZG9tKCkgKiAzNSkgICAgLS0gRXVyb3BlXG4gICAgICAgIFdIRU4gaSAlIDUgPSAyIFRIRU4gMjAgKyAocmFuZG9tKCkgKiAzMCkgICAgLS0gQXNpYSAgXG4gICAgICAgIFdIRU4gaSAlIDUgPSAzIFRIRU4gLTQwICsgKHJhbmRvbSgpICogMzApICAgLS0gQXVzdHJhbGlhXG4gICAgICAgIEVMU0UgLTkwICsgKHJhbmRvbSgpICogMTgwKSAgIC0tIE90aGVyXG4gICAgICBFTkQgYXMgc2FtcGxlX2xvY2F0aW9uX2xhdGl0dWRlLFxuICAgICAgXG4gICAgICBDQVNFIFxuICAgICAgICBXSEVOIGkgJSA4ID0gMCBUSEVOICdyb2NrJ1xuICAgICAgICBXSEVOIGkgJSA4ID0gMSBUSEVOICdtaW5lcmFsJ1xuICAgICAgICBXSEVOIGkgJSA4ID0gMiBUSEVOICdzZWRpbWVudCcgXG4gICAgICAgIFdIRU4gaSAlIDggPSAzIFRIRU4gJ3NvaWwnXG4gICAgICAgIFdIRU4gaSAlIDggPSA0IFRIRU4gJ2Zvc3NpbCdcbiAgICAgICAgV0hFTiBpICUgOCA9IDUgVEhFTiAnbWV0ZW9yaXRlJ1xuICAgICAgICBXSEVOIGkgJSA4ID0gNiBUSEVOICdvcmdhbmljJ1xuICAgICAgICBFTFNFICdvdGhlcidcbiAgICAgIEVORCBhcyBoYXNfbWF0ZXJpYWxfY2F0ZWdvcnksXG4gICAgICBcbiAgICAgICdEZW1vIHNhbXBsZSAnIHx8IGkgYXMgbGFiZWxcbiAgICAgIFxuICAgIEZST00gZ2VuZXJhdGVfc2VyaWVzKDEsIDEwMDAwKSB0KGkpIC0tIEdlbmVyYXRlIDEwLDAwMCBkZW1vIHJlY29yZHNcbiAgYCk7XG4gIFxuICBjb25zb2xlLmxvZyhcIuKchSBEZW1vIGRhdGFzZXQgY3JlYXRlZCB3aXRoIDEwLDAwMCBzYW1wbGUgcmVjb3Jkc1wiKTtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxubWRgXG4jIyBDb25uZWN0aW9uIFN0YXR1c1xuXG4ke3dvcmtpbmdfcGFycXVldF91cmwgP1xuICBg4pyFICoqQ29ubmVjdGVkIHRvIGxpdmUgZGF0YSoqOiBVc2luZyAke3dvcmtpbmdfcGFycXVldF91cmwuaW5jbHVkZXMoJ3IyLmRldicpID8gJ0Nsb3VkZmxhcmUgUjInIDogd29ya2luZ19wYXJxdWV0X3VybC5pbmNsdWRlcygnemVub2RvLm9yZycpID8gJ1plbm9kbycgOiAnZmFsbGJhY2snfSBob3N0aW5nXG7wn5OKICoqRGF0YXNldCoqOiA2LjdNIE1hdGVyaWFsU2FtcGxlUmVjb3JkcyBmcm9tIGlTYW1wbGVzXG7wn4yQICoqRGF0YSBzb3VyY2UqKjogJHt3b3JraW5nX3BhcnF1ZXRfdXJsfWBcbiAgOlxuICBg4pqg77iPICoqVXNpbmcgZGVtbyBkYXRhKio6IFJlbW90ZSBmaWxlIG5vdCBhY2Nlc3NpYmxlIGR1ZSB0byBDT1JTIHJlc3RyaWN0aW9uc1xu8J+TiiAqKkRhdGFzZXQqKjogMTBLIHN5bnRoZXRpYyByZWNvcmRzIHdpdGggcmVhbGlzdGljIHN0cnVjdHVyZVxu8J+SoSAqKk5vdGUqKjogVGhpcyBkZW1vbnN0cmF0ZXMgdGhlIHNhbWUgYW5hbHlzaXMgcGF0dGVybnMgd2l0aCByZXByZXNlbnRhdGl2ZSBkYXRhYFxufVxuYFxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC00IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG4vLyBHZXQgdG90YWwgcmVjb3JkIGNvdW50IC0gdGhpcyBvbmx5IHJlYWRzIG1ldGFkYXRhIVxudG90YWxfY291bnQgPSB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRiLnF1ZXJ5KGBTRUxFQ1QgY291bnQoKikgYXMgdG90YWwgRlJPTSBpc2FtcGxlc19kYXRhYCk7XG4gIGNvbnN0IHJvd3MgPSByZXN1bHQudG9BcnJheSgpO1xuICByZXR1cm4gTnVtYmVyKHJvd3NbMF0udG90YWwpOyAvLyBDb252ZXJ0IEJpZ0ludCB0byBOdW1iZXJcbn1cblxuLy8gQ291bnQgcmVjb3JkcyB3aXRoIGdlb2dyYXBoaWMgY29vcmRpbmF0ZXNcbmdlb19jb3VudCA9IHtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGIucXVlcnkoYFxuICAgIFNFTEVDVCBjb3VudCgqKSBhcyBnZW9fdG90YWwgXG4gICAgRlJPTSBpc2FtcGxlc19kYXRhIFxuICAgIFdIRVJFIHNhbXBsZV9sb2NhdGlvbl9sYXRpdHVkZSBJUyBOT1QgTlVMTCBcbiAgICBBTkQgc2FtcGxlX2xvY2F0aW9uX2xvbmdpdHVkZSBJUyBOT1QgTlVMTFxuICBgKTtcbiAgY29uc3Qgcm93cyA9IHJlc3VsdC50b0FycmF5KCk7XG4gIHJldHVybiBOdW1iZXIocm93c1swXS5nZW9fdG90YWwpOyAvLyBDb252ZXJ0IEJpZ0ludCB0byBOdW1iZXJcbn1cblxuLy8gQ2FsY3VsYXRlIHBlcmNlbnRhZ2Ugd2l0aCBjb29yZGluYXRlc1xuZ2VvX3BlcmNlbnRhZ2UgPSBNYXRoLnJvdW5kKChnZW9fY291bnQgLyB0b3RhbF9jb3VudCkgKiAxMDApXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTUiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbm1kYFxuIyMgRGF0YXNldCBPdmVydmlld1xuXG4tICoqVG90YWwgcmVjb3JkcyoqOiAke3RvdGFsX2NvdW50LnRvTG9jYWxlU3RyaW5nKCl9XG4tICoqUmVjb3JkcyB3aXRoIGNvb3JkaW5hdGVzKio6ICR7Z2VvX2NvdW50LnRvTG9jYWxlU3RyaW5nKCl9ICgke2dlb19wZXJjZW50YWdlfSUpXG4tICoqRGF0YSBzb3VyY2UqKjogJHt3b3JraW5nX3BhcnF1ZXRfdXJsID8gJ1JlbW90ZSBQYXJxdWV0IGZpbGUgKH4zMDAgTUIpJyA6ICdEZW1vIGRhdGFzZXQgKHN5bnRoZXRpYyknfVxuLSAqKkRhdGEgdHJhbnNmZXJyZWQgZm9yIHRoZXNlIHN0YXRzKio6IDwgMSBLQiAobWV0YWRhdGEgb25seSEpXG5gXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTYiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbi8vIEdldCBzb3VyY2UgY29sbGVjdGlvbiBjb3VudHNcbnNvdXJjZV9kYXRhID0ge1xuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYi5xdWVyeShgXG4gICAgU0VMRUNUIFxuICAgICAgc291cmNlX2NvbGxlY3Rpb24sIFxuICAgICAgY291bnQoKikgYXMgc2FtcGxlX2NvdW50LFxuICAgICAgY291bnQoQ0FTRSBXSEVOIHNhbXBsZV9sb2NhdGlvbl9sYXRpdHVkZSBJUyBOT1QgTlVMTCBcbiAgICAgICAgICAgICAgICAgIEFORCBzYW1wbGVfbG9jYXRpb25fbG9uZ2l0dWRlIElTIE5PVCBOVUxMIFxuICAgICAgICAgICAgICAgICAgVEhFTiAxIEVORCkgYXMgZ2VvX2NvdW50XG4gICAgRlJPTSBpc2FtcGxlc19kYXRhIFxuICAgIEdST1VQIEJZIHNvdXJjZV9jb2xsZWN0aW9uIFxuICAgIE9SREVSIEJZIHNhbXBsZV9jb3VudCBERVNDXG4gIGApO1xuICAvLyBDb252ZXJ0IEJpZ0ludCB2YWx1ZXMgdG8gTnVtYmVyc1xuICBjb25zdCBwcm9jZXNzZWREYXRhID0gcmVzdWx0LnRvQXJyYXkoKS5tYXAocm93ID0+ICh7XG4gICAgLi4ucm93LFxuICAgIHNhbXBsZV9jb3VudDogTnVtYmVyKHJvdy5zYW1wbGVfY291bnQpLFxuICAgIGdlb19jb3VudDogTnVtYmVyKHJvdy5nZW9fY291bnQpXG4gIH0pKTtcbiAgXG4gIHJldHVybiBwcm9jZXNzZWREYXRhO1xufVxuXG4vLyBDcmVhdGUgaW50ZXJhY3RpdmUgdGFibGUgc2hvd2luZyBzb3VyY2UgZGlzdHJpYnV0aW9uXG52aWV3b2Ygc291cmNlX3RhYmxlID0gSW5wdXRzLnRhYmxlKHNvdXJjZV9kYXRhLCB7XG4gIGNvbHVtbnM6IFtcbiAgICBcInNvdXJjZV9jb2xsZWN0aW9uXCIsXG4gICAgXCJzYW1wbGVfY291bnRcIiwgXG4gICAgXCJnZW9fY291bnRcIlxuICBdLFxuICBoZWFkZXI6IHtcbiAgICBzb3VyY2VfY29sbGVjdGlvbjogXCJTb3VyY2UgQ29sbGVjdGlvblwiLFxuICAgIHNhbXBsZV9jb3VudDogXCJUb3RhbCBTYW1wbGVzXCIsXG4gICAgZ2VvX2NvdW50OiBcIlNhbXBsZXMgd2l0aCBDb29yZGluYXRlc1wiXG4gIH0sXG4gIGZvcm1hdDoge1xuICAgIHNhbXBsZV9jb3VudDogZDMuZm9ybWF0KFwiLFwiKSxcbiAgICBnZW9fY291bnQ6IGQzLmZvcm1hdChcIixcIilcbiAgfVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtNyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuLy8gQ3JlYXRlIGJhciBjaGFydCBvZiBzb3VyY2UgY29sbGVjdGlvbnNcbnNvdXJjZV9jaGFydCA9IHtcbiAgLy8gVmFsaWRhdGUgdGhhdCBzb3VyY2VfZGF0YSBpcyBhbiBhcnJheVxuICBpZiAoIUFycmF5LmlzQXJyYXkoc291cmNlX2RhdGEpKSB7XG4gICAgcmV0dXJuIGh0bWxgPGRpdj5FcnJvcjogU291cmNlIGRhdGEgaXMgbm90IGF2YWlsYWJsZTwvZGl2PmA7XG4gIH1cbiAgXG4gIHJldHVybiBQbG90LnBsb3Qoe1xuICAgIHRpdGxlOiBcIlNhbXBsZSBEaXN0cmlidXRpb24gYnkgU291cmNlIENvbGxlY3Rpb25cIixcbiAgICB4OiB7XG4gICAgICBsYWJlbDogXCJOdW1iZXIgb2Ygc2FtcGxlc1wiLFxuICAgICAgdGlja0Zvcm1hdDogXCJ+c1wiXG4gICAgfSxcbiAgICB5OiB7XG4gICAgICBsYWJlbDogXCJTb3VyY2UgQ29sbGVjdGlvblwiLFxuICAgICAgZG9tYWluOiBzb3VyY2VfZGF0YS5tYXAoZCA9PiBkLnNvdXJjZV9jb2xsZWN0aW9uKVxuICAgIH0sXG4gICAgbWFya3M6IFtcbiAgICAgIFBsb3QuYmFyWChzb3VyY2VfZGF0YSwge1xuICAgICAgICB4OiBcInNhbXBsZV9jb3VudFwiLFxuICAgICAgICB5OiBcInNvdXJjZV9jb2xsZWN0aW9uXCIsXG4gICAgICAgIGZpbGw6IFwic3RlZWxibHVlXCIsXG4gICAgICAgIHNvcnQ6IHt5OiBcInhcIiwgcmV2ZXJzZTogdHJ1ZX1cbiAgICAgIH0pLFxuICAgICAgUGxvdC50ZXh0KHNvdXJjZV9kYXRhLCB7XG4gICAgICAgIHg6IFwic2FtcGxlX2NvdW50XCIsXG4gICAgICAgIHk6IFwic291cmNlX2NvbGxlY3Rpb25cIixcbiAgICAgICAgdGV4dDogZCA9PiBkMy5mb3JtYXQoXCJ+c1wiKShkLnNhbXBsZV9jb3VudCksXG4gICAgICAgIGR4OiAxMCxcbiAgICAgICAgdGV4dEFuY2hvcjogXCJzdGFydFwiXG4gICAgICB9KVxuICAgIF0sXG4gICAgbWFyZ2luTGVmdDogMTIwLFxuICAgIGhlaWdodDogMjUwLFxuICAgIHdpZHRoOiA2MDBcbiAgfSk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTgiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbi8vIEdldCBnZW9ncmFwaGljIHN0YXRpc3RpY3Ncbmdlb19zdGF0cyA9IHtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGIucXVlcnkoYFxuICAgIFNFTEVDVCBcbiAgICAgIGNvdW50KCopIGFzIHRvdGFsX3dpdGhfY29vcmRzLFxuICAgICAgbWluKHNhbXBsZV9sb2NhdGlvbl9sYXRpdHVkZSkgYXMgbWluX2xhdCxcbiAgICAgIG1heChzYW1wbGVfbG9jYXRpb25fbGF0aXR1ZGUpIGFzIG1heF9sYXQsXG4gICAgICBhdmcoc2FtcGxlX2xvY2F0aW9uX2xhdGl0dWRlKSBhcyBhdmdfbGF0LFxuICAgICAgbWluKHNhbXBsZV9sb2NhdGlvbl9sb25naXR1ZGUpIGFzIG1pbl9sb24sXG4gICAgICBtYXgoc2FtcGxlX2xvY2F0aW9uX2xvbmdpdHVkZSkgYXMgbWF4X2xvbixcbiAgICAgIGF2ZyhzYW1wbGVfbG9jYXRpb25fbG9uZ2l0dWRlKSBhcyBhdmdfbG9uXG4gICAgRlJPTSBpc2FtcGxlc19kYXRhIFxuICAgIFdIRVJFIHNhbXBsZV9sb2NhdGlvbl9sYXRpdHVkZSBJUyBOT1QgTlVMTCBcbiAgICBBTkQgc2FtcGxlX2xvY2F0aW9uX2xvbmdpdHVkZSBJUyBOT1QgTlVMTFxuICBgKTtcbiAgY29uc3Qgcm93cyA9IHJlc3VsdC50b0FycmF5KCk7XG4gIGNvbnN0IHJvdyA9IHJvd3NbMF07XG4gIC8vIENvbnZlcnQgQmlnSW50IHZhbHVlcyB0byBOdW1iZXJzIHdoZXJlIG5lZWRlZFxuICByZXR1cm4ge1xuICAgIC4uLnJvdyxcbiAgICB0b3RhbF93aXRoX2Nvb3JkczogTnVtYmVyKHJvdy50b3RhbF93aXRoX2Nvb3JkcylcbiAgfTtcbn1cblxuLy8gRGF0YS1kcml2ZW4gcmVnaW9uYWwgYW5hbHlzaXMgdXNpbmcgSDMgcmVzNCBjZWxsIGdyb3VwaW5nXG4vLyBSZXBsYWNlcyBoYXJkY29kZWQgQ0FTRSBXSEVOIGJvdW5kaW5nIGJveGVzIHdpdGggZHluYW1pYyBkaXNjb3ZlcnlcbnJlZ2lvbmFsX2RhdGEgPSB7XG4gIC8vIENoZWNrIGlmIGgzX3JlczQgY29sdW1uIGV4aXN0cyAoSDMtaW5kZXhlZCBmaWxlKVxuICBsZXQgaGFzSDMgPSBmYWxzZTtcbiAgdHJ5IHtcbiAgICBjb25zdCBjb2xDaGVjayA9IGF3YWl0IGRiLnF1ZXJ5KGBTRUxFQ1QgaDNfcmVzNCBGUk9NIGlzYW1wbGVzX2RhdGEgTElNSVQgMWApO1xuICAgIGhhc0gzID0gdHJ1ZTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGhhc0gzID0gZmFsc2U7XG4gIH1cblxuICBpZiAoaGFzSDMpIHtcbiAgICAvLyBIMy1iYXNlZCByZWdpb25hbCBncm91cGluZzogZGlzY292ZXIgZGVuc2UgY2x1c3RlcnMgZHluYW1pY2FsbHlcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYi5xdWVyeShgXG4gICAgICBTRUxFQ1RcbiAgICAgICAgaDNfcmVzNCxcbiAgICAgICAgQ09VTlQoKikgYXMgc2FtcGxlX2NvdW50LFxuICAgICAgICBBVkcoc2FtcGxlX2xvY2F0aW9uX2xhdGl0dWRlKSBhcyBhdmdfbGF0LFxuICAgICAgICBBVkcoc2FtcGxlX2xvY2F0aW9uX2xvbmdpdHVkZSkgYXMgYXZnX2xvbixcbiAgICAgICAgQ09VTlQoRElTVElOQ1Qgc291cmNlX2NvbGxlY3Rpb24pIGFzIHNvdXJjZV9jb3VudCxcbiAgICAgICAgTU9ERShzb3VyY2VfY29sbGVjdGlvbikgYXMgZG9taW5hbnRfc291cmNlXG4gICAgICBGUk9NIGlzYW1wbGVzX2RhdGFcbiAgICAgIFdIRVJFIHNhbXBsZV9sb2NhdGlvbl9sYXRpdHVkZSBJUyBOT1QgTlVMTFxuICAgICAgICBBTkQgc2FtcGxlX2xvY2F0aW9uX2xvbmdpdHVkZSBJUyBOT1QgTlVMTFxuICAgICAgICBBTkQgaDNfcmVzNCBJUyBOT1QgTlVMTFxuICAgICAgR1JPVVAgQlkgaDNfcmVzNFxuICAgICAgSEFWSU5HIENPVU5UKCopID4gMTAwXG4gICAgICBPUkRFUiBCWSBzYW1wbGVfY291bnQgREVTQ1xuICAgIGApO1xuICAgIC8vIEFzc2lnbiByZWdpb24gbGFiZWxzIGJhc2VkIG9uIGNlbnRyb2lkIGxvY2F0aW9uXG4gICAgcmV0dXJuIHJlc3VsdC50b0FycmF5KCkubWFwKHJvdyA9PiB7XG4gICAgICBjb25zdCBsYXQgPSByb3cuYXZnX2xhdDtcbiAgICAgIGNvbnN0IGxvbiA9IHJvdy5hdmdfbG9uO1xuICAgICAgbGV0IHJlZ2lvbjtcbiAgICAgIGlmIChsb24gPj0gLTEzMCAmJiBsb24gPD0gLTYwICYmIGxhdCA+PSAyMCAmJiBsYXQgPD0gNTUpIHJlZ2lvbiA9ICdOb3J0aCBBbWVyaWNhJztcbiAgICAgIGVsc2UgaWYgKGxvbiA+PSAtMTUgJiYgbG9uIDw9IDQ1ICYmIGxhdCA+PSAzMCAmJiBsYXQgPD0gNzUpIHJlZ2lvbiA9ICdFdXJvcGUnO1xuICAgICAgZWxzZSBpZiAobG9uID49IDkwICYmIGxvbiA8PSAxNTAgJiYgbGF0ID49IDE1ICYmIGxhdCA8PSA1NSkgcmVnaW9uID0gJ0Vhc3QgQXNpYSc7XG4gICAgICBlbHNlIGlmIChsb24gPj0gMTEwICYmIGxvbiA8PSAxNjAgJiYgbGF0ID49IC01MCAmJiBsYXQgPD0gLTUpIHJlZ2lvbiA9ICdBdXN0cmFsaWEnO1xuICAgICAgZWxzZSBpZiAobG9uID49IC05MCAmJiBsb24gPD0gLTMwICYmIGxhdCA+PSAtNjAgJiYgbGF0IDw9IDE1KSByZWdpb24gPSAnU291dGggQW1lcmljYSc7XG4gICAgICBlbHNlIGlmIChsb24gPj0gLTIwICYmIGxvbiA8PSA1NSAmJiBsYXQgPj0gLTQwICYmIGxhdCA8PSAzMCkgcmVnaW9uID0gJ0FmcmljYSc7XG4gICAgICBlbHNlIHJlZ2lvbiA9ICdPdGhlcic7XG4gICAgICByZXR1cm4ge1xuICAgICAgICByZWdpb24sXG4gICAgICAgIHNvdXJjZV9jb2xsZWN0aW9uOiByb3cuZG9taW5hbnRfc291cmNlLFxuICAgICAgICBzYW1wbGVfY291bnQ6IE51bWJlcihyb3cuc2FtcGxlX2NvdW50KSxcbiAgICAgICAgYXZnX2xhdDogcm93LmF2Z19sYXQsXG4gICAgICAgIGF2Z19sb246IHJvdy5hdmdfbG9uLFxuICAgICAgICBoM19jZWxsOiByb3cuaDNfcmVzNCxcbiAgICAgICAgc291cmNlX2NvdW50OiBOdW1iZXIocm93LnNvdXJjZV9jb3VudClcbiAgICAgIH07XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gRmFsbGJhY2sgZm9yIG5vbi1IMyBmaWxlczogdXNlIHNpbXBsZSBsYXQvbG9uLWJhc2VkIGdyb3VwaW5nXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGIucXVlcnkoYFxuICAgICAgU0VMRUNUXG4gICAgICAgIHNvdXJjZV9jb2xsZWN0aW9uLFxuICAgICAgICBjb3VudCgqKSBhcyBzYW1wbGVfY291bnQsXG4gICAgICAgIGF2ZyhzYW1wbGVfbG9jYXRpb25fbGF0aXR1ZGUpIGFzIGF2Z19sYXQsXG4gICAgICAgIGF2ZyhzYW1wbGVfbG9jYXRpb25fbG9uZ2l0dWRlKSBhcyBhdmdfbG9uXG4gICAgICBGUk9NIGlzYW1wbGVzX2RhdGFcbiAgICAgIFdIRVJFIHNhbXBsZV9sb2NhdGlvbl9sYXRpdHVkZSBJUyBOT1QgTlVMTFxuICAgICAgICBBTkQgc2FtcGxlX2xvY2F0aW9uX2xvbmdpdHVkZSBJUyBOT1QgTlVMTFxuICAgICAgR1JPVVAgQlkgc291cmNlX2NvbGxlY3Rpb25cbiAgICAgIE9SREVSIEJZIHNhbXBsZV9jb3VudCBERVNDXG4gICAgYCk7XG4gICAgcmV0dXJuIHJlc3VsdC50b0FycmF5KCkubWFwKHJvdyA9PiB7XG4gICAgICBjb25zdCBsYXQgPSByb3cuYXZnX2xhdDtcbiAgICAgIGNvbnN0IGxvbiA9IHJvdy5hdmdfbG9uO1xuICAgICAgbGV0IHJlZ2lvbiA9ICdPdGhlcic7XG4gICAgICBpZiAobG9uID49IC0xMzAgJiYgbG9uIDw9IC02MCAmJiBsYXQgPj0gMjAgJiYgbGF0IDw9IDU1KSByZWdpb24gPSAnTm9ydGggQW1lcmljYSc7XG4gICAgICBlbHNlIGlmIChsb24gPj0gLTE1ICYmIGxvbiA8PSA0NSAmJiBsYXQgPj0gMzAgJiYgbGF0IDw9IDc1KSByZWdpb24gPSAnRXVyb3BlJztcbiAgICAgIGVsc2UgaWYgKGxvbiA+PSA5MCAmJiBsb24gPD0gMTUwICYmIGxhdCA+PSAxNSAmJiBsYXQgPD0gNTUpIHJlZ2lvbiA9ICdFYXN0IEFzaWEnO1xuICAgICAgZWxzZSBpZiAobG9uID49IDExMCAmJiBsb24gPD0gMTYwICYmIGxhdCA+PSAtNTAgJiYgbGF0IDw9IC01KSByZWdpb24gPSAnQXVzdHJhbGlhJztcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHJlZ2lvbixcbiAgICAgICAgc291cmNlX2NvbGxlY3Rpb246IHJvdy5zb3VyY2VfY29sbGVjdGlvbixcbiAgICAgICAgc2FtcGxlX2NvdW50OiBOdW1iZXIocm93LnNhbXBsZV9jb3VudCksXG4gICAgICAgIGF2Z19sYXQ6IHJvdy5hdmdfbGF0LFxuICAgICAgICBhdmdfbG9uOiByb3cuYXZnX2xvblxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxufVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC05IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5tZGBcbiMjIEdlb2dyYXBoaWMgU3RhdGlzdGljc1xuXG4tICoqTGF0aXR1ZGUgcmFuZ2UqKjogJHtnZW9fc3RhdHMubWluX2xhdC50b0ZpeGVkKDMpfcKwIHRvICR7Z2VvX3N0YXRzLm1heF9sYXQudG9GaXhlZCgzKX3CsFxuLSAqKkxvbmdpdHVkZSByYW5nZSoqOiAke2dlb19zdGF0cy5taW5fbG9uLnRvRml4ZWQoMyl9wrAgdG8gJHtnZW9fc3RhdHMubWF4X2xvbi50b0ZpeGVkKDMpfcKwXG4tICoqQXZlcmFnZSBsb2NhdGlvbioqOiAke2dlb19zdGF0cy5hdmdfbGF0LnRvRml4ZWQoMyl9wrAsICR7Z2VvX3N0YXRzLmF2Z19sb24udG9GaXhlZCgzKX3CsFxuLSAqKkRlbnNlIEgzIGNsdXN0ZXJzKio6ICR7cmVnaW9uYWxfZGF0YS5sZW5ndGh9IChjZWxscyB3aXRoID4xMDAgc2FtcGxlcylcbi0gKipSZWdpb25zIGRpc2NvdmVyZWQqKjogJHtbLi4ubmV3IFNldChyZWdpb25hbF9kYXRhLm1hcChkID0+IGQucmVnaW9uKSldLmpvaW4oJywgJyl9XG5cbipSZWdpb25hbCBncm91cGluZyBpcyBkYXRhLWRyaXZlbiB1c2luZyBIMyByZXNvbHV0aW9uLTQgaGV4YWdvbmFsIGNlbGxzLCByZXBsYWNpbmcgaGFyZGNvZGVkIGJvdW5kaW5nIGJveGVzLipcbmBcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTAiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbi8vIEludGVyYWN0aXZlIHJlZ2lvbiBzZWxlY3Rvclxudmlld29mIHNlbGVjdGVkX3JlZ2lvbiA9IElucHV0cy5zZWxlY3QoXG4gIFtcIkFsbFwiLCAuLi5uZXcgU2V0KHJlZ2lvbmFsX2RhdGE/Lm1hcD8uKGQgPT4gZC5yZWdpb24pIHx8IFtdKV0sXG4gIHtcbiAgICBsYWJlbDogXCJTZWxlY3QgUmVnaW9uOlwiLFxuICAgIHZhbHVlOiBcIkFsbFwiXG4gIH1cbilcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTEiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbi8vIFJlZ2lvbmFsIGRpc3RyaWJ1dGlvbiBjaGFydCAoZGF0YS1kcml2ZW4gZnJvbSBIMyBjbHVzdGVycylcbnJlZ2lvbmFsX2NoYXJ0ID0ge1xuICBpZiAoIUFycmF5LmlzQXJyYXkocmVnaW9uYWxfZGF0YSkpIHtcbiAgICByZXR1cm4gaHRtbGA8ZGl2PkVycm9yOiBSZWdpb25hbCBkYXRhIGlzIG5vdCBhdmFpbGFibGU8L2Rpdj5gO1xuICB9XG5cbiAgLy8gQWdncmVnYXRlIEgzIGNlbGwgZGF0YSBieSBkaXNjb3ZlcmVkIHJlZ2lvblxuICBjb25zdCByZWdpb25Ub3RhbHMgPSBkMy5yb2xsdXAoXG4gICAgcmVnaW9uYWxfZGF0YSxcbiAgICB2ID0+IGQzLnN1bSh2LCBkID0+IGQuc2FtcGxlX2NvdW50KSxcbiAgICBkID0+IGQucmVnaW9uXG4gICk7XG5cbiAgY29uc3QgYWdncmVnYXRlZERhdGEgPSBBcnJheS5mcm9tKHJlZ2lvblRvdGFscywgKFtyZWdpb24sIHRvdGFsXSkgPT4gKHtcbiAgICByZWdpb246IHJlZ2lvbixcbiAgICBzYW1wbGVfY291bnQ6IHRvdGFsXG4gIH0pKS5zb3J0KChhLCBiKSA9PiBiLnNhbXBsZV9jb3VudCAtIGEuc2FtcGxlX2NvdW50KTtcblxuICByZXR1cm4gUGxvdC5wbG90KHtcbiAgICB0aXRsZTogYFNhbXBsZSBEaXN0cmlidXRpb24gYnkgUmVnaW9uIChIMy1kZXJpdmVkLCAke2FnZ3JlZ2F0ZWREYXRhLmxlbmd0aH0gcmVnaW9ucylgLFxuICAgIHdpZHRoOiA3MDAsXG4gICAgaGVpZ2h0OiAzMDAsXG4gICAgbWFyZ2luTGVmdDogMTIwLFxuICAgIHg6IHtcbiAgICAgIGxhYmVsOiBcIk51bWJlciBvZiBzYW1wbGVzXCIsXG4gICAgICB0aWNrRm9ybWF0OiBcIn5zXCJcbiAgICB9LFxuICAgIHk6IHtcbiAgICAgIGxhYmVsOiBcIlJlZ2lvblwiLFxuICAgICAgZG9tYWluOiBhZ2dyZWdhdGVkRGF0YS5tYXAoZCA9PiBkLnJlZ2lvbilcbiAgICB9LFxuICAgIG1hcmtzOiBbXG4gICAgICBQbG90LmJhclgoYWdncmVnYXRlZERhdGEsIHtcbiAgICAgICAgeDogXCJzYW1wbGVfY291bnRcIixcbiAgICAgICAgeTogXCJyZWdpb25cIixcbiAgICAgICAgZmlsbDogXCJzdGVlbGJsdWVcIixcbiAgICAgICAgc29ydDoge3k6IFwieFwiLCByZXZlcnNlOiB0cnVlfVxuICAgICAgfSksXG4gICAgICBQbG90LnRleHQoYWdncmVnYXRlZERhdGEsIHtcbiAgICAgICAgeDogXCJzYW1wbGVfY291bnRcIixcbiAgICAgICAgeTogXCJyZWdpb25cIixcbiAgICAgICAgdGV4dDogZCA9PiBkMy5mb3JtYXQoXCJ+c1wiKShkLnNhbXBsZV9jb3VudCksXG4gICAgICAgIGR4OiAxMCxcbiAgICAgICAgdGV4dEFuY2hvcjogXCJzdGFydFwiXG4gICAgICB9KVxuICAgIF1cbiAgfSk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTEyIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG4vLyBTYW1wbGUgc2l6ZSBjb250cm9sXG52aWV3b2Ygc2FtcGxlX3NpemUgPSBJbnB1dHMucmFuZ2UoWzEwMDAsIDUwMDAwXSwge1xuICBsYWJlbDogXCJTYW1wbGUgU2l6ZTpcIixcbiAgc3RlcDogMTAwMCxcbiAgdmFsdWU6IDEwMDAwXG59KVxuXG4vLyBTYW1wbGUgcGVyIGNvbGxlY3Rpb24gbGltaXRcbnZpZXdvZiBtYXhfcGVyX2NvbGxlY3Rpb24gPSBJbnB1dHMucmFuZ2UoWzUwMCwgNTAwMF0sIHtcbiAgbGFiZWw6IFwiTWF4IHBlciBDb2xsZWN0aW9uOlwiLFxuICBzdGVwOiAyNTAsXG4gIHZhbHVlOiAyNTAwXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0xMyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IlxuLy8gQ3JlYXRlIHN0cmF0aWZpZWQgc2FtcGxlIC0gc2ltcGxpZmllZCBmb3IgRHVja0RCLVdBU00gY29tcGF0aWJpbGl0eVxuc2FtcGxlX2RhdGEgPSB7XG4gIC8vIEluIE9ic2VydmFibGUsIGlucHV0cyBhcmUgYXV0b21hdGljYWxseSByZWFjdGl2ZSB2YWx1ZXNcbiAgY29uc3QgbWF4UGVyQ29sbGVjdGlvbiA9IG1heF9wZXJfY29sbGVjdGlvbjtcbiAgY29uc3Qgc2FtcGxlU2l6ZVZhbHVlID0gc2FtcGxlX3NpemU7XG4gIFxuICAvLyBVc2UgYSBmaXhlZCBzYW1wbGluZyByYXRlIHRvIGF2b2lkIE5hTiBpc3N1ZXNcbiAgY29uc3Qgc2FtcGxpbmdSYXRlID0gMC4xOyAvLyBTYW1wbGUgMTAlIG9mIGRhdGFcbiAgXG4gIC8vIFZhbGlkYXRlIHRoYXQgYWxsIHZhbHVlcyBhcmUgcHJvcGVyIG51bWJlcnNcbiAgaWYgKGlzTmFOKG1heFBlckNvbGxlY3Rpb24pIHx8IGlzTmFOKHNhbXBsZVNpemVWYWx1ZSkgfHwgaXNOYU4oc2FtcGxpbmdSYXRlKSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgbnVtZXJpYyB2YWx1ZXMgZGV0ZWN0ZWQnLCB7bWF4UGVyQ29sbGVjdGlvbiwgc2FtcGxlU2l6ZVZhbHVlLCBzYW1wbGluZ1JhdGV9KTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc2FtcGxpbmcgcGFyYW1ldGVycycpO1xuICB9XG4gIFxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYi5xdWVyeShgXG4gICAgV0lUSCBzYW1wbGVkX2RhdGEgQVMgKFxuICAgICAgU0VMRUNUIFxuICAgICAgICBzYW1wbGVfaWRlbnRpZmllcixcbiAgICAgICAgc291cmNlX2NvbGxlY3Rpb24sXG4gICAgICAgIHNhbXBsZV9sb2NhdGlvbl9sb25naXR1ZGUgYXMgbG9uZ2l0dWRlLFxuICAgICAgICBzYW1wbGVfbG9jYXRpb25fbGF0aXR1ZGUgYXMgbGF0aXR1ZGUsXG4gICAgICAgIGhhc19tYXRlcmlhbF9jYXRlZ29yeSxcbiAgICAgICAgbGFiZWxcbiAgICAgIEZST00gaXNhbXBsZXNfZGF0YSBcbiAgICAgIFdIRVJFIHNhbXBsZV9sb2NhdGlvbl9sYXRpdHVkZSBJUyBOT1QgTlVMTCBcbiAgICAgIEFORCBzYW1wbGVfbG9jYXRpb25fbG9uZ2l0dWRlIElTIE5PVCBOVUxMXG4gICAgICBBTkQgcmFuZG9tKCkgPCAke3NhbXBsaW5nUmF0ZX1cbiAgICApXG4gICAgU0VMRUNUICogRlJPTSBzYW1wbGVkX2RhdGFcbiAgICBMSU1JVCAke3NhbXBsZVNpemVWYWx1ZX1cbiAgYCk7XG4gIHJldHVybiByZXN1bHQudG9BcnJheSgpO1xufVxuXG4vLyBDYWxjdWxhdGUgc2FtcGxlIHN0YXRpc3RpY3NcbnNhbXBsZV9zdGF0cyA9IHtcbiAgY29uc3QgdG90YWwgPSBzYW1wbGVfZGF0YS5sZW5ndGg7XG4gIGNvbnN0IGJ5X3NvdXJjZSA9IGQzLnJvbGx1cChzYW1wbGVfZGF0YSwgdiA9PiB2Lmxlbmd0aCwgZCA9PiBkLnNvdXJjZV9jb2xsZWN0aW9uKTtcbiAgcmV0dXJuIHtcbiAgICB0b3RhbCxcbiAgICBieV9zb3VyY2U6IEFycmF5LmZyb20oYnlfc291cmNlLCAoW3NvdXJjZSwgY291bnRdKSA9PiAoe3NvdXJjZSwgY291bnR9KSlcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBiLmNvdW50IC0gYS5jb3VudClcbiAgfTtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTQiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbm1kYFxuIyMgU2FtcGxlIFN0YXRpc3RpY3NcblxuKipUb3RhbCBzYW1wbGUgc2l6ZSoqOiAke3NhbXBsZV9zdGF0cy50b3RhbC50b0xvY2FsZVN0cmluZygpfSBwb2ludHMgIFxuKipEYXRhIHRyYW5zZmVyKio6IH4ke01hdGgucm91bmQoc2FtcGxlX3N0YXRzLnRvdGFsICogNiAqIDggLyAxMDI0IC8gMTAyNCl9IE1CIChlc3RpbWF0ZWQpICBcbioqUmVkdWN0aW9uIGZhY3RvcioqOiAke01hdGgucm91bmQoZ2VvX2NvdW50IC8gc2FtcGxlX3N0YXRzLnRvdGFsKX14IGZld2VyIHBvaW50c1xuXG4qKkRpc3RyaWJ1dGlvbiBieSBzb3VyY2UqKjpcbiR7c2FtcGxlX3N0YXRzLmJ5X3NvdXJjZS5tYXAoZCA9PiBgLSAke2Quc291cmNlfTogJHtkLmNvdW50LnRvTG9jYWxlU3RyaW5nKCl9YCkuam9pbignXFxuJyl9XG5gXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE1IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG4vLyBNYXAgcHJvamVjdGlvbiBzZWxlY3Rvclxudmlld29mIHByb2plY3Rpb24gPSBJbnB1dHMuc2VsZWN0KFtcbiAgXCJlcXVpcmVjdGFuZ3VsYXJcIixcbiAgXCJvcnRob2dyYXBoaWNcIixcbiAgXCJtZXJjYXRvclwiXG5dLCB7XG4gIGxhYmVsOiBcIk1hcCBQcm9qZWN0aW9uOlwiLFxuICB2YWx1ZTogXCJlcXVpcmVjdGFuZ3VsYXJcIlxufSlcblxuLy8gUG9pbnQgc2l6ZSBjb250cm9sXG52aWV3b2YgcG9pbnRfc2l6ZSA9IElucHV0cy5yYW5nZShbMC41LCA1XSwge1xuICBsYWJlbDogXCJQb2ludCBTaXplOlwiLFxuICBzdGVwOiAwLjEsXG4gIHZhbHVlOiAxLjVcbn0pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTE2IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG4vLyBMb2FkIHdvcmxkIG1hcCBkYXRhXG53b3JsZCA9IGZldGNoKFwiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS93b3JsZC1hdGxhc0AyL2NvdW50cmllcy0xMTBtLmpzb25cIilcbiAgLnRoZW4ocmVzcG9uc2UgPT4gcmVzcG9uc2UuanNvbigpKVxuXG4vLyBDcmVhdGUgd29ybGQgbWFwIHdpdGggc2FtcGxlIHBvaW50c1xud29ybGRfbWFwID0ge1xuICAvLyBBd2FpdCB0aGUgd29ybGQgZGF0YVxuICBjb25zdCB3b3JsZERhdGEgPSBhd2FpdCB3b3JsZDtcbiAgY29uc3QgY291bnRyaWVzID0gdG9wb2pzb24uZmVhdHVyZSh3b3JsZERhdGEsIHdvcmxkRGF0YS5vYmplY3RzLmNvdW50cmllcyk7XG4gIFxuICAvLyBJbiBPYnNlcnZhYmxlLCBpbnB1dHMgYXJlIGF1dG9tYXRpY2FsbHkgcmVhY3RpdmUgdmFsdWVzXG4gIGxldCBwb2ludFJhZGl1cyA9IHBvaW50X3NpemU7XG4gIGNvbnN0IG1hcFByb2plY3Rpb24gPSBwcm9qZWN0aW9uO1xuICBcbiAgLy8gVmFsaWRhdGUgdGhhdCBwb2ludFJhZGl1cyBpcyBhIHByb3BlciBudW1iZXJcbiAgaWYgKGlzTmFOKHBvaW50UmFkaXVzKSB8fCBwb2ludFJhZGl1cyA8PSAwKSB7XG4gICAgY29uc29sZS5lcnJvcignSW52YWxpZCBwb2ludCBzaXplIGRldGVjdGVkOicsIHBvaW50X3NpemUsICd1c2luZyBmYWxsYmFjazonLCAxLjUpO1xuICAgIHBvaW50UmFkaXVzID0gMS41O1xuICB9XG4gIFxuICByZXR1cm4gUGxvdC5wbG90KHtcbiAgICB0aXRsZTogYEdlb2dyYXBoaWMgRGlzdHJpYnV0aW9uIG9mICR7c2FtcGxlX3N0YXRzLnRvdGFsLnRvTG9jYWxlU3RyaW5nKCl9IFNhbXBsZSBQb2ludHNgLFxuICAgIHByb2plY3Rpb246IG1hcFByb2plY3Rpb24sXG4gICAgbWFya3M6IFtcbiAgICAgIC8vIFdvcmxkIG1hcCBvdXRsaW5lXG4gICAgICBQbG90Lmdlbyhjb3VudHJpZXMsIHtcbiAgICAgICAgZmlsbDogXCIjZjBmMGYwXCIsXG4gICAgICAgIHN0cm9rZTogXCIjY2NjXCIsXG4gICAgICAgIHN0cm9rZVdpZHRoOiAwLjVcbiAgICAgIH0pLFxuICAgICAgLy8gU2FtcGxlIHBvaW50cyBjb2xvcmVkIGJ5IHNvdXJjZVxuICAgICAgUGxvdC5kb3Qoc2FtcGxlX2RhdGEsIHtcbiAgICAgICAgeDogXCJsb25naXR1ZGVcIixcbiAgICAgICAgeTogXCJsYXRpdHVkZVwiLFxuICAgICAgICBmaWxsOiBcInNvdXJjZV9jb2xsZWN0aW9uXCIsXG4gICAgICAgIHI6IHBvaW50UmFkaXVzLFxuICAgICAgICBmaWxsT3BhY2l0eTogMC43LFxuICAgICAgICBzdHJva2U6IFwid2hpdGVcIixcbiAgICAgICAgc3Ryb2tlV2lkdGg6IDAuMlxuICAgICAgfSlcbiAgICBdLFxuICAgIGNvbG9yOiB7XG4gICAgICBsZWdlbmQ6IHRydWUsXG4gICAgICBkb21haW46IFtcIlNFU0FSXCIsIFwiT1BFTkNPTlRFWFRcIiwgXCJHRU9NRVwiLCBcIlNNSVRIU09OSUFOXCJdLFxuICAgICAgcmFuZ2U6IFtcIiMzMzY2Y2NcIiwgXCIjZGMzOTEyXCIsIFwiIzEwOTYxOFwiLCBcIiNmZjk5MDBcIl1cbiAgICB9LFxuICAgIHdpZHRoOiA5MDAsXG4gICAgaGVpZ2h0OiA1MDAsXG4gICAgc3R5bGU6IHtcbiAgICAgIGJhY2tncm91bmQ6IFwiI2Y4ZjlmYVwiXG4gICAgfVxuICB9KTtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbi8vIE1hdGVyaWFsIGRhdGE6IHVzZSBwcmUtY29tcHV0ZWQgZmFjZXQgc3VtbWFyaWVzIGZvciBpbnN0YW50IHJlc3VsdHNcbi8vIEZhbGxzIGJhY2sgdG8gZnVsbC1zY2FuIGlmIHN1bW1hcmllcyB1bmF2YWlsYWJsZVxubWF0ZXJpYWxfZGF0YSA9IHtcbiAgdHJ5IHtcbiAgICAvLyBUcnkgcHJlLWNvbXB1dGVkIHN1bW1hcmllcyBmaXJzdCAoMktCLCBpbnN0YW50KVxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRiLnF1ZXJ5KGBcbiAgICAgIFNFTEVDVFxuICAgICAgICBmYWNldF92YWx1ZSBhcyBoYXNfbWF0ZXJpYWxfY2F0ZWdvcnksXG4gICAgICAgICdBTEwnIGFzIHNvdXJjZV9jb2xsZWN0aW9uLFxuICAgICAgICBjb3VudCBhcyBjYXRlZ29yeV9jb3VudFxuICAgICAgRlJPTSByZWFkX3BhcnF1ZXQoJyR7ZmFjZXRfc3VtbWFyaWVzX3VybH0nKVxuICAgICAgV0hFUkUgZmFjZXRfdHlwZSA9ICdtYXRlcmlhbCdcbiAgICAgIE9SREVSIEJZIGNvdW50IERFU0NcbiAgICBgKTtcbiAgICByZXR1cm4gcmVzdWx0LnRvQXJyYXkoKS5tYXAocm93ID0+ICh7XG4gICAgICAuLi5yb3csXG4gICAgICBjYXRlZ29yeV9jb3VudDogTnVtYmVyKHJvdy5jYXRlZ29yeV9jb3VudClcbiAgICB9KSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLndhcm4oXCJGYWNldCBzdW1tYXJpZXMgdW5hdmFpbGFibGUsIGZhbGxpbmcgYmFjayB0byBmdWxsIHNjYW46XCIsIGUubWVzc2FnZSk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGIucXVlcnkoYFxuICAgICAgU0VMRUNUXG4gICAgICAgIHNvdXJjZV9jb2xsZWN0aW9uLFxuICAgICAgICBoYXNfbWF0ZXJpYWxfY2F0ZWdvcnksXG4gICAgICAgIGNvdW50KCopIGFzIGNhdGVnb3J5X2NvdW50XG4gICAgICBGUk9NIGlzYW1wbGVzX2RhdGFcbiAgICAgIFdIRVJFIGhhc19tYXRlcmlhbF9jYXRlZ29yeSBJUyBOT1QgTlVMTFxuICAgICAgR1JPVVAgQlkgc291cmNlX2NvbGxlY3Rpb24sIGhhc19tYXRlcmlhbF9jYXRlZ29yeVxuICAgICAgT1JERVIgQlkgc291cmNlX2NvbGxlY3Rpb24sIGNhdGVnb3J5X2NvdW50IERFU0NcbiAgICBgKTtcbiAgICByZXR1cm4gcmVzdWx0LnRvQXJyYXkoKS5tYXAocm93ID0+ICh7XG4gICAgICAuLi5yb3csXG4gICAgICBjYXRlZ29yeV9jb3VudDogTnVtYmVyKHJvdy5jYXRlZ29yeV9jb3VudClcbiAgICB9KSk7XG4gIH1cbn1cblxuLy8gVG9wIGNhdGVnb3JpZXMgZnJvbSBwcmUtY29tcHV0ZWQgc3VtbWFyaWVzIChpbnN0YW50KVxudG9wX2NhdGVnb3JpZXMgPSB7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGIucXVlcnkoYFxuICAgICAgU0VMRUNUXG4gICAgICAgIGZhY2V0X3ZhbHVlIGFzIGhhc19tYXRlcmlhbF9jYXRlZ29yeSxcbiAgICAgICAgY291bnQgYXMgdG90YWxfY291bnRcbiAgICAgIEZST00gcmVhZF9wYXJxdWV0KCcke2ZhY2V0X3N1bW1hcmllc191cmx9JylcbiAgICAgIFdIRVJFIGZhY2V0X3R5cGUgPSAnbWF0ZXJpYWwnXG4gICAgICBPUkRFUiBCWSBjb3VudCBERVNDXG4gICAgICBMSU1JVCAxMFxuICAgIGApO1xuICAgIHJldHVybiByZXN1bHQudG9BcnJheSgpLm1hcChyb3cgPT4gKHtcbiAgICAgIC4uLnJvdyxcbiAgICAgIHRvdGFsX2NvdW50OiBOdW1iZXIocm93LnRvdGFsX2NvdW50KVxuICAgIH0pKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUud2FybihcIkZhY2V0IHN1bW1hcmllcyB1bmF2YWlsYWJsZSwgZmFsbGluZyBiYWNrIHRvIGZ1bGwgc2NhbjpcIiwgZS5tZXNzYWdlKTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYi5xdWVyeShgXG4gICAgICBTRUxFQ1RcbiAgICAgICAgaGFzX21hdGVyaWFsX2NhdGVnb3J5LFxuICAgICAgICBjb3VudCgqKSBhcyB0b3RhbF9jb3VudFxuICAgICAgRlJPTSBpc2FtcGxlc19kYXRhXG4gICAgICBXSEVSRSBoYXNfbWF0ZXJpYWxfY2F0ZWdvcnkgSVMgTk9UIE5VTExcbiAgICAgIEdST1VQIEJZIGhhc19tYXRlcmlhbF9jYXRlZ29yeVxuICAgICAgT1JERVIgQlkgdG90YWxfY291bnQgREVTQ1xuICAgICAgTElNSVQgMTBcbiAgICBgKTtcbiAgICByZXR1cm4gcmVzdWx0LnRvQXJyYXkoKS5tYXAocm93ID0+ICh7XG4gICAgICAuLi5yb3csXG4gICAgICB0b3RhbF9jb3VudDogTnVtYmVyKHJvdy50b3RhbF9jb3VudClcbiAgICB9KSk7XG4gIH1cbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTgiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbi8vIENhdGVnb3J5IHNlbGVjdG9yIGZvciBkZXRhaWxlZCB2aWV3XG52aWV3b2Ygc2VsZWN0ZWRfY2F0ZWdvcnkgPSBJbnB1dHMuc2VsZWN0KFxuICBbXCJBbGxcIiwgLi4udG9wX2NhdGVnb3JpZXMubWFwKGQgPT4gZC5oYXNfbWF0ZXJpYWxfY2F0ZWdvcnkpXSxcbiAge1xuICAgIGxhYmVsOiBcIkZvY3VzIG9uIENhdGVnb3J5OlwiLFxuICAgIHZhbHVlOiBcIkFsbFwiXG4gIH1cbilcblxuLy8gRmlsdGVyIG1hdGVyaWFsIGRhdGFcbmZpbHRlcmVkX21hdGVyaWFsX2RhdGEgPSBzZWxlY3RlZF9jYXRlZ29yeSA9PT0gXCJBbGxcIlxuICA/IG1hdGVyaWFsX2RhdGFcbiAgOiBtYXRlcmlhbF9kYXRhLmZpbHRlcihkID0+IGQuaGFzX21hdGVyaWFsX2NhdGVnb3J5ID09PSBzZWxlY3RlZF9jYXRlZ29yeSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMTkiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbi8vIFRvcCBjYXRlZ29yaWVzIGNoYXJ0XG5jYXRlZ29yaWVzX2NoYXJ0ID0gUGxvdC5wbG90KHtcbiAgdGl0bGU6IFwiVG9wIDEwIE1hdGVyaWFsIENhdGVnb3JpZXNcIixcbiAgeDoge1xuICAgIGxhYmVsOiBcIk51bWJlciBvZiBzYW1wbGVzXCIsXG4gICAgdGlja0Zvcm1hdDogXCJ+c1wiXG4gIH0sXG4gIHk6IHtcbiAgICBsYWJlbDogXCJNYXRlcmlhbCBDYXRlZ29yeVwiLFxuICAgIGRvbWFpbjogdG9wX2NhdGVnb3JpZXMubWFwKGQgPT4gZC5oYXNfbWF0ZXJpYWxfY2F0ZWdvcnkpXG4gIH0sXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5iYXJYKHRvcF9jYXRlZ29yaWVzLCB7XG4gICAgICB4OiBcInRvdGFsX2NvdW50XCIsXG4gICAgICB5OiBcImhhc19tYXRlcmlhbF9jYXRlZ29yeVwiLFxuICAgICAgZmlsbDogXCJjb3JhbFwiLFxuICAgICAgc29ydDoge3k6IFwieFwiLCByZXZlcnNlOiB0cnVlfVxuICAgIH0pLFxuICAgIFBsb3QudGV4dCh0b3BfY2F0ZWdvcmllcywge1xuICAgICAgeDogXCJ0b3RhbF9jb3VudFwiLFxuICAgICAgeTogXCJoYXNfbWF0ZXJpYWxfY2F0ZWdvcnlcIixcbiAgICAgIHRleHQ6IGQgPT4gZDMuZm9ybWF0KFwifnNcIikoZC50b3RhbF9jb3VudCksXG4gICAgICBkeDogMTAsXG4gICAgICB0ZXh0QW5jaG9yOiBcInN0YXJ0XCJcbiAgICB9KVxuICBdLFxuICBtYXJnaW5MZWZ0OiAxNTAsXG4gIGhlaWdodDogMzAwLFxuICB3aWR0aDogNzAwXG59KVxuXG4vLyBNYXRlcmlhbCBieSBzb3VyY2UgY2hhcnRcbm1hdGVyaWFsX2J5X3NvdXJjZV9jaGFydCA9IHtcbiAgLy8gVmFsaWRhdGUgdGhhdCBkYXRhIGlzIGF2YWlsYWJsZVxuICBpZiAoIUFycmF5LmlzQXJyYXkobWF0ZXJpYWxfZGF0YSkgfHwgIUFycmF5LmlzQXJyYXkodG9wX2NhdGVnb3JpZXMpKSB7XG4gICAgcmV0dXJuIGh0bWxgPGRpdj5FcnJvcjogTWF0ZXJpYWwgZGF0YSBpcyBub3QgYXZhaWxhYmxlPC9kaXY+YDtcbiAgfVxuICBcbiAgLy8gSW4gT2JzZXJ2YWJsZSwgaW5wdXRzIGFyZSBhdXRvbWF0aWNhbGx5IHJlYWN0aXZlIHZhbHVlc1xuICBjb25zdCBjdXJyZW50Q2F0ZWdvcnkgPSBzZWxlY3RlZF9jYXRlZ29yeTtcbiAgXG4gIC8vIEZpbHRlciB0aGUgZGF0YSBiYXNlZCBvbiBzZWxlY3Rpb25cbiAgbGV0IGNoYXJ0RGF0YTtcbiAgaWYgKGN1cnJlbnRDYXRlZ29yeSA9PT0gXCJBbGxcIikge1xuICAgIC8vIEZvciBcIkFsbFwiLCBzaG93IHRvcCAxMCBjYXRlZ29yaWVzIGFjcm9zcyBhbGwgc291cmNlc1xuICAgIGNoYXJ0RGF0YSA9IG1hdGVyaWFsX2RhdGEuZmlsdGVyKGQgPT4gXG4gICAgICB0b3BfY2F0ZWdvcmllcy5tYXAoYyA9PiBjLmhhc19tYXRlcmlhbF9jYXRlZ29yeSkuaW5jbHVkZXMoZC5oYXNfbWF0ZXJpYWxfY2F0ZWdvcnkpXG4gICAgKTtcbiAgfSBlbHNlIHtcbiAgICAvLyBGb3Igc3BlY2lmaWMgY2F0ZWdvcnksIHNob3cgYnkgc291cmNlIGNvbGxlY3Rpb25cbiAgICBjaGFydERhdGEgPSBtYXRlcmlhbF9kYXRhLmZpbHRlcihkID0+IGQuaGFzX21hdGVyaWFsX2NhdGVnb3J5ID09PSBjdXJyZW50Q2F0ZWdvcnkpO1xuICB9XG4gIFxuICAvLyBJZiBubyBkYXRhLCByZXR1cm4gZWFybHkgd2l0aCBhIG1lc3NhZ2VcbiAgaWYgKGNoYXJ0RGF0YS5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gaHRtbGA8ZGl2Pk5vIGRhdGEgYXZhaWxhYmxlIGZvciBzZWxlY3RlZCBjYXRlZ29yeTogJHtjdXJyZW50Q2F0ZWdvcnl9PC9kaXY+YDtcbiAgfVxuICBcbiAgcmV0dXJuIFBsb3QucGxvdCh7XG4gICAgdGl0bGU6IGN1cnJlbnRDYXRlZ29yeSA9PT0gXCJBbGxcIiBcbiAgICAgID8gXCJNYXRlcmlhbCBDYXRlZ29yaWVzIGJ5IFNvdXJjZSBDb2xsZWN0aW9uXCIgXG4gICAgICA6IGAke2N1cnJlbnRDYXRlZ29yeX0gYnkgU291cmNlIENvbGxlY3Rpb25gLFxuICAgIHg6IHtcbiAgICAgIGxhYmVsOiBcIk51bWJlciBvZiBzYW1wbGVzXCIsXG4gICAgICB0aWNrRm9ybWF0OiBcIn5zXCJcbiAgICB9LFxuICAgIHk6IHtcbiAgICAgIGxhYmVsOiBjdXJyZW50Q2F0ZWdvcnkgPT09IFwiQWxsXCIgPyBcIk1hdGVyaWFsIENhdGVnb3J5XCIgOiBcIlNvdXJjZSBDb2xsZWN0aW9uXCJcbiAgICB9LFxuICAgIGNvbG9yOiB7XG4gICAgICBsZWdlbmQ6IHRydWUsXG4gICAgICBkb21haW46IFtcIlNFU0FSXCIsIFwiT1BFTkNPTlRFWFRcIiwgXCJHRU9NRVwiLCBcIlNNSVRIU09OSUFOXCJdLFxuICAgICAgcmFuZ2U6IFtcIiMzMzY2Y2NcIiwgXCIjZGMzOTEyXCIsIFwiIzEwOTYxOFwiLCBcIiNmZjk5MDBcIl1cbiAgICB9LFxuICAgIG1hcmtzOiBbXG4gICAgICBQbG90LmJhclgoY2hhcnREYXRhLCB7XG4gICAgICAgIHg6IFwiY2F0ZWdvcnlfY291bnRcIixcbiAgICAgICAgeTogY3VycmVudENhdGVnb3J5ID09PSBcIkFsbFwiID8gXCJoYXNfbWF0ZXJpYWxfY2F0ZWdvcnlcIiA6IFwic291cmNlX2NvbGxlY3Rpb25cIixcbiAgICAgICAgZmlsbDogXCJzb3VyY2VfY29sbGVjdGlvblwiLFxuICAgICAgICBzb3J0OiB7eTogXCJ4XCIsIHJldmVyc2U6IHRydWV9XG4gICAgICB9KVxuICAgIF0sXG4gICAgbWFyZ2luTGVmdDogMTUwLFxuICAgIGhlaWdodDogTWF0aC5tYXgoMjUwLCBjaGFydERhdGEubGVuZ3RoICogMjApLFxuICAgIHdpZHRoOiA3MDBcbiAgfSk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTIwIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5tZGBcbiMgUGVyZm9ybWFuY2UgQW5hbHlzaXNcblxuIyMgQnJvd3Nlci1CYXNlZCB2cyBUcmFkaXRpb25hbCBBcHByb2FjaGVzXG5cbnwgQXBwcm9hY2ggfCBUaW1lIHwgTWVtb3J5IHwgRGF0YSBUcmFuc2ZlciB8IEVudmlyb25tZW50IHxcbnwtLS0tLS0tLS0tfC0tLS0tLXwtLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLXxcbnwgKipUcmFkaXRpb25hbCAocGFuZGFzKSoqIHwgNDAtMTUwcyB8IDYwMC0xMjAwIE1CIHwgMzAwIE1CIHwgTG9jYWwgUHl0aG9uIHxcbnwgKipPdXIgYnJvd3NlciBhcHByb2FjaCoqIHwgMTAtMzBzIHwgPDEwMCBNQiB8IDw1IEtCICsgc2FtcGxlcyB8IEFueSBicm93c2VyIHxcbnwgKipJbXByb3ZlbWVudCoqIHwgKip+NXggZmFzdGVyKiogfCAqKn4xMHggbGVzcyBtZW1vcnkqKiB8ICoqfjk5JSBsZXNzIHRyYW5zZmVyKiogfCAqKlVuaXZlcnNhbCoqIHxcblxuIyMgS2V5IEJlbmVmaXRzXG5cbuKchSAqKlVuaXZlcnNhbCBBY2Nlc3MqKjogUnVucyBpbiBhbnkgbW9kZXJuIGJyb3dzZXIgIFxu4pyFICoqTWVtb3J5IEVmZmljaWVudCoqOiBBbmFseXplIDMwME1CIGRhdGFzZXRzIHVzaW5nIDwxMDBNQiBicm93c2VyIG1lbW9yeSAgXG7inIUgKipGYXN0Kio6IEluc3RhbnQgbWV0YWRhdGEgcXVlcmllcywgZWZmaWNpZW50IHNhbXBsaW5nICBcbuKchSAqKkludGVyYWN0aXZlKio6IFJlYWwtdGltZSBwYXJhbWV0ZXIgYWRqdXN0bWVudCBhbmQgdmlzdWFsaXphdGlvbiAgXG7inIUgKipTY2FsYWJsZSoqOiBTYW1lIGFwcHJvYWNoIHdvcmtzIGZvciBHQiBvciBUQiBkYXRhc2V0cyAgXG7inIUgKipSZXByb2R1Y2libGUqKjogU2VsZi1jb250YWluZWQgYW5hbHlzaXMgd2l0aCBubyBsb2NhbCBzZXR1cCByZXF1aXJlZFxuXG4jIyBUZWNobmljYWwgQWNoaWV2ZW1lbnRzXG5cbi0gKipIVFRQIFJhbmdlIFJlcXVlc3RzKio6IE9ubHkgZG93bmxvYWRzIG5lZWRlZCBkYXRhIHBvcnRpb25zXG4tICoqQ29sdW1uYXIgUHJvY2Vzc2luZyoqOiBQYXJxdWV0IGZvcm1hdCBlbmFibGVzIGVmZmljaWVudCBjb2x1bW4td2lzZSBvcGVyYXRpb25zICBcbi0gKipMYXp5IEV2YWx1YXRpb24qKjogUXVlcmllcyBhcmUgb3B0aW1pemVkIGJlZm9yZSBleGVjdXRpb25cbi0gKipJbi1Ccm93c2VyIEFuYWx5dGljcyoqOiBGdWxsIGFuYWx5dGljYWwgZGF0YWJhc2UgcnVubmluZyBpbiBKYXZhU2NyaXB0XG4tICoqSW50ZXJhY3RpdmUgVmlzdWFsaXphdGlvbioqOiBSZWFsLXRpbWUgZXhwbG9yYXRpb24gd2l0aCBPYnNlcnZhYmxlIFBsb3RcblxuVGhpcyBhcHByb2FjaCBlbmFibGVzICoqYmlnIGRhdGEgYW5hbHlzaXMgaW4gYW55IGJyb3dzZXIqKiBhbmQgbWFrZXMgbGFyZ2Utc2NhbGUgZ2Vvc3BhdGlhbCBhbmFseXNpcyB1bml2ZXJzYWxseSBhY2Nlc3NpYmxlISDwn4yNXG5gXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTIxIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiXG5tZGBcbiMjIPCfk5ogTGVhcm4gTW9yZVxuXG4tIFtEdWNrREItV0FTTSBEb2N1bWVudGF0aW9uXShodHRwczovL2R1Y2tkYi5vcmcvZG9jcy9hcGkvd2FzbS8pXG4tIFtPYnNlcnZhYmxlIFBsb3RdKGh0dHBzOi8vb2JzZXJ2YWJsZWhxLmNvbS9wbG90Lylcbi0gW09ic2VydmFibGUgSW5wdXRzXShodHRwczovL29ic2VydmFibGVocS5jb20vQG9ic2VydmFibGVocS9pbnB1dHMpXG4tIFtHZW9QYXJxdWV0IFNwZWNpZmljYXRpb25dKGh0dHBzOi8vZ2VvcGFycXVldC5vcmcvKVxuLSBbSFRUUCBSYW5nZSBSZXF1ZXN0c10oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSFRUUC9SYW5nZV9yZXF1ZXN0cylcbi0gW2lTYW1wbGVzIFByb2plY3RdKGh0dHBzOi8vd3d3LmlzYW1wbGVzLm9yZy8pXG5cbiMjIPCflKcgVGVjaG5pY2FsIEltcGxlbWVudGF0aW9uXG5cblRoaXMgbm90ZWJvb2sgZGVtb25zdHJhdGVzIGhvdyB0bzpcbjEuIENvbm5lY3QgdG8gcmVtb3RlIFBhcnF1ZXQgZmlsZXMgdXNpbmcgRHVja0RCLVdBU01cbjIuIFBlcmZvcm0gZWZmaWNpZW50IG1ldGFkYXRhLW9ubHkgcXVlcmllc1xuMy4gQ3JlYXRlIHN0cmF0aWZpZWQgc2FtcGxlcyBmb3IgdmlzdWFsaXphdGlvblxuNC4gQnVpbGQgaW50ZXJhY3RpdmUgY29udHJvbHMgYW5kIHZpc3VhbGl6YXRpb25zXG41LiBBY2hpZXZlIGhpZ2ggcGVyZm9ybWFuY2Ugd2l0aCBtaW5pbWFsIGRhdGEgdHJhbnNmZXJcblxuVGhlIGNvbXBsZXRlIHdvcmtmbG93IGVuYWJsZXMgc29waGlzdGljYXRlZCBkYXRhIGFuYWx5c2lzIGRpcmVjdGx5IGluIHRoZSBicm93c2VyIHdpdGhvdXQgYW55IGxvY2FsIHNvZnR3YXJlIGluc3RhbGxhdGlvbiBvciBsYXJnZSBmaWxlIGRvd25sb2Fkcy5cbmBcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjIiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiIvLyBJbXBvcnQgQ1NTIGZpcnN0XG57XG4gIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwibGlua1wiKTtcbiAgbGluay5yZWwgPSBcInN0eWxlc2hlZXRcIjtcbiAgbGluay5ocmVmID0gXCJodHRwczovL3VucGtnLmNvbS9tYXBsaWJyZS1nbEAzLjYuMS9kaXN0L21hcGxpYnJlLWdsLmNzc1wiO1xuICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGxpbmspO1xufVxuXG4vLyBNYXAgbGlicyBvbmx5IC0gc2tpcCBkZWNrLmdsIGZvciBub3cgZHVlIHRvIGRlcGVuZGVuY3kgaXNzdWVzXG5tYXBsaWJyZWdsID0gYXdhaXQgaW1wb3J0KFwiaHR0cHM6Ly9jZG4uc2t5cGFjay5kZXYvbWFwbGlicmUtZ2xAMz9taW5cIilcblxuLy8gRm9yIG5vdywgd2UnbGwgc2tpcCBkZWNrLmdsIGR1ZSB0byBsdW1hLmdsIGRlcGVuZGVuY3kgaXNzdWVzXG4vLyBhbmQganVzdCBzaG93IHRoZSBtYXAgd2l0aG91dCBXZWJHTCBvdmVybGF5c1xuZGVja2xpYiA9IG51bGxcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjMiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJNQVBDRkcgPSAoe1xuICBjZW50ZXI6IFsyMC4wLCA0NS4wXSwgLy8gQ2VudGVyZWQgdG8gaW5jbHVkZSBJdGFseSBhbmQgSXNyYWVsXG4gIHpvb206IDMsIC8vIFpvb21lZCBvdXQgb25lIGxldmVsXG4gIG1pblpvb206IDEsXG4gIG1heFpvb206IDE3LFxuICBiYXNlbWFwOiBcImh0dHBzOi8vYmFzZW1hcHMuY2FydG9jZG4uY29tL2dsL3Bvc2l0cm9uLWdsLXN0eWxlL3N0eWxlLmpzb25cIixcbiAgcG9pbnRDb2xvcjogWzIwLDExMCwxODAsMjAwXSxcbiAgcG9pbnRSYWRpdXNQeDogMixcbiAgbWF4UGVyVGlsZUhhcmQ6IHNhbXBsZV9saW1pdF92YWx1ZSwgLy8gRHluYW1pYyBzYW1wbGUgbGltaXQgZnJvbSBjb250cm9sc1xuICBtb2R1bHVzQnlab29tKHope1xuICAgIGlmICh6ID49IDEzKSByZXR1cm4gMTtcbiAgICBpZiAoeiA+PSAxMSkgcmV0dXJuIDI7XG4gICAgaWYgKHogPj0gOSApIHJldHVybiA4O1xuICAgIGlmICh6ID49IDcgKSByZXR1cm4gMzI7XG4gICAgaWYgKHogPj0gNSApIHJldHVybiAxMjg7XG4gICAgcmV0dXJuIDUxMjtcbiAgfSxcbiAgYWdnRGVnQnlab29tKHope1xuICAgIGlmICh6ID49IDExKSByZXR1cm4gMC4wNTtcbiAgICBpZiAoeiA+PSA5ICkgcmV0dXJuIDAuMTtcbiAgICBpZiAoeiA+PSA3ICkgcmV0dXJuIDAuMjU7XG4gICAgaWYgKHogPj0gNSApIHJldHVybiAwLjU7XG4gICAgcmV0dXJuIDEuMDtcbiAgfVxufSlcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjQiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbi8vIFRleHQgaW5wdXQgZm9yIHZpZXdwb3J0IHNhbXBsZSBsaW1pdFxudmlld29mIHNhbXBsZV9saW1pdCA9IElucHV0cy50ZXh0KHtcbiAgbGFiZWw6IFwiVmlld3BvcnQgU2FtcGxlIExpbWl0OlwiLFxuICB2YWx1ZTogXCIyMDAwMFwiLFxuICBwbGFjZWhvbGRlcjogXCJFbnRlciBudW1iZXIgKHdvcmtzIHJlbGlhYmx5IHVwIHRvIH4xTSlcIlxufSlcblxuLy8gQ29udmVydCB0byBudW1iZXIgd2l0aCB2YWxpZGF0aW9uXG5zYW1wbGVfbGltaXRfdmFsdWUgPSBNYXRoLm1heCgxLCBwYXJzZUludChzYW1wbGVfbGltaXQpIHx8IDIwMDAwKVxuXG4vLyBEaXNwbGF5IGN1cnJlbnQgc2FtcGxlIGxpbWl0XG5tZGAqKkN1cnJlbnQgdmlld3BvcnQgc2FtcGxlIGxpbWl0Kio6ICR7c2FtcGxlX2xpbWl0X3ZhbHVlLnRvTG9jYWxlU3RyaW5nKCl9IHNhbXBsZXMgcGVyIHZpZXdwb3J0XG5cbipOb3RlOiBQZXJmb3JtYW5jZSB0ZXN0ZWQgdXAgdG8gfjFNIHNhbXBsZXMuIEZvciBsYXJnZXIgZGF0YXNldHMsIG5lZWQgbW9yZSBzY2FsYWJsZSBhcHByb2FjaCAoZS5nLiwgbG9uYm9hcmQvZGVjay5nbCBvcHRpbWl6YXRpb24pKmBcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjUiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJwaWNrTW9kZSA9ICgpID0+IHtcbiAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XG4gIGNvbnN0IGdsMiA9IGMuZ2V0Q29udGV4dChcIndlYmdsMlwiLCB7YW50aWFsaWFzOmZhbHNlfSk7XG4gIGlmIChnbDIpIHJldHVybiBcImZ1bGxcIjtcbiAgY29uc3QgZ2wgPSBjLmdldENvbnRleHQoXCJ3ZWJnbFwiLCB7YW50aWFsaWFzOmZhbHNlfSk7XG4gIGlmICghZ2wpIHJldHVybiBcInJhc3RlclwiO1xuICBjb25zdCBleHQgPSBnbC5nZXRFeHRlbnNpb24oXCJXRUJHTF9kZWJ1Z19yZW5kZXJlcl9pbmZvXCIpO1xuICBjb25zdCByID0gZXh0ID8gZ2wuZ2V0UGFyYW1ldGVyKGV4dC5VTk1BU0tFRF9SRU5ERVJFUl9XRUJHTCkgOiBcIlwiO1xuICBjb25zdCBsb3cgPSAvc3dpZnRzaGFkZXJ8bGx2bXBpcGV8c29mdHdhcmUvaS50ZXN0KHIpIHx8IGdsLmdldFBhcmFtZXRlcihnbC5NQVhfVEVYVFVSRV9TSVpFKSA8IDQwOTY7XG4gIHJldHVybiBsb3cgPyBcInJhc3RlclwiIDogXCJsaXRlXCI7XG59XG5NT0RFID0gcGlja01vZGUoKVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0IiwiY2VsbE5hbWUiOiJvanMtY2VsbC0yNiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6Imh0bWxgXG48ZGl2IHN0eWxlPVwicG9zaXRpb246cmVsYXRpdmU7XCI+XG4gIDxkaXYgaWQ9XCJtYXBcIiBzdHlsZT1cImhlaWdodDogNzB2aDsgd2lkdGg6IDEwMCU7XCI+PC9kaXY+XG4gIDxkaXYgaWQ9XCJtb2RlLWJhZGdlXCIgc3R5bGU9XCJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6OHB4O2xlZnQ6OHB4O2JhY2tncm91bmQ6I2ZmZjtib3JkZXItcmFkaXVzOjZweDtwYWRkaW5nOjRweCA4cHg7Zm9udDoxMnB4IHN5c3RlbS11aTtcIj5cbiAgICBNb2RlOiA8Yj4ke01PREV9PC9iPiAke3dvcmtpbmdfcGFycXVldF91cmwgPyBcIlwiIDogXCIoZGVtbyBkYXRhKVwifVxuICA8L2Rpdj5cbjwvZGl2PmBcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMjciLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJ2aWV3cG9ydCA9IHtcbiAgY29uc3QgTWFwID0gbWFwbGlicmVnbC5kZWZhdWx0Py5NYXAgfHwgbWFwbGlicmVnbC5NYXA7XG4gIGNvbnN0IE5hdmlnYXRpb25Db250cm9sID0gbWFwbGlicmVnbC5kZWZhdWx0Py5OYXZpZ2F0aW9uQ29udHJvbCB8fCBtYXBsaWJyZWdsLk5hdmlnYXRpb25Db250cm9sO1xuICBpZiAoIU1hcCkge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJNYXBMaWJyZSBHTCBub3QgbG9hZGVkIHByb3Blcmx5OlwiLCBtYXBsaWJyZWdsKTtcbiAgICBjb25zb2xlLmVycm9yKFwiQXZhaWxhYmxlIGtleXM6XCIsIE9iamVjdC5rZXlzKG1hcGxpYnJlZ2wpKTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJNYXBMaWJyZSBHTCBNYXAgY2xhc3MgZmFpbGVkIHRvIGxvYWRcIik7XG4gIH1cbiAgXG4gIC8vIFdhaXQgZm9yIERPTSBjb250YWluZXIgdG8gYmUgYXZhaWxhYmxlXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIGZ1bmN0aW9uIHdhaXRGb3JDb250YWluZXIoKSB7XG4gICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm1hcFwiKTtcbiAgICAgIGlmIChjb250YWluZXIpIHtcbiAgICAgICAgY29uc3QgbWFwID0gbmV3IE1hcCh7XG4gICAgICAgICAgY29udGFpbmVyOiBcIm1hcFwiLFxuICAgICAgICAgIHN0eWxlOiBNQVBDRkcuYmFzZW1hcCxcbiAgICAgICAgICBjZW50ZXI6IE1BUENGRy5jZW50ZXIsXG4gICAgICAgICAgem9vbTogTUFQQ0ZHLnpvb20sXG4gICAgICAgICAgbWluWm9vbTogTUFQQ0ZHLm1pblpvb20sXG4gICAgICAgICAgbWF4Wm9vbTogTUFQQ0ZHLm1heFpvb20sXG4gICAgICAgICAgYXR0cmlidXRpb25Db250cm9sOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICBtYXAuYWRkQ29udHJvbChuZXcgTmF2aWdhdGlvbkNvbnRyb2woe3Zpc3VhbGl6ZVBpdGNoOnRydWV9KSk7XG4gICAgICAgIFxuICAgICAgICAvLyBTdG9yZSBtYXAgaW5zdGFuY2UgZ2xvYmFsbHkgZm9yIGRlY2suZ2wgYWNjZXNzXG4gICAgICAgIHdpbmRvdy5fb2JzZXJ2YWJsZU1hcCA9IG1hcDtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IG9ic2VydmFibGUgPSBHZW5lcmF0b3JzLm9ic2VydmUoKG5vdGlmeSkgPT4ge1xuICAgICAgICAgIGZ1bmN0aW9uIGVtaXQoKSB7XG4gICAgICAgICAgICBjb25zdCBjID0gbWFwLmdldENlbnRlcigpO1xuICAgICAgICAgICAgY29uc3QgeiA9IG1hcC5nZXRab29tKCk7XG4gICAgICAgICAgICBjb25zdCBiID0gbWFwLmdldEJvdW5kcygpO1xuICAgICAgICAgICAgbm90aWZ5KHtcbiAgICAgICAgICAgICAgY2VudGVyOiBbYy5sbmcsIGMubGF0XSxcbiAgICAgICAgICAgICAgem9vbTogeixcbiAgICAgICAgICAgICAgYm91bmRzOiBbYi5nZXRXZXN0KCksIGIuZ2V0U291dGgoKSwgYi5nZXRFYXN0KCksIGIuZ2V0Tm9ydGgoKV0sXG4gICAgICAgICAgICAgIG1hcDogbWFwIC8vIEluY2x1ZGUgbWFwIHJlZmVyZW5jZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IG9uTW92ZSA9ICgpID0+IHtcbiAgICAgICAgICAgIGlmIChlbWl0Ll90KSByZXR1cm47XG4gICAgICAgICAgICBlbWl0Ll90ID0gc2V0VGltZW91dCgoKSA9PiB7IGVtaXQoKTsgZW1pdC5fdCA9IG51bGw7IH0sIDEyMCk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICBtYXAub24oXCJsb2FkXCIsIGVtaXQpO1xuICAgICAgICAgIG1hcC5vbihcIm1vdmVcIiwgb25Nb3ZlKTtcbiAgICAgICAgICBtYXAub24oXCJ6b29tXCIsIG9uTW92ZSk7XG4gICAgICAgICAgaWYgKG1hcC5sb2FkZWQoKSkgZW1pdCgpO1xuICAgICAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgICAgICB3aW5kb3cuX29ic2VydmFibGVNYXAgPSBudWxsO1xuICAgICAgICAgICAgbWFwLnJlbW92ZSgpO1xuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgcmVzb2x2ZShvYnNlcnZhYmxlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFRyeSBhZ2FpbiBpbiBhIGZldyBtaWxsaXNlY29uZHNcbiAgICAgICAgc2V0VGltZW91dCh3YWl0Rm9yQ29udGFpbmVyLCA1MCk7XG4gICAgICB9XG4gICAgfVxuICAgIHdhaXRGb3JDb250YWluZXIoKTtcbiAgfSk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTI4IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiYXN5bmMgZnVuY3Rpb24gcXVlcnlWaWV3cG9ydFNhbXBsZXMoZGIsIHZwLCBtb2RlKSB7XG4gIGNvbnN0IFt4bWluLCB5bWluLCB4bWF4LCB5bWF4XSA9IHZwLmJvdW5kcztcbiAgY29uc3QgeiA9IHZwLnpvb207XG4gIGNvbnN0IGJhc2VNb2QgPSBNQVBDRkcubW9kdWx1c0J5Wm9vbSh6KTtcbiAgY29uc3QgTU9EVUxVUyA9IG1vZGUgPT09IFwibGl0ZVwiID8gTWF0aC5tYXgoMSwgYmFzZU1vZCAqIDIpIDogYmFzZU1vZDtcbiAgY29uc3QgTElNSVQgPSBtb2RlID09PSBcImxpdGVcIiA/IE1hdGguZmxvb3IoTUFQQ0ZHLm1heFBlclRpbGVIYXJkLzIpIDogTUFQQ0ZHLm1heFBlclRpbGVIYXJkO1xuICBjb25zdCBzcWwgPSBgXG4gICAgU0VMRUNUIFxuICAgICAgc2FtcGxlX2lkZW50aWZpZXIsXG4gICAgICBzYW1wbGVfbG9jYXRpb25fbG9uZ2l0dWRlIEFTIGxvbixcbiAgICAgIHNhbXBsZV9sb2NhdGlvbl9sYXRpdHVkZSAgQVMgbGF0LFxuICAgICAgc291cmNlX2NvbGxlY3Rpb25cbiAgICBGUk9NIGlzYW1wbGVzX2RhdGFcbiAgICBXSEVSRSBzYW1wbGVfbG9jYXRpb25fbG9uZ2l0dWRlIEJFVFdFRU4gJHt4bWlufSBBTkQgJHt4bWF4fVxuICAgICAgQU5EIHNhbXBsZV9sb2NhdGlvbl9sYXRpdHVkZSAgQkVUV0VFTiAke3ltaW59IEFORCAke3ltYXh9XG4gICAgICBBTkQgQUJTKGhhc2goc2FtcGxlX2lkZW50aWZpZXIpKSAlICR7TU9EVUxVU30gPSAwXG4gICAgTElNSVQgJHtMSU1JVH1cbiAgYDtcbiAgY29uc3QgcmVzID0gYXdhaXQgZGIucXVlcnkoc3FsKTtcbiAgcmV0dXJuIHJlcy50b0FycmF5KCk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTI5IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoidmlld3BvcnRfZGF0YSA9IHtcbiAgLy8gQWx3YXlzIGxvYWQgZGF0YSAobm90IGp1c3QgZm9yIG5vbi1yYXN0ZXIgbW9kZSBzaW5jZSB3ZSBuZWVkIGl0IGZvciBmYWxsYmFjayBwbG90KVxuICBpZiAoIXZpZXdwb3J0Py5ib3VuZHMgfHwgIWRiKSB7XG4gICAgY29uc29sZS5sb2coJ05vIHZpZXdwb3J0IGJvdW5kcyBvciBkYiBhdmFpbGFibGUnKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBcbiAgdHJ5IHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcXVlcnlWaWV3cG9ydFNhbXBsZXMoZGIsIHZpZXdwb3J0LCBNT0RFKTtcbiAgICBjb25zb2xlLmxvZyhgTG9hZGVkICR7ZGF0YT8ubGVuZ3RoIHx8IDB9IHZpZXdwb3J0IHNhbXBsZXMgZm9yIGJvdW5kczpgLCB2aWV3cG9ydC5ib3VuZHMpO1xuICAgIGNvbnNvbGUubG9nKCdTYW1wbGUgZGF0YTonLCBkYXRhPy5zbGljZSgwLCAzKSk7IC8vIFNob3cgZmlyc3QgMyByZWNvcmRzXG4gICAgcmV0dXJuIGRhdGE7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgcXVlcnlpbmcgdmlld3BvcnQgc2FtcGxlczonLCBlcnJvcik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMzAiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJtYXBfbGF5ZXJfdXBkYXRlID0ge1xuICAvLyBVcGRhdGUgTWFwTGlicmUgbWFwIGxheWVycyB3aXRoIHZpZXdwb3J0IGRhdGFcbiAgaWYgKCF2aWV3cG9ydD8ubWFwIHx8ICF2aWV3cG9ydF9kYXRhIHx8ICFBcnJheS5pc0FycmF5KHZpZXdwb3J0X2RhdGEpKSB7XG4gICAgY29uc29sZS5sb2coJ05vIG1hcCBvciBkYXRhIGF2YWlsYWJsZSBmb3IgbGF5ZXIgdXBkYXRlJyk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgXG4gIGNvbnN0IG1hcCA9IHZpZXdwb3J0Lm1hcDtcbiAgXG4gIC8vIENvbnZlcnQgdmlld3BvcnQgZGF0YSB0byBHZW9KU09OIGZvcm1hdCBmb3IgTWFwTGlicmVcbiAgY29uc3QgZ2VvanNvbiA9IHtcbiAgICB0eXBlOiBcIkZlYXR1cmVDb2xsZWN0aW9uXCIsXG4gICAgZmVhdHVyZXM6IHZpZXdwb3J0X2RhdGEubWFwKGQgPT4gKHtcbiAgICAgIHR5cGU6IFwiRmVhdHVyZVwiLFxuICAgICAgZ2VvbWV0cnk6IHtcbiAgICAgICAgdHlwZTogXCJQb2ludFwiLFxuICAgICAgICBjb29yZGluYXRlczogW2QubG9uLCBkLmxhdF1cbiAgICAgIH0sXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIHNhbXBsZV9pZGVudGlmaWVyOiBkLnNhbXBsZV9pZGVudGlmaWVyLFxuICAgICAgICBzb3VyY2VfY29sbGVjdGlvbjogZC5zb3VyY2VfY29sbGVjdGlvblxuICAgICAgfVxuICAgIH0pKVxuICB9O1xuICBcbiAgLy8gUmVtb3ZlIGV4aXN0aW5nIHNvdXJjZS9sYXllciBpZiB0aGV5IGV4aXN0XG4gIGlmIChtYXAuZ2V0U291cmNlKCd2aWV3cG9ydC1wb2ludHMnKSkge1xuICAgIG1hcC5yZW1vdmVMYXllcigndmlld3BvcnQtcG9pbnRzJyk7XG4gICAgbWFwLnJlbW92ZVNvdXJjZSgndmlld3BvcnQtcG9pbnRzJyk7XG4gIH1cbiAgXG4gIC8vIEFkZCBuZXcgc291cmNlIGFuZCBsYXllclxuICBtYXAuYWRkU291cmNlKCd2aWV3cG9ydC1wb2ludHMnLCB7XG4gICAgdHlwZTogJ2dlb2pzb24nLFxuICAgIGRhdGE6IGdlb2pzb25cbiAgfSk7XG4gIFxuICBtYXAuYWRkTGF5ZXIoe1xuICAgIGlkOiAndmlld3BvcnQtcG9pbnRzJyxcbiAgICB0eXBlOiAnY2lyY2xlJyxcbiAgICBzb3VyY2U6ICd2aWV3cG9ydC1wb2ludHMnLFxuICAgIHBhaW50OiB7XG4gICAgICAnY2lyY2xlLXJhZGl1cyc6IDQsXG4gICAgICAnY2lyY2xlLWNvbG9yJzogW1xuICAgICAgICAnbWF0Y2gnLFxuICAgICAgICBbJ2dldCcsICdzb3VyY2VfY29sbGVjdGlvbiddLFxuICAgICAgICAnU0VTQVInLCAnIzMzNjZjYycsXG4gICAgICAgICdPUEVOQ09OVEVYVCcsICcjZGMzOTEyJywgXG4gICAgICAgICdHRU9NRScsICcjMTA5NjE4JyxcbiAgICAgICAgJ1NNSVRIU09OSUFOJywgJyNmZjk5MDAnLFxuICAgICAgICAnIzY2NjY2NicgLy8gZmFsbGJhY2sgY29sb3JcbiAgICAgIF0sXG4gICAgICAnY2lyY2xlLW9wYWNpdHknOiAwLjgsXG4gICAgICAnY2lyY2xlLXN0cm9rZS13aWR0aCc6IDEsXG4gICAgICAnY2lyY2xlLXN0cm9rZS1jb2xvcic6ICcjZmZmZmZmJ1xuICAgIH1cbiAgfSk7XG4gIFxuICBjb25zb2xlLmxvZyhgVXBkYXRlZCBNYXBMaWJyZSBtYXAgd2l0aCAke3ZpZXdwb3J0X2RhdGEubGVuZ3RofSBwb2ludHNgKTtcbiAgcmV0dXJuIGBVcGRhdGVkIHdpdGggJHt2aWV3cG9ydF9kYXRhLmxlbmd0aH0gcG9pbnRzYDtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMzEiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJmdW5jdGlvbiBzY2F0dGVyTGF5ZXIoZGF0YSkge1xuICBjb25zdCBTY2F0dGVycGxvdExheWVyID0gZGVja2xpYi5kZWZhdWx0Py5TY2F0dGVycGxvdExheWVyIHx8IGRlY2tsaWIuU2NhdHRlcnBsb3RMYXllcjtcbiAgcmV0dXJuIG5ldyBTY2F0dGVycGxvdExheWVyKHtcbiAgICBpZDogXCJ2cC1wb2ludHNcIixcbiAgICBkYXRhLFxuICAgIGdldFBvc2l0aW9uOiBkID0+IFtkLmxvbiwgZC5sYXRdLFxuICAgIGdldEZpbGxDb2xvcjogTUFQQ0ZHLnBvaW50Q29sb3IsXG4gICAgZ2V0UmFkaXVzOiBNQVBDRkcucG9pbnRSYWRpdXNQeCxcbiAgICByYWRpdXNVbml0czogXCJwaXhlbHNcIixcbiAgICByYWRpdXNNaW5QaXhlbHM6IE1BUENGRy5wb2ludFJhZGl1c1B4LFxuICAgIHJhZGl1c01heFBpeGVsczogTUFQQ0ZHLnBvaW50UmFkaXVzUHggKiAyLFxuICAgIHBpY2thYmxlOiBmYWxzZSxcbiAgICBwYXJhbWV0ZXJzOiB7ZGVwdGhUZXN0OiBmYWxzZX1cbiAgfSk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTMyIiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoiZGVja19vdmVybGF5ID0ge1xuICBpZiAoIWRlY2tsaWIpIHtcbiAgICByZXR1cm4gaHRtbGA8ZGl2PkRlY2suZ2wgdGVtcG9yYXJpbHkgZGlzYWJsZWQgZHVlIHRvIGRlcGVuZGVuY3kgaXNzdWVzLiBNYXAgc2hvd3Mgd2l0aG91dCBXZWJHTCBvdmVybGF5LjwvZGl2PmA7XG4gIH1cbiAgXG4gIGlmIChNT0RFID09PSBcInJhc3RlclwiKSByZXR1cm4gaHRtbGA8ZGl2PlJhc3RlciBtb2RlIGFjdGl2ZTwvZGl2PmA7XG4gIFxuICB0cnkge1xuICAgIC8vIEdldCBtYXAgZnJvbSB2aWV3cG9ydCBvciBnbG9iYWwgcmVmZXJlbmNlXG4gICAgY29uc3QgbWFwID0gdmlld3BvcnQ/Lm1hcCB8fCB3aW5kb3cuX29ic2VydmFibGVNYXA7XG4gICAgaWYgKCFtYXApIHtcbiAgICAgIHJldHVybiBodG1sYDxkaXY+V2FpdGluZyBmb3IgbWFwIGluaXRpYWxpemF0aW9uLi4uPC9kaXY+YDtcbiAgICB9XG4gICAgXG4gICAgLy8gVXNlIE1hcGJveE92ZXJsYXkgZnJvbSBkZWNrLmdsIGxpYnJhcnlcbiAgICBjb25zdCBNYXBib3hPdmVybGF5ID0gZGVja2xpYi5kZWZhdWx0Py5NYXBib3hPdmVybGF5IHx8IGRlY2tsaWIuTWFwYm94T3ZlcmxheTtcbiAgICBpZiAoIU1hcGJveE92ZXJsYXkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJBdmFpbGFibGUgZGVja2xpYiBwcm9wZXJ0aWVzOlwiLCBPYmplY3Qua2V5cyhkZWNrbGliIHx8IHt9KSk7XG4gICAgICBjb25zb2xlLmVycm9yKFwiQXZhaWxhYmxlIGRlY2tsaWIuZGVmYXVsdCBwcm9wZXJ0aWVzOlwiLCBPYmplY3Qua2V5cyhkZWNrbGliLmRlZmF1bHQgfHwge30pKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIk1hcGJveE92ZXJsYXkgbm90IGZvdW5kIGluIGRlY2suZ2wgbGlicmFyeVwiKTtcbiAgICB9XG4gICAgXG4gICAgY29uc3Qgb3ZlcmxheSA9IG5ldyBNYXBib3hPdmVybGF5KHtpbnRlcmxlYXZlZDogdHJ1ZSwgbGF5ZXJzOiBbXX0pO1xuICAgIFxuICAgIC8vIEFkZCBvdmVybGF5IHRvIG1hcFxuICAgIG1hcC5hZGRDb250cm9sKG92ZXJsYXkpO1xuICAgIFxuICAgIC8vIFN0b3JlIG92ZXJsYXkgcmVmZXJlbmNlIGZvciBvdGhlciBjZWxsc1xuICAgIHdpbmRvdy5fZGVja092ZXJsYXkgPSBvdmVybGF5O1xuICAgIFxuICAgIGZ1bmN0aW9uIHJlbmRlcigpIHtcbiAgICAgIGlmIChNT0RFICE9PSBcInJhc3RlclwiICYmIEFycmF5LmlzQXJyYXkodmlld3BvcnRfZGF0YSkgJiYgdmlld3BvcnRfZGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICAgIG92ZXJsYXkuc2V0UHJvcHMoe2xheWVyczogW3NjYXR0ZXJMYXllcih2aWV3cG9ydF9kYXRhKV19KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG92ZXJsYXkuc2V0UHJvcHMoe2xheWVyczogW119KTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmVuZGVyKCk7XG4gICAgXG4gICAgcmV0dXJuIGh0bWxgPGRpdj5EZWNrLmdsIG92ZXJsYXkgaW5pdGlhbGl6ZWQgKCR7dmlld3BvcnRfZGF0YT8ubGVuZ3RoIHx8IDB9IHBvaW50cyk8L2Rpdj5gO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0RlY2sgb3ZlcmxheSBlcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIGh0bWxgPGRpdj5FcnJvciBpbml0aWFsaXppbmcgZGVjay5nbDogJHtlcnJvci5tZXNzYWdlfTwvZGl2PmA7XG4gIH1cbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMzMiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJ7XG4gIGlmIChNT0RFID09PSBcInJhc3RlclwiKSByZXR1cm47XG4gIFxuICBjb25zdCBvdmVybGF5ID0gd2luZG93Ll9kZWNrT3ZlcmxheTtcbiAgY29uc3QgYmFkZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm1vZGUtYmFkZ2VcIik7XG4gIFxuICBpZiAoIW92ZXJsYXkgfHwgIWJhZGdlKSByZXR1cm47XG4gIFxuICBsZXQgc2FtcGxlcyA9IDAsIHRvdGFsID0gMCwgZGVncmFkZWQgPSBmYWxzZTtcbiAgXG4gIGZ1bmN0aW9uIHRpY2sodCkge1xuICAgIGlmIChkZWdyYWRlZCB8fCAhb3ZlcmxheSkgcmV0dXJuO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdGF0cyA9IG92ZXJsYXkuX2RlY2s/LnN0YXRzO1xuICAgICAgY29uc3QgZnQgPSBzdGF0cyAmJiBzdGF0cy5nZXQgJiYgc3RhdHMuZ2V0KFwiRnJhbWUgVGltZVwiKT8ubGFzdFRpbWluZztcbiAgICAgIGlmIChmdCAmJiBmdCA+IDApIHsgXG4gICAgICAgIHRvdGFsICs9IGZ0OyBcbiAgICAgICAgc2FtcGxlcysrOyBcbiAgICAgIH1cbiAgICAgIFxuICAgICAgaWYgKHNhbXBsZXMgPCAxMjApIHtcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spO1xuICAgICAgfSBlbHNlIGlmIChzYW1wbGVzID4gMCkge1xuICAgICAgICBjb25zdCBhdmcgPSB0b3RhbCAvIHNhbXBsZXM7XG4gICAgICAgIGlmIChhdmcgPiA1MCkge1xuICAgICAgICAgIGRlZ3JhZGVkID0gdHJ1ZTtcbiAgICAgICAgICBvdmVybGF5LnNldFByb3BzKHtsYXllcnM6IFtdfSk7XG4gICAgICAgICAgYmFkZ2UuaW5uZXJIVE1MID0gJ01vZGU6IDxiPnJhc3RlciAoYXV0byk8L2I+JztcbiAgICAgICAgICBtdXRhYmxlIGF1dG9kb3duZ3JhZGVkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ0ZQUyBtb25pdG9yaW5nIGVycm9yOicsIGVycm9yKTtcbiAgICB9XG4gIH1cbiAgXG4gIC8vIFdhaXQgYSBiaXQgZm9yIGRlY2sgdG8gaW5pdGlhbGl6ZVxuICBzZXRUaW1lb3V0KCgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aWNrKSwgMTAwMCk7XG59XG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTM0IiwiaW5saW5lIjpmYWxzZSwic291cmNlIjoibXV0YWJsZSBhdXRvZG93bmdyYWRlZCA9IGZhbHNlXG5cbi8vIFNpbmNlIGRlY2suZ2wgaXMgZGlzYWJsZWQsIGFsd2F5cyBzaG93IGEgUGxvdCBmYWxsYmFjayBmb3Igdmlld3BvcnQgZGF0YSAgXG5wbG90X2ZhbGxiYWNrID0ge1xuICBjb25zb2xlLmxvZygnUGxvdCBmYWxsYmFjayAtIGRlY2tsaWI6JywgZGVja2xpYik7XG4gIGNvbnNvbGUubG9nKCdQbG90IGZhbGxiYWNrIC0gTU9ERTonLCBNT0RFKTtcbiAgY29uc29sZS5sb2coJ1Bsb3QgZmFsbGJhY2sgLSB2aWV3cG9ydF9kYXRhIHR5cGU6JywgdHlwZW9mIHZpZXdwb3J0X2RhdGEpO1xuICBjb25zb2xlLmxvZygnUGxvdCBmYWxsYmFjayAtIHZpZXdwb3J0X2RhdGEgbGVuZ3RoOicsIHZpZXdwb3J0X2RhdGE/Lmxlbmd0aCk7XG4gIFxuICBpZiAoIWRlY2tsaWIgfHwgTU9ERSA9PT0gXCJyYXN0ZXJcIiB8fCBhdXRvZG93bmdyYWRlZCkge1xuICAgIGlmICghdmlld3BvcnRfZGF0YSB8fCAhQXJyYXkuaXNBcnJheSh2aWV3cG9ydF9kYXRhKSB8fCB2aWV3cG9ydF9kYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIGh0bWxgPGRpdiBzdHlsZT1cInBhZGRpbmc6IDIwcHg7IGJvcmRlcjogMXB4IHNvbGlkICNjY2M7IGJhY2tncm91bmQ6ICNmOWY5Zjk7XCI+XG4gICAgICAgIDxzdHJvbmc+Vmlld3BvcnQgRGF0YSBTdGF0dXM6PC9zdHJvbmc+PGJyPlxuICAgICAgICDigKIgZGVjay5nbDogJHtkZWNrbGliID8gJ2VuYWJsZWQnIDogJ2Rpc2FibGVkJ308YnI+XG4gICAgICAgIOKAoiBNb2RlOiAke01PREV9PGJyPlxuICAgICAgICDigKIgRGF0YTogJHt2aWV3cG9ydF9kYXRhID8gYCR7dmlld3BvcnRfZGF0YS5sZW5ndGh9IHNhbXBsZXNgIDogJ251bGwvdW5kZWZpbmVkJ308YnI+XG4gICAgICAgIOKAoiBXYWl0aW5nIGZvciB2aWV3cG9ydCBkYXRhIHRvIGxvYWQuLi5cbiAgICAgIDwvZGl2PmA7XG4gICAgfVxuICAgIFxuICAgIC8vIFVzZSB0aGUgUGxvdCB0aGF0J3MgYWxyZWFkeSBpbXBvcnRlZCBhdCB0aGUgdG9wIG9mIHRoZSBub3RlYm9va1xuICAgIC8vIE5lZWQgdG8gZ2V0IHRoZSB3b3JsZCBkYXRhIGZvciB0aGUgbWFwIGJhY2tncm91bmRcbiAgICBjb25zdCB3b3JsZERhdGEgPSBhd2FpdCB3b3JsZDtcbiAgICBjb25zdCBjb3VudHJpZXMgPSB0b3BvanNvbi5mZWF0dXJlKHdvcmxkRGF0YSwgd29ybGREYXRhLm9iamVjdHMuY291bnRyaWVzKTtcbiAgICBcbiAgICByZXR1cm4gUGxvdC5wbG90KHtcbiAgICAgIHRpdGxlOiBgVmlld3BvcnQgU2FtcGxlcyAoJHt2aWV3cG9ydF9kYXRhLmxlbmd0aC50b0xvY2FsZVN0cmluZygpfSBwb2ludHMpYCxcbiAgICAgIHdpZHRoOiA5MDAsXG4gICAgICBoZWlnaHQ6IDQ4MCxcbiAgICAgIHByb2plY3Rpb246IFwibWVyY2F0b3JcIixcbiAgICAgIGluc2V0OiA2LFxuICAgICAgbWFya3M6IFtcbiAgICAgICAgLy8gV29ybGQgbWFwIG91dGxpbmVcbiAgICAgICAgUGxvdC5nZW8oY291bnRyaWVzLCB7XG4gICAgICAgICAgZmlsbDogXCIjZjBmMGYwXCIsXG4gICAgICAgICAgc3Ryb2tlOiBcIiNjY2NcIixcbiAgICAgICAgICBzdHJva2VXaWR0aDogMC41XG4gICAgICAgIH0pLFxuICAgICAgICAvLyBBZGQgYSBiaWcgcmVkIGRvdCBvbiBMb25kb24gZm9yIHRlc3RpbmdcbiAgICAgICAgUGxvdC5kb3QoW3tsb246IDAuMTI3OCwgbGF0OiA1MS41MDc0fV0sIHtcbiAgICAgICAgICB4OiBcImxvblwiLCBcbiAgICAgICAgICB5OiBcImxhdFwiLCBcbiAgICAgICAgICByOiAyMCxcbiAgICAgICAgICBmaWxsOiBcInJlZFwiLFxuICAgICAgICAgIHN0cm9rZTogXCJkYXJrcmVkXCIsXG4gICAgICAgICAgc3Ryb2tlV2lkdGg6IDNcbiAgICAgICAgfSksXG4gICAgICAgIC8vIEFkZCB0aGUgYWN0dWFsIGRhdGEgcG9pbnRzXG4gICAgICAgIFBsb3QuZG90KHZpZXdwb3J0X2RhdGEsIHtcbiAgICAgICAgICB4OiBcImxvblwiLCBcbiAgICAgICAgICB5OiBcImxhdFwiLCBcbiAgICAgICAgICBmaWxsOiBcInNvdXJjZV9jb2xsZWN0aW9uXCIsXG4gICAgICAgICAgcjogMyxcbiAgICAgICAgICBmaWxsT3BhY2l0eTogMC43LFxuICAgICAgICAgIHN0cm9rZTogXCJ3aGl0ZVwiLFxuICAgICAgICAgIHN0cm9rZVdpZHRoOiAwLjJcbiAgICAgICAgfSlcbiAgICAgIF0sXG4gICAgICBjb2xvcjoge1xuICAgICAgICBsZWdlbmQ6IHRydWUsXG4gICAgICAgIGRvbWFpbjogW1wiU0VTQVJcIiwgXCJPUEVOQ09OVEVYVFwiLCBcIkdFT01FXCIsIFwiU01JVEhTT05JQU5cIl0sXG4gICAgICAgIHJhbmdlOiBbXCIjMzM2NmNjXCIsIFwiI2RjMzkxMlwiLCBcIiMxMDk2MThcIiwgXCIjZmY5OTAwXCJdXG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgXG4gIHJldHVybiBodG1sYDxkaXY+RGVjay5nbCBlbmFibGVkIC0gbm8gZmFsbGJhY2sgbmVlZGVkPC9kaXY+YDtcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMzUiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJtZGBcbioqUmVuZGVyaW5nIG1vZGUqKjogXFxgJHtNT0RFfVxcYCAgXG4tICoqZnVsbCAvIGxpdGUqKiDihpIgZGVjay5nbCBTY2F0dGVycGxvdCBzYW1wbGVkIGZyb20gRHVja0RCLVdBU00gYnkgY3VycmVudCB2aWV3cG9ydCAgXG4tICoqcmFzdGVyKiogKG9yIGF1dG8pIOKGkiBhZ2dyZWdhdGVkIGNhbnZhcyBkb3RzIChzaXplIOKJiCBjb3VudCBwZXIgZ3JpZCBjZWxsKVxuYFxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCd0ZXN0X2lucHV0JykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ3NvdXJjZV90YWJsZScpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdzZWxlY3RlZF9yZWdpb24nKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnc2FtcGxlX3NpemUnKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgnbWF4X3Blcl9jb2xsZWN0aW9uJykifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXRRdWlldCIsInNvdXJjZSI6InNoaW55SW5wdXQoJ3Byb2plY3Rpb24nKSJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldFF1aWV0Iiwic291cmNlIjoic2hpbnlJbnB1dCgncG9pbnRfc2l6ZScpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdzZWxlY3RlZF9jYXRlZ29yeScpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdzYW1wbGVfbGltaXQnKSJ9XX0=
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../tutorials";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>¬© Copyright 2020, iSamples Project. This material is based upon work supported by the National Science Foundation under Grant Numbers <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004839">2004839</a>, <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004562">2004562</a>, <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004642">2004642</a>, and <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004815">2004815</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/isamplesorg/isamplesorg.github.io/edit/main/tutorials/zenodo_isamples_analysis.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/isamplesorg/isamplesorg.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>Any opinions, findings, and conclusions or recommendations expressed in this material are those of the author(s) and do not necessarily reflect the views of the <a href="https://nsf.gov/">National Science Foundation</a>.</p>
</div>
  </div>
</footer>




</body></html>